<!DOCTYPE html>
<html lang="es">
<head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evolutivo de Alcance por Asesor y Supervisor</title>
    <style>
        :root {
            --verde-oscuro: #1b5e20;
            --verde-claro: #c8e6c9;
            --amarillo-oscuro: #FCCF10;
            --amarillo-claro: #FEF6D2;
            --naranja-oscuro: #e65100;
            --naranja-claro: #ffe0b2;
            --rojo-oscuro: #b71c1c;
            --rojo-claro: #ffcdd2;
            --azul-oscuro: #1565c0;
            --azul-claro: #e3f2fd;
            --gris: #f5f5f5;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .selectores-periodo {
            margin: 20px 0;
            text-align: center;
        }
        
        .selectores-periodo select {
            padding: 10px 15px;
            font-size: 1.1rem;
            border: 2px solid #4a6491;
            border-radius: 8px;
            background-color: white;
            cursor: pointer;
            margin: 0 10px;
        }
        
        .fecha-actualizacion {
            font-size: 1rem;
            margin-top: 10px;
            opacity: 0.9;
        }

        .botones-supervisores {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        
        .boton-supervisor {
            padding: 10px 20px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .boton-supervisor:hover {
            background: linear-gradient(135deg, #2980b9, #1f6396);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .boton-supervisor.activo {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            box-shadow: 0 0 0 2px white, 0 0 0 4px #2ecc71;
        }
        
        .boton-supervisor.todos {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }
        
        .boton-supervisor.todos:hover {
            background: linear-gradient(135deg, #8e44ad, #7d3c98);
        }
        
        .busqueda-asesores, .busqueda-supervisores {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin: 30px 0;
        }
        
        .busqueda-asesores h2, .busqueda-supervisores h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .controles-busqueda {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .input-busqueda {
            flex: 1;
            min-width: 300px;
            padding: 12px 15px;
            font-size: 1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: white;
        }
        
        .boton-busqueda {
            padding: 12px 25px;
            font-size: 1rem;
            background: var(--azul-oscuro);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .boton-busqueda:hover {
            background: #0d47a1;
        }
        
        .asesores-seleccionados, .supervisores-seleccionados {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .tag-asesor, .tag-supervisor {
            background: var(--azul-claro);
            color: var(--azul-oscuro);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .eliminar-asesor, .eliminar-supervisor {
            background: none;
            border: none;
            color: var(--azul-oscuro);
            cursor: pointer;
            font-weight: bold;
            padding: 0;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .eliminar-asesor:hover, .eliminar-supervisor:hover {
            background: var(--azul-oscuro);
            color: white;
        }
        
        .periodo-prueba {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
        }
        
        .periodo-prueba h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .controles-periodo {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .input-periodo {
            padding: 10px 15px;
            font-size: 1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: white;
            width: 120px;
            text-align: center;
        }
        
        .resultados-periodo {
            margin-top: 20px;
            display: none;
        }
        
        .tabla-periodo {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .tabla-periodo th {
            background: var(--azul-oscuro);
            color: white;
            padding: 12px 8px;
            text-align: center;
        }
        
        .tabla-periodo td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }
        
        .resultados-comparacion {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            display: none;
        }
        
        .tabla-comparacion {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .tabla-comparacion th {
            background: var(--azul-oscuro);
            color: white;
            padding: 8px 6px;
            text-align: center;
            white-space: nowrap;
            position: sticky;
            left: 0;
            z-index: 10;
        }
        
        .tabla-comparacion th.mes-header {
            background: #2c3e50;
            position: sticky;
            top: 0;
            z-index: 20;
            min-width: 80px;
        }
        
        .tabla-comparacion td {
            padding: 6px 4px;
            border-bottom: 1px solid #eee;
            text-align: center;
            min-width: 80px;
        }
        
        .tabla-comparacion td.asesor-name, .tabla-comparacion td.supervisor-name {
            background: #f8f9fa;
            font-weight: 600;
            text-align: left;
            position: sticky;
            left: 0;
            z-index: 5;
            min-width: 150px;
            font-size: 0.8rem;
            padding: 6px 8px;
        }
        
        .tabla-comparacion tr:hover td:not(.asesor-name):not(.supervisor-name) {
            background: #f8f9fa;
        }
        
        .porcentaje-tabla {
            font-weight: bold;
            padding: 6px 8px;
            border-radius: 12px;
            color: white;
            text-align: center;
            display: inline-block;
            min-width: 50px;
            font-size: 0.85rem;
        }
        
        .sin-participacion {
            color: #999;
            font-style: italic;
        }
        
        .controles-comparacion {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .btn-comparacion {
            padding: 8px 16px;
            background: var(--azul-oscuro);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .btn-comparacion:hover {
            opacity: 0.9;
        }
        
        .btn-comparacion.activo {
            background: var(--verde-oscuro);
        }
        
        .estado-aprobado {
            color: var(--verde-oscuro);
            font-weight: bold;
        }
        
        .estado-reprobado {
            color: var(--rojo-oscuro);
            font-weight: bold;
        }
        
        .clasificaciones {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .clasificacion {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .clasificacion:hover {
            transform: translateY(-5px);
        }
        
        .clasificacion-header {
            padding: 15px;
            color: white;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .clasificacion-100 {
            background-color: var(--verde-oscuro);
        }
        
        .clasificacion-70 {
            background-color: var(--amarillo-oscuro);
        }
        
        .clasificacion-40 {
            background-color: var(--naranja-oscuro);
        }
        
        .clasificacion-0 {
            background-color: var(--rojo-oscuro);
        }
        
        .asesores-lista {
            max-height: 400px;
            overflow-y: auto;
            background-color: white;
        }
        
        .asesor-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .asesor-item:last-child {
            border-bottom: none;
        }
        
        .asesor-nombre {
            font-weight: 500;
        }
        
        .asesor-porcentaje {
            font-weight: bold;
            padding: 4px 10px;
            border-radius: 20px;
            color: white;
            font-size: 0.9rem;
        }
        
        .gradiente-100 {
            background: linear-gradient(to right, var(--verde-claro), white);
        }
        
        .gradiente-70 {
            background: linear-gradient(to right, var(--amarillo-claro), white);
        }
        
        .gradiente-40 {
            background: linear-gradient(to right, var(--naranja-claro), white);
        }
        
        .gradiente-0 {
            background: linear-gradient(to right, var(--rojo-claro), white);
        }
        
        .porcentaje-100 {
            background-color: var(--verde-oscuro);
        }
        
        .porcentaje-70 {
            background-color: var(--amarillo-oscuro);
        }
        
        .porcentaje-40 {
            background-color: var(--naranja-oscuro);
        }
        
        .porcentaje-0 {
            background-color: var(--rojo-oscuro);
        }
        
        .estadisticas {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }
        
        .estadistica-card {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .estadistica-valor {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .estadistica-100 .estadistica-valor {
            color: var(--verde-oscuro);
        }
        
        .estadistica-70 .estadistica-valor {
            color: var(--amarillo-oscuro);
        }
        
        .estadistica-40 .estadistica-valor {
            color: var(--naranja-oscuro);
        }
        
        .estadistica-0 .estadistica-valor {
            color: var(--rojo-oscuro);
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
        }

        .boton-vista-detalle {
            background: #2c3e50;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 0;
            transition: background 0.3s ease;
        }
        
        .boton-vista-detalle:hover {
            background: #34495e;
        }
        
        .vista-detalle {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
            display: none;
            border: 1px solid #ddd;
        }
        
        .vista-detalle h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .controles-vista-detalle {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #2c3e50;
        }
        
        .resumen-totales {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .resumen-totales h4 {
            margin: 0 0 10px 0;
            font-size: 1.1rem;
        }
        
        .estadisticas-detalle {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .estadistica-detalle {
            background: white;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            border-left: 4px solid #2c3e50;
        }
        
        .estadistica-detalle .valor {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 5px 0;
        }
        
        .estadistica-detalle .label {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .grafica-comparacion-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #ddd;
        }
        
        .controles-grafica {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }
        
        .controles-grafica .btn-comparacion {
            padding: 6px 12px;
            font-size: 0.8rem;
        }
        
        #graficaDesempenio, #graficaDesempenioSupervisores {
            max-width: 100%;
            height: 400px !important; /* ‚Üê FORZAR ALTURA */
            width: 100% !important; /* ‚Üê FORZAR ANCHO */
            margin: 0 auto;
            display: block; /* ‚Üê IMPORTANTE */
        }
        
        .grafica-tendencia-container {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
            overflow-x: auto;
        }
        
        .grafica-tendencia-container h4 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        #graficaTendenciaDiaria {
            width: 1200px !important;
            height: 450px !important;
            margin: 0 auto;
            display: block;
            min-width: 1200px;
        }
        
        .grafica-equipos-container {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
            overflow-x: auto;
        }
        
        .grafica-equipos-container h4 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        #graficaAlcanceEquipos {
            width: 1200px !important;
            height: 800px !important;
            margin: 0 auto;
            display: block;
            min-width: 1200px;
        }

        /* Estilos para nombres en la tabla seg√∫n posici√≥n */
        .tabla-top10 .puesto-1 td:nth-child(2) {  /* Nombre del 1er lugar */
            color: #FFD700;
            font-weight: bold;
            font-size: 1.05em;
        }
        
        .tabla-top10 .puesto-2 td:nth-child(2) {  /* Nombre del 2do lugar */
            color: #C0C0C0;
            font-weight: bold;
        }
        
        .tabla-top10 .puesto-3 td:nth-child(2) {  /* Nombre del 3er lugar */
            color: #CD7F32;
            font-weight: bold;
        }
    
        .boton-cerrar-top10 {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--rojo-oscuro);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>CONSOLIDADO DE RECUPEROS Y ALCANCES</h1>
        <div class="selectores-periodo">
            <select id="selectorMes" onchange="actualizarPeriodo()">
                <option value="ENERO" >Enero</option>
<option value="FEBRERO" >Febrero</option>
<option value="MARZO" >Marzo</option>
<option value="ABRIL" >Abril</option>
<option value="MAYO" >Mayo</option>
<option value="JUNIO" >Junio</option>
<option value="JULIO" >Julio</option>
<option value="AGOSTO" >Agosto</option>
<option value="SETIEMBRE" >Setiembre</option>
<option value="OCTUBRE" >Octubre</option>
<option value="NOVIEMBRE" >Noviembre</option>
<option value="DICIEMBRE" selected>Diciembre</option>

            </select>
            <select id="selectorA√±o" onchange="actualizarPeriodo()">
                <option value="2025" selected>2025</option>

            </select>
        </div>
        <!-- NUEVO BOT√ìN PARA VISTA DETALLE -->
        <button class="boton-vista-detalle" onclick="mostrarVistaDetalle()">
            üìä Ver Detalle por D√≠a
        </button>
        
        <button class="boton-vista-detalle" onclick="mostrarTop10()" style="background: linear-gradient(135deg, #FFD700, #FFA500);">
            üèÜ Top 10 Asesores
        </button>
        <div class="fecha-actualizacion">√öltima actualizaci√≥n: 10 de December de 2025 a las 07:25</div>
        
        <!-- NUEVA SECCI√ìN: Botones de Supervisores -->
        <div class="botones-supervisores">
            <button class="boton-supervisor todos activo" onclick="filtrarPorSupervisor('TODOS')">
                üë• TODOS LOS SUPERVISORES
            </button>
            <button class="boton-supervisor" onclick="filtrarPorSupervisor('JORGE')">JORGE</button>
<button class="boton-supervisor" onclick="filtrarPorSupervisor('KENNETH')">KENNETH</button>
<button class="boton-supervisor" onclick="filtrarPorSupervisor('LEONOR')">LEONOR</button>
<button class="boton-supervisor" onclick="filtrarPorSupervisor('MELINA')">MELINA</button>
<button class="boton-supervisor" onclick="filtrarPorSupervisor('SANDY')">SANDY</button>

        </div>
    </header>
    
    <div id="contenidoPrincipal">
        <!-- Secci√≥n de Clasificaci√≥n Visual -->
        <div class="clasificaciones">
            <div class="clasificacion">
                <div class="clasificacion-header clasificacion-100">100% ‚Äì ‚Üë</div>
                <div class="asesores-lista" id="lista-100">
                    <div class="asesor-item">No hay asesores en esta categor√≠a</div>
                </div>
            </div>
            
            <div class="clasificacion">
                <div class="clasificacion-header clasificacion-70">70% ‚Äì 100%</div>
                <div class="asesores-lista" id="lista-70">
                    <div class="asesor-item">No hay asesores en esta categor√≠a</div>
                </div>
            </div>
            
            <div class="clasificacion">
                <div class="clasificacion-header clasificacion-40">40% ‚Äì 70%</div>
                <div class="asesores-lista" id="lista-40">
                    <div class="asesor-item">No hay asesores en esta categor√≠a</div>
                </div>
            </div>
            
            <div class="clasificacion">
                <div class="clasificacion-header clasificacion-0">0% ‚Äì 40%</div>
                <div class="asesores-lista" id="lista-0">
                    
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">LISELY MERA</div>
            <div class="asesor-porcentaje porcentaje-0">
                39.4%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">JUAN LOZA</div>
            <div class="asesor-porcentaje porcentaje-0">
                38.8%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">CARMEN PUMA</div>
            <div class="asesor-porcentaje porcentaje-0">
                34.7%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">STWUAR MACURI</div>
            <div class="asesor-porcentaje porcentaje-0">
                30.6%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">SARITA GARAY</div>
            <div class="asesor-porcentaje porcentaje-0">
                26.7%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">JACQUELINE COLLAHUACHO</div>
            <div class="asesor-porcentaje porcentaje-0">
                25.7%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">NATALIA MARIN</div>
            <div class="asesor-porcentaje porcentaje-0">
                25.6%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">ANDERSON RODRIGUEZ</div>
            <div class="asesor-porcentaje porcentaje-0">
                24.3%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">MILAGROS QUIO</div>
            <div class="asesor-porcentaje porcentaje-0">
                21.9%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">ALEJANDRA QUISPE</div>
            <div class="asesor-porcentaje porcentaje-0">
                20.7%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">ALEIDITH GUEVARA</div>
            <div class="asesor-porcentaje porcentaje-0">
                20.4%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">GIANFRANCO PINEDO</div>
            <div class="asesor-porcentaje porcentaje-0">
                17.7%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">JHONATAN CHAVEZ</div>
            <div class="asesor-porcentaje porcentaje-0">
                16.3%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">LUIS VALLADARES</div>
            <div class="asesor-porcentaje porcentaje-0">
                15.5%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">VICTOR RAMIREZ</div>
            <div class="asesor-porcentaje porcentaje-0">
                11.9%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">JAIR MARTINEZ</div>
            <div class="asesor-porcentaje porcentaje-0">
                11.7%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">MARIA HUARCAYA</div>
            <div class="asesor-porcentaje porcentaje-0">
                11.6%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">DARYL FERREL</div>
            <div class="asesor-porcentaje porcentaje-0">
                10.3%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">JUAN ALANOCCA</div>
            <div class="asesor-porcentaje porcentaje-0">
                9.1%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">ERIKA VILLAR</div>
            <div class="asesor-porcentaje porcentaje-0">
                9.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">MALORY MONTEBLANCO</div>
            <div class="asesor-porcentaje porcentaje-0">
                6.3%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">HAROLD FLORES</div>
            <div class="asesor-porcentaje porcentaje-0">
                5.1%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">PIERINA TESEN</div>
            <div class="asesor-porcentaje porcentaje-0">
                4.5%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">MARIA TINTAYA</div>
            <div class="asesor-porcentaje porcentaje-0">
                4.5%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">GERALDINE ARROYO</div>
            <div class="asesor-porcentaje porcentaje-0">
                4.4%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">FRANCO HUAMANI</div>
            <div class="asesor-porcentaje porcentaje-0">
                4.4%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">URSULA CENTENO</div>
            <div class="asesor-porcentaje porcentaje-0">
                4.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">VERONICA TASAYCO</div>
            <div class="asesor-porcentaje porcentaje-0">
                3.6%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">GIANNINA AGUILAR</div>
            <div class="asesor-porcentaje porcentaje-0">
                3.5%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">VERONICA HUARCA</div>
            <div class="asesor-porcentaje porcentaje-0">
                3.2%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">LUIS CENTENO</div>
            <div class="asesor-porcentaje porcentaje-0">
                3.1%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">ALEJANDRA AVILA</div>
            <div class="asesor-porcentaje porcentaje-0">
                3.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">CARLA VALENCIA</div>
            <div class="asesor-porcentaje porcentaje-0">
                2.4%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">JEREMIAS ROJAS</div>
            <div class="asesor-porcentaje porcentaje-0">
                2.4%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">ANALUCIA PONCE</div>
            <div class="asesor-porcentaje porcentaje-0">
                1.9%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">GENESIS VICUNA</div>
            <div class="asesor-porcentaje porcentaje-0">
                1.8%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">EVELY TENORIO</div>
            <div class="asesor-porcentaje porcentaje-0">
                1.7%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">LINDA TUESTA</div>
            <div class="asesor-porcentaje porcentaje-0">
                1.1%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">JANETH PORTOCARRERO</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.6%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">JESSICA MELGAREJO</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.5%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">DANIEL ZAPATA</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.5%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">NOEMI CHUQUILIN</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.4%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">JENY LAZARO</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.3%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">LUCERO JORDAN</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">CHRISTIAN ALVARADO</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">MARGARITA PIANCHACHI</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">JIMENA MEDINA</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">DAVID SANCHEZ</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">KIARA CANEPA</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">CRISTINA TICONA</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">MAYRA AVALOS</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.0%
            </div>
        </div>
                </div>
            </div>
        </div>
        
        <!-- Panel de Estad√≠sticas -->
        <div class="estadisticas">
            <div class="estadistica-card estadistica-100">
                <div>Superaron el 100%</div>
                <div class="estadistica-valor" id="cantidad-100">0</div>
                <div>Meta superada</div>
            </div>
            
            <div class="estadistica-card estadistica-70">
                <div>Superaron el 70%</div>
                <div class="estadistica-valor" id="cantidad-70">0</div>
                <div>Alto rendimiento</div>
            </div>
            
            <div class="estadistica-card estadistica-40">
                <div>Superaron el 40%</div>
                <div class="estadistica-valor" id="cantidad-40">0</div>
                <div>Rendimiento medio</div>
            </div>
            
            <div class="estadistica-card estadistica-0">
                <div>Entre 0% a 40%</div>
                <div class="estadistica-valor" id="cantidad-0">51</div>
                <div>Por mejorar</div>
            </div>
        </div>
        
        <!-- Secci√≥n de B√∫squeda y Comparaci√≥n de ASESORES -->
        <section class="busqueda-asesores">
            <h2>üîç B√∫squeda y Comparaci√≥n de Asesores</h2>
            <div class="controles-busqueda">
                <input type="text" id="inputBusqueda" class="input-busqueda" placeholder="Escribe el nombre del asesor..." list="listaAsesores">
                <datalist id="listaAsesores">
                    <option value="ALEIDITH GUEVARA"><option value="ALEJANDRA AVILA"><option value="ALEJANDRA QUISPE"><option value="ALEJANDRO GONZALES"><option value="ANABEL SIHUE"><option value="ANALUCIA PONCE"><option value="ANDERSON RODRIGUEZ"><option value="ANDREA ALEJOS"><option value="ANGELO SUAREZ"><option value="ANTHONY TORRES"><option value="ANTHONY VICENTE"><option value="AURORA FAUSTOR"><option value="BRINA SOTO"><option value="BRYAN VELASQUEZ"><option value="CARLA VALENCIA"><option value="CARLOS CALAGUA"><option value="CARMEN PUMA"><option value="CHRISTIAN ALBUJAR"><option value="CHRISTIAN ALVARADO"><option value="CINTHYA PAUCAR"><option value="CRISTINA TICONA"><option value="DANIEL ZAPATA"><option value="DARY VICHARRA"><option value="DARYL FERREL"><option value="DAVID SANCHEZ"><option value="EDSON MAMANI"><option value="ERICK PORTILLA"><option value="ERIKA VILLAR"><option value="ESTRELLA TINTAYA"><option value="EVELY TENORIO"><option value="FRANCO HUAMANI"><option value="FRANK PACORA"><option value="FRANS TACSI"><option value="GABRIELA APONTE"><option value="GENESIS VICUNA"><option value="GERALDINE ARROYO"><option value="GERSON LAZARO"><option value="GIANFRANCO PINEDO"><option value="GIANNINA AGUILAR"><option value="GILBERTO PURIZACA"><option value="GINA HUAMANI"><option value="GIULIANA QUISPE"><option value="HARLINGTON VIDAL"><option value="HAROLD FLORES"><option value="ISABEL BEJARANO"><option value="JACQUELINE COLLAHUACHO"><option value="JAIME TUMIALAN"><option value="JAIR MARTINEZ"><option value="JANETH PORTOCARRERO"><option value="JENNY LAZARO"><option value="JENY LAZARO"><option value="JEREMIAS ROJAS"><option value="JERSON RIVERA"><option value="JESSICA MELGAREJO"><option value="JHOHAN CONTRERAS"><option value="JHONATAN CHAVEZ"><option value="JHOVANA TORRES"><option value="JIMENA MEDINA"><option value="JOANA GIL"><option value="JOSUE CHOCCE"><option value="JOSUE VILCHEZ"><option value="JUAN ALANOCCA"><option value="JUAN LOZA"><option value="KATHLEEN FLORES"><option value="KATYUSCA LEVANO"><option value="KIARA CANEPA"><option value="LINDA TUESTA"><option value="LISELY MERA"><option value="LIZETH RAMIREZ"><option value="LUCERO JORDAN"><option value="LUIS CENTENO"><option value="LUIS RUIZ"><option value="LUIS VALLADARES"><option value="LUPITA HIDALGO"><option value="LYNDA PEREZ"><option value="MALORY MONTEBLANCO"><option value="MARCELIT LOPEZ"><option value="MARCO QUISPE"><option value="MARCO SARMIENTO"><option value="MARCOS SARMIENTO"><option value="MARGARITA PIANCHACHI"><option value="MARIA GONZALES"><option value="MARIA HUARCAYA"><option value="MARIA TINTAYA"><option value="MAURICIO MARTINEZ"><option value="MAYRA AVALOS"><option value="MEDALITH NESTARES"><option value="MELISSA GUERRERO"><option value="MERLY CORONEL"><option value="MICAELA PEREZ"><option value="MICHAEL TAFUR"><option value="MILAGROS QUIO"><option value="MIRYAM YAPU"><option value="MISHEL MORALES"><option value="NARDIA URPIS"><option value="NATALIA MARIN"><option value="NOEMI CHUQUILIN"><option value="ORIANA ARANA"><option value="PAMELA ALBITES"><option value="PIERINA TESEN"><option value="RAQUEL RICO"><option value="RICHARD RODRIGUEZ"><option value="ROBERTO RODRIGUEZ"><option value="ROCIO TERRONES"><option value="ROGGER RODRIGUEZ"><option value="ROSA ROJAS"><option value="SARITA GARAY"><option value="SOLMAIRA BRAVO"><option value="STWUAR MACURI"><option value="TERRY ECHEVARRIA"><option value="URSULA CENTENO"><option value="VERONICA HUARCA"><option value="VERONICA TASAYCO"><option value="VICTOR RAMIREZ"><option value="YENNY INGA"><option value="YEYMY HUERTA">
                </datalist>
                <button class="boton-busqueda" onclick="agregarAsesor()">Agregar Asesor</button>
                <button class="boton-busqueda" onclick="compararAsesores()" style="background: var(--verde-oscuro);">Comparar Seleccionados</button>
                <button class="boton-busqueda" onclick="limpiarBusqueda()" style="background: var(--rojo-oscuro);">Limpiar</button>
            </div>
            
            <div class="asesores-seleccionados" id="asesoresSeleccionados">
                <!-- Aqu√≠ se mostrar√°n los asesores seleccionados -->
            </div>
            
            <div class="resultados-comparacion" id="resultadosComparacion">
                <h3>üìä Comparaci√≥n de Rendimiento - Asesores</h3>
                <div class="controles-comparacion">
                    <button class="btn-comparacion" onclick="cambiarVistaComparacion(3)">√öltimos 3 meses</button>
                    <button class="btn-comparacion activo" onclick="cambiarVistaComparacion(6)">√öltimos 6 meses</button>
                    <button class="btn-comparacion" onclick="cambiarVistaComparacion(10)">√öltimos 10 meses</button>
                </div>
                <div id="tablaComparacion"></div>
                <div class="grafica-comparacion-container" id="graficaComparacion" style="display: none;">
                    <h4>üìà Evoluci√≥n de Desempe√±o - Asesores</h4>
                    <div class="controles-grafica">
                        <button class="btn-comparacion" onclick="cambiarTipoGrafica('line')">L√≠neas</button>
                        <button class="btn-comparacion" onclick="cambiarTipoGrafica('bar')">Barras</button>
                    </div>
                    <canvas id="graficaDesempenio" width="800" height="400"></canvas>
                </div>
            </div>
        </section>

        <!-- NUEVA SECCI√ìN: B√∫squeda y Comparaci√≥n de SUPERVISORES -->
        <section class="busqueda-supervisores">
            <h2>üë• B√∫squeda y Comparaci√≥n de Supervisores</h2>
            <div class="controles-busqueda">
                <input type="text" id="inputBusquedaSupervisor" class="input-busqueda" placeholder="Escribe el nombre del supervisor..." list="listaSupervisores">
                <datalist id="listaSupervisores">
                    <option value="BRYAN"><option value="GUSTAVO"><option value="JOHAN"><option value="JORDAN"><option value="JORGE"><option value="KENNETH"><option value="LEONOR"><option value="LUIS"><option value="MELINA"><option value="MELITA"><option value="SANDY">
                </datalist>
                <button class="boton-busqueda" onclick="agregarSupervisor()">Agregar Supervisor</button>
                <button class="boton-busqueda" onclick="compararSupervisores()" style="background: var(--verde-oscuro);">Comparar Seleccionados</button>
                <button class="boton-busqueda" onclick="limpiarBusquedaSupervisores()" style="background: var(--rojo-oscuro);">Limpiar</button>
            </div>
            
            <div class="supervisores-seleccionados" id="supervisoresSeleccionados">
                <!-- Aqu√≠ se mostrar√°n los supervisores seleccionados -->
            </div>
            
            <div class="resultados-comparacion" id="resultadosComparacionSupervisores">
                <h3>üìä Comparaci√≥n de Rendimiento - Equipos</h3>
                <div class="controles-comparacion">
                    <button class="btn-comparacion" onclick="cambiarVistaComparacionSupervisores(3)">√öltimos 3 meses</button>
                    <button class="btn-comparacion activo" onclick="cambiarVistaComparacionSupervisores(6)">√öltimos 6 meses</button>
                    <button class="btn-comparacion" onclick="cambiarVistaComparacionSupervisores(10)">√öltimos 10 meses</button>
                </div>
                <div id="tablaComparacionSupervisores"></div>
                <div class="grafica-comparacion-container" id="graficaComparacionSupervisores" style="display: none;">
                    <h4>üìà Evoluci√≥n de Desempe√±o - Equipos</h4>
                    <div class="controles-grafica">
                        <button class="btn-comparacion" onclick="cambiarTipoGraficaSupervisores('line')">L√≠neas</button>
                        <button class="btn-comparacion" onclick="cambiarTipoGraficaSupervisores('bar')">Barras</button>
                    </div>
                    <canvas id="graficaDesempenioSupervisores" width="800" height="400"></canvas>
                </div>
            </div>
        </section>
        
        <!-- Secci√≥n de Periodo de Prueba -->
        <section class="periodo-prueba">
            <h3>üìà Evaluaci√≥n de Periodo de Prueba</h3>
            <div class="controles-periodo">
                <select id="mes1" class="input-periodo">
                    <option value="">Mes 1</option>
                    <option value="ENERO" >Enero</option>
<option value="FEBRERO" >Febrero</option>
<option value="MARZO" >Marzo</option>
<option value="ABRIL" >Abril</option>
<option value="MAYO" >Mayo</option>
<option value="JUNIO" >Junio</option>
<option value="JULIO" >Julio</option>
<option value="AGOSTO" >Agosto</option>
<option value="SETIEMBRE" >Setiembre</option>
<option value="OCTUBRE" >Octubre</option>
<option value="NOVIEMBRE" >Noviembre</option>
<option value="DICIEMBRE" selected>Diciembre</option>

                </select>
                <select id="a√±o1" class="input-periodo">
                    <option value="">A√±o 1</option>
                    <option value="2025" selected>2025</option>

                </select>
                <select id="mes2" class="input-periodo">
                    <option value="">Mes 2</option>
                    <option value="ENERO" >Enero</option>
<option value="FEBRERO" >Febrero</option>
<option value="MARZO" >Marzo</option>
<option value="ABRIL" >Abril</option>
<option value="MAYO" >Mayo</option>
<option value="JUNIO" >Junio</option>
<option value="JULIO" >Julio</option>
<option value="AGOSTO" >Agosto</option>
<option value="SETIEMBRE" >Setiembre</option>
<option value="OCTUBRE" >Octubre</option>
<option value="NOVIEMBRE" >Noviembre</option>
<option value="DICIEMBRE" selected>Diciembre</option>

                </select>
                <select id="a√±o2" class="input-periodo">
                    <option value="">A√±o 2</option>
                    <option value="2025" selected>2025</option>

                </select>
                <input type="number" id="porcentajeMinimo" class="input-periodo" placeholder="% M√≠nimo" value="70" min="0" max="100" step="0.1">
            </div>
            
            <div class="controles-busqueda" style="margin-top: 15px;">
                <input type="text" id="inputBusquedaPeriodo" class="input-busqueda" placeholder="Escribe el nombre del asesor para el periodo de prueba..." list="listaAsesores">
                <button class="boton-busqueda" onclick="agregarAsesorPeriodo()">Agregar Asesor</button>
                <button class="boton-busqueda" onclick="seleccionarTodosAsesoresPeriodo()" style="background: var(--verde-oscuro);">Seleccionar Todos</button>
                <button class="boton-busqueda" onclick="calcularPeriodoPrueba()" style="background: var(--azul-oscuro);">Calcular Periodo de Prueba</button>
                <button class="boton-busqueda" onclick="limpiarPeriodoPrueba()" style="background: var(--rojo-oscuro);">Limpiar Todo</button>
            </div>
            
            <div class="asesores-seleccionados" id="asesoresSeleccionadosPeriodo">
                <!-- Aqu√≠ se mostrar√°n los asesores seleccionados para periodo de prueba -->
            </div>
            
            <div class="resultados-periodo" id="resultadosPeriodo">
                <div id="tablaPeriodo"></div>
            </div>
        </section>
    </div>
    
    <!-- NUEVA SECCI√ìN MEJORADA PARA VISTA DETALLE (SIN TABLA) -->
    <section class="vista-detalle" id="vistaDetalle">
        <div class="resumen-totales">
            <h4>Resumen del Mes: <span id="mesActualDetalle">DICIEMBRE 2025</span></h4>
            <div class="estadisticas-detalle" id="estadisticasDetalle">
                <!-- Las estad√≠sticas se cargar√°n din√°micamente -->
            </div>
        </div>
        
        <!-- NUEVO: Gr√°fico de Alcance por Equipos -->
        <div class="grafica-equipos-container">
            <canvas id="graficaAlcanceEquipos" width="1200" height="800"></canvas>
        </div>
        
        <!-- Gr√°fico de Tendencia Diaria -->
        <div class="grafica-tendencia-container">
            <div class="controles-exportacion" style="margin-bottom: 20px;">
                <button class="boton-exportar" onclick="exportarTablaDetalleExcelAvanzado()">üìä Exportar Tabla</button>
            </div>
            <canvas id="graficaTendenciaDiaria" width="1200" height="450"></canvas>
        </div>
    </section>
    <footer>
        <p>Sistema de seguimiento de metas - Actualizaci√≥n diaria</p>
    </footer>
</div>

<script>
    // ========== INICIALIZACI√ìN DE DATOS ==========
    let datosMeses = {};
    let datosSupervisores = {};
    let chartTop10Modal = null;
    let chartInstance = null;
    let chartInstanceSupervisores = null;
    let chartAlcanceEquipos = null;
    let chartTendencia = null;
    
    // OTRAS VARIABLES
    const asesoresSeleccionados = new Set();
    const supervisoresSeleccionados = new Set();
    let mesesAMostrar = 6;
    let tipoGrafica = 'both';

    // NUEVA FUNCI√ìN: Filtrar por supervisor
    function filtrarPorSupervisor(supervisor) {
        document.querySelectorAll('.boton-supervisor').forEach(boton => {
            boton.classList.remove('activo');
        });
        
        event.target.classList.add('activo');
        
        const mesSeleccionado = document.getElementById('selectorMes').value;
        const a√±oSeleccionado = document.getElementById('selectorA√±o').value;
        const periodoCompleto = `${mesSeleccionado}_${a√±oSeleccionado}`;
        
        if (!datosMeses[periodoCompleto]) {
            alert('No hay datos disponibles para ' + periodoCompleto.replace('_', ' '));
            return;
        }
        
        let asesores = datosMeses[periodoCompleto] || [];
        
        if (supervisor !== 'TODOS') {
            asesores = asesores.filter(a => a.supervisor === supervisor);
        }
        
        actualizarLista(asesores, '>100%', 'lista-100');
        actualizarLista(asesores, '>70%', 'lista-70');
        actualizarLista(asesores, '>40%', 'lista-40');
        actualizarLista(asesores, '>0%', 'lista-0');
        
        actualizarEstadisticas(asesores);
    }
    
    function actualizarPeriodo() {
        const mesSeleccionado = document.getElementById('selectorMes').value;
        const a√±oSeleccionado = document.getElementById('selectorA√±o').value;
        const periodoCompleto = `${mesSeleccionado}_${a√±oSeleccionado}`;
        
        if (!datosMeses[periodoCompleto]) {
            alert('No hay datos disponibles para ' + periodoCompleto.replace('_', ' '));
            return;
        }
        
        const asesores = datosMeses[periodoCompleto] || [];
        
        // Actualizar botones de supervisores
        actualizarBotonesSupervisores(asesores);
        
        // Actualizar cada lista
        actualizarLista(asesores, '>100%', 'lista-100');
        actualizarLista(asesores, '>70%', 'lista-70');
        actualizarLista(asesores, '>40%', 'lista-40');
        actualizarLista(asesores, '>0%', 'lista-0');
        
        // Actualizar estad√≠sticas
        actualizarEstadisticas(asesores);
        
        // NUEVO: SIEMPRE actualizar la vista detalle si est√° visible
        const vistaDetalle = document.getElementById('vistaDetalle');
        if (vistaDetalle.style.display === 'block') {
            actualizarVistaDetalle();
        }
    }

    // NUEVA FUNCI√ìN: Actualizar botones de supervisores
    function actualizarBotonesSupervisores(asesores) {
        // Obtener supervisores √∫nicos del mes actual
        const supervisores = [...new Set(asesores.map(a => a.supervisor).filter(s => s))].sort();
        
        const contenedorBotones = document.querySelector('.botones-supervisores');
        
        // Crear HTML de botones
        let botonesHTML = `
            <button class="boton-supervisor todos activo" onclick="filtrarPorSupervisor('TODOS')">
                üë• TODOS LOS SUPERVISORES
            </button>
        `;
        
        supervisores.forEach(supervisor => {
            botonesHTML += `
                <button class="boton-supervisor" onclick="filtrarPorSupervisor('${supervisor}')">
                    ${supervisor}
                </button>
            `;
        });
        
        contenedorBotones.innerHTML = botonesHTML;
    }

    function actualizarLista(asesores, clasificacion, idLista) {
        const lista = document.getElementById(idLista);
        const asesoresFiltrados = asesores.filter(a => a.clasificacion === clasificacion);
        
        if (asesoresFiltrados.length === 0) {
            lista.innerHTML = '<div class="asesor-item">No hay asesores en esta categor√≠a</div>';
            return;
        }
        
        // Ordenar por porcentaje (mayor a menor)
        asesoresFiltrados.sort((a, b) => b.porcentaje - a.porcentaje);
        
        let html = '';
        asesoresFiltrados.forEach(asesor => {
            const claseGradiente = `gradiente-${clasificacion.replace('%', '').replace('>', '')}`;
            const clasePorcentaje = `porcentaje-${clasificacion.replace('%', '').replace('>', '')}`;
            html += `<div class="asesor-item ${claseGradiente}">
                <div class="asesor-nombre">${asesor.nombre}</div>
                <div class="asesor-porcentaje ${clasePorcentaje}">${asesor.porcentaje}%</div>
            </div>`;
        });
        
        lista.innerHTML = html;
    }
    
    function actualizarEstadisticas(asesores) {
        const contadores = {
            ">100%": asesores.filter(a => a.clasificacion === ">100%").length,
            ">70%": asesores.filter(a => a.clasificacion === ">70%").length,
            ">40%": asesores.filter(a => a.clasificacion === ">40%").length,
            ">0%": asesores.filter(a => a.clasificacion === ">0%").length
        };
        
        document.getElementById('cantidad-100').textContent = contadores[">100%"];
        document.getElementById('cantidad-70').textContent = contadores[">70%"];
        document.getElementById('cantidad-40').textContent = contadores[">40%"];
        document.getElementById('cantidad-0').textContent = contadores[">0%"];
    }
    
    // ========== FUNCIONES PARA ASESORES ==========
    function agregarAsesor() {
        const input = document.getElementById('inputBusqueda');
        const nombreAsesor = input.value.trim();
        
        if (nombreAsesor && !asesoresSeleccionados.has(nombreAsesor)) {
            asesoresSeleccionados.add(nombreAsesor);
            actualizarAsesoresSeleccionados();
            input.value = '';
        }
    }
    
    function eliminarAsesor(nombre) {
        asesoresSeleccionados.delete(nombre);
        actualizarAsesoresSeleccionados();
    }
    
    function actualizarAsesoresSeleccionados() {
        const container = document.getElementById('asesoresSeleccionados');
        container.innerHTML = '';
        
        asesoresSeleccionados.forEach(asesor => {
            const tag = document.createElement('div');
            tag.className = 'tag-asesor';
            tag.innerHTML = `
                ${asesor}
                <button class="eliminar-asesor" onclick="eliminarAsesor('${asesor}')">√ó</button>
            `;
            container.appendChild(tag);
        });
    }
    
    function cambiarVistaComparacion(cantidadMeses) {
        mesesAMostrar = cantidadMeses;
        
        // Actualizar botones activos
        document.querySelectorAll('.busqueda-asesores .btn-comparacion').forEach(btn => {
            btn.classList.remove('activo');
        });
        event.target.classList.add('activo');
        
        // Regenerar tabla si ya hay asesores seleccionados
        if (asesoresSeleccionados.size > 0) {
            compararAsesores();
        }
    }
    
    function compararAsesores() {
        if (asesoresSeleccionados.size === 0) {
            alert('Por favor selecciona al menos un asesor para comparar.');
            return;
        }
    
        const resultadosDiv = document.getElementById('resultadosComparacion');
        const tablaDiv = document.getElementById('tablaComparacion');
        const graficaDiv = document.getElementById('graficaComparacion');
    
        // Obtener meses ordenados (m√°s antiguo primero) - NUEVO ORDEN
        let mesesOrdenados = Object.keys(datosMeses).sort((a, b) => {
            const [mesA, a√±oA] = a.split('_');
            const [mesB, a√±oB] = b.split('_');
            const fechaA = new Date(a√±oA, obtenerNumeroMes(mesA));
            const fechaB = new Date(a√±oB, obtenerNumeroMes(mesB));
            return fechaA - fechaB; // ‚Üê CAMBIO: Orden ascendente (m√°s antiguo primero)
        });
    
        // Filtrar por cantidad de meses
        if (mesesAMostrar > 0 && mesesOrdenados.length > mesesAMostrar) {
            // Tomar los √∫ltimos N meses (m√°s recientes)
            mesesOrdenados = mesesOrdenados.slice(-mesesAMostrar);
        }
    
        // NO invertir el orden para la gr√°fica (ya est√° en orden ascendente)
        const mesesParaGrafica = [...mesesOrdenados];
    
        // Crear tabla de comparaci√≥n
        let html = '<table class="tabla-comparacion">';
        
        // Encabezado con meses (ya en orden cronol√≥gico)
        html += '<tr><th class="mes-header">Asesor</th>';
        mesesOrdenados.forEach(mes => {
            html += `<th class="mes-header">${mes.replace('_', ' ')}</th>`;
        });
        html += '</tr>';
    
        // Filas por cada asesor
        asesoresSeleccionados.forEach(asesor => {
            html += `<tr><td class="asesor-name">${asesor}</td>`;
        
            mesesOrdenados.forEach(mes => {
                const datosMes = datosMeses[mes];
                const asesorData = datosMes.find(a => a.nombre === asesor);
            
                if (asesorData) {
                    const clasePorcentaje = `porcentaje-tabla porcentaje-${asesorData.clasificacion.replace('%', '').replace('>', '')}`;
                    html += `<td><span class="${clasePorcentaje}">${asesorData.porcentaje}%</span></td>`;
                } else {
                    html += '<td class="sin-participacion">No particip√≥</td>';
                }
            });
        
            html += '</tr>';
        });
    
        html += '</table>';
        tablaDiv.innerHTML = html;
        
        // GENERAR LA GR√ÅFICA (ya est√° en orden ascendente)
        generarGraficaDesempenio(mesesParaGrafica, Array.from(asesoresSeleccionados));
        
        resultadosDiv.style.display = 'block';
        graficaDiv.style.display = 'block';
    }
    
    function limpiarBusqueda() {
        asesoresSeleccionados.clear();
        actualizarAsesoresSeleccionados();
        
        // DESTRUIR GR√ÅFICA AL LIMPIAR
        if (chartInstance) {
            chartInstance.destroy();
            chartInstance = null;
        }
        
        const canvas = document.getElementById('graficaDesempenio');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        document.getElementById('resultadosComparacion').style.display = 'none';
        document.getElementById('inputBusqueda').value = '';
    }
    
    // ========== NUEVAS FUNCIONES PARA SUPERVISORES ==========
    function agregarSupervisor() {
        const input = document.getElementById('inputBusquedaSupervisor');
        const nombreSupervisor = input.value.trim();
        
        if (nombreSupervisor && !supervisoresSeleccionados.has(nombreSupervisor)) {
            supervisoresSeleccionados.add(nombreSupervisor);
            actualizarSupervisoresSeleccionados();
            input.value = '';
        }
    }
    
    function eliminarSupervisor(nombre) {
        supervisoresSeleccionados.delete(nombre);
        actualizarSupervisoresSeleccionados();
    }
    
    function actualizarSupervisoresSeleccionados() {
        const container = document.getElementById('supervisoresSeleccionados');
        container.innerHTML = '';
        
        supervisoresSeleccionados.forEach(supervisor => {
            const tag = document.createElement('div');
            tag.className = 'tag-supervisor';
            tag.innerHTML = `
                ${supervisor}
                <button class="eliminar-supervisor" onclick="eliminarSupervisor('${supervisor}')">√ó</button>
            `;
            container.appendChild(tag);
        });
    }
    
    function cambiarVistaComparacionSupervisores(cantidadMeses) {
        mesesAMostrar = cantidadMeses;
        
        // Actualizar botones activos
        document.querySelectorAll('.busqueda-supervisores .btn-comparacion').forEach(btn => {
            btn.classList.remove('activo');
        });
        event.target.classList.add('activo');
        
        // Regenerar tabla si ya hay supervisores seleccionados
        if (supervisoresSeleccionados.size > 0) {
            compararSupervisores();
        }
    }
    
    function compararSupervisores() {
        if (supervisoresSeleccionados.size === 0) {
            alert('Por favor selecciona al menos un supervisor para comparar.');
            return;
        }
    
        const resultadosDiv = document.getElementById('resultadosComparacionSupervisores');
        const tablaDiv = document.getElementById('tablaComparacionSupervisores');
        const graficaDiv = document.getElementById('graficaComparacionSupervisores');
    
        // Obtener meses ordenados (m√°s antiguo primero) - NUEVO ORDEN
        let mesesOrdenados = Object.keys(datosMeses).sort((a, b) => {
            const [mesA, a√±oA] = a.split('_');
            const [mesB, a√±oB] = b.split('_');
            const fechaA = new Date(a√±oA, obtenerNumeroMes(mesA));
            const fechaB = new Date(a√±oB, obtenerNumeroMes(mesB));
            return fechaA - fechaB; // ‚Üê CAMBIO: Orden ascendente
        });
    
        // Filtrar por cantidad de meses
        if (mesesAMostrar > 0 && mesesOrdenados.length > mesesAMostrar) {
            // Tomar los √∫ltimos N meses (m√°s recientes)
            mesesOrdenados = mesesOrdenados.slice(-mesesAMostrar);
        }
    
        // NO invertir el orden para la gr√°fica
        const mesesParaGrafica = [...mesesOrdenados];
    
        // Crear tabla de comparaci√≥n para supervisores MEJORADA
        let html = '<table class="tabla-comparacion">';
        
        // Encabezado con meses
        html += '<tr><th class="mes-header">Supervisor</th>';
        mesesOrdenados.forEach(mes => {
            html += `<th class="mes-header">${mes.replace('_', ' ')}</th>`;
        });
        html += '</tr>';

        // ORDENAR SUPERVISORES DE MAYOR A MENOR POR PORCENTAJE DEL MES M√ÅS RECIENTE
        const supervisoresOrdenados = Array.from(supervisoresSeleccionados).sort((a, b) => {
            // Obtener datos del mes m√°s reciente para cada supervisor
            const mesMasReciente = mesesOrdenados[mesesOrdenados.length - 1];
            const datosA = datosSupervisores[a] && datosSupervisores[a][mesMasReciente];
            const datosB = datosSupervisores[b] && datosSupervisores[b][mesMasReciente];
            
            const porcentajeA = datosA ? datosA.porcentaje_vs_meta_super : 0;
            const porcentajeB = datosB ? datosB.porcentaje_vs_meta_super : 0;
            
            return porcentajeB - porcentajeA; // Orden descendente (mayor a menor)
        });
        
        // Filas por cada supervisor ORDENADO
        supervisoresOrdenados.forEach((supervisor, index) => {
            html += `<tr><td class="supervisor-name">${supervisor}</td>`;
            
            mesesOrdenados.forEach(mes => {
                const datosSupervisor = datosSupervisores[supervisor];
                if (datosSupervisor && datosSupervisor[mes]) {
                    const datosMes = datosSupervisor[mes];
                    const clasePorcentaje = `porcentaje-tabla porcentaje-${datosMes.clasificacion.replace('%', '').replace('>', '')}`;
                    
                    html += `<td>
                        <span class="${clasePorcentaje}">
                            ${datosMes.porcentaje_vs_meta_super.toFixed(1)}%
                        </span>
                        <br>
                        <small style="font-size: 0.7rem; color: #666;">
                            ${datosMes.cantidad_asesores} ases.
                        </small>
                        <br>
                        <small style="font-size: 0.65rem; color: #888;">
                            Meta: S/ ${datosMes.meta_super.toFixed(0)}
                        </small>
                        <br>
                        <div style="font-size: 0.8rem; color: #2c3e50; font-weight: bold; margin-top: 3px;">
                            ${datosMes.cartera}
                        </div>
                    </td>`;
                } else {
                    html += '<td class="sin-participacion">Sin datos</td>';
                }
            });
            
            html += '</tr>';
        });
    
        html += '</table>';
        tablaDiv.innerHTML = html;
        
        // GENERAR LA GR√ÅFICA PARA SUPERVISORES
        generarGraficaDesempenioSupervisores(mesesParaGrafica, Array.from(supervisoresSeleccionados));
        
        resultadosDiv.style.display = 'block';
        graficaDiv.style.display = 'block';
    }
    
    function limpiarBusquedaSupervisores() {
        supervisoresSeleccionados.clear();
        actualizarSupervisoresSeleccionados();
        
        // DESTRUIR GR√ÅFICA AL LIMPIAR
        if (chartInstanceSupervisores) {
            chartInstanceSupervisores.destroy();
            chartInstanceSupervisores = null;
        }
        
        const canvas = document.getElementById('graficaDesempenioSupervisores');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        document.getElementById('resultadosComparacionSupervisores').style.display = 'none';
        document.getElementById('inputBusquedaSupervisor').value = '';
    }
    
    // Variables para Periodo de Prueba
    const asesoresSeleccionadosPeriodo = new Set();
    
    // Funciones para Periodo de Prueba
    function agregarAsesorPeriodo() {
        const input = document.getElementById('inputBusquedaPeriodo');
        const nombreAsesor = input.value.trim();
        
        if (nombreAsesor && !asesoresSeleccionadosPeriodo.has(nombreAsesor)) {
            asesoresSeleccionadosPeriodo.add(nombreAsesor);
            actualizarAsesoresSeleccionadosPeriodo();
            input.value = '';
        }
    }
    
    function eliminarAsesorPeriodo(nombre) {
        asesoresSeleccionadosPeriodo.delete(nombre);
        actualizarAsesoresSeleccionadosPeriodo();
    }
    
    function actualizarAsesoresSeleccionadosPeriodo() {
        const container = document.getElementById('asesoresSeleccionadosPeriodo');
        container.innerHTML = '';
        
        asesoresSeleccionadosPeriodo.forEach(asesor => {
            const tag = document.createElement('div');
            tag.className = 'tag-asesor';
            tag.innerHTML = `
                ${asesor}
                <button class="eliminar-asesor" onclick="eliminarAsesorPeriodo('${asesor}')">√ó</button>
            `;
            container.appendChild(tag);
        });
    }
    
    function seleccionarTodosAsesoresPeriodo() {
        // Obtener todos los asesores √∫nicos de todos los meses
        const todosAsesores = new Set();
        Object.values(datosMeses).forEach(mesData => {
            mesData.forEach(asesor => {
                todosAsesores.add(asesor.nombre);
            });
        });
        
        asesoresSeleccionadosPeriodo.clear();
        todosAsesores.forEach(asesor => {
            asesoresSeleccionadosPeriodo.add(asesor);
        });
        actualizarAsesoresSeleccionadosPeriodo();
    }
    
    function limpiarPeriodoPrueba() {
        document.getElementById('mes1').value = '';
        document.getElementById('a√±o1').value = '';
        document.getElementById('mes2').value = '';
        document.getElementById('a√±o2').value = '';
        document.getElementById('porcentajeMinimo').value = '70';
        document.getElementById('inputBusquedaPeriodo').value = '';
        asesoresSeleccionadosPeriodo.clear();
        actualizarAsesoresSeleccionadosPeriodo();
        document.getElementById('resultadosPeriodo').style.display = 'none';
    }
    
    function calcularPeriodoPrueba() {
        const mes1 = document.getElementById('mes1').value;
        const a√±o1 = document.getElementById('a√±o1').value;
        const mes2 = document.getElementById('mes2').value;
        const a√±o2 = document.getElementById('a√±o2').value;
        const porcentajeMinimo = parseFloat(document.getElementById('porcentajeMinimo').value) || 70;
        
        if (!mes1 || !a√±o1 || !mes2 || !a√±o2) {
            alert('Por favor selecciona ambos meses y a√±os para calcular el periodo de prueba.');
            return;
        }
        
        const periodo1 = `${mes1}_${a√±o1}`;
        const periodo2 = `${mes2}_${a√±o2}`;
        
        if (!datosMeses[periodo1] || !datosMeses[periodo2]) {
            alert('No hay datos disponibles para uno de los periodos seleccionados.');
            return;
        }
        
        const resultadosDiv = document.getElementById('resultadosPeriodo');
        const tablaDiv = document.getElementById('tablaPeriodo');
        
        // Obtener asesores a evaluar (seleccionados o todos)
        const asesoresAEvaluar = asesoresSeleccionadosPeriodo.size > 0 ? 
            Array.from(asesoresSeleccionadosPeriodo) : 
            [...new Set([...datosMeses[periodo1].map(a => a.nombre), ...datosMeses[periodo2].map(a => a.nombre)])];
        
        let html = '<table class="tabla-periodo">';
        html += '<tr><th>Asesor</th><th>Periodo 1</th><th>Periodo 2</th><th>Total Recupero</th><th>Total Meta</th><th>% Periodo Prueba</th><th>Estado</th><th>Falta Recuperar</th></tr>';
        
        asesoresAEvaluar.forEach(asesor => {
            const data1 = datosMeses[periodo1].find(a => a.nombre === asesor);
            const data2 = datosMeses[periodo2].find(a => a.nombre === asesor);
            
            if (data1 && data2 && data1.recupero !== undefined && data1.meta !== undefined && 
                data2.recupero !== undefined && data2.meta !== undefined) {
                
                const totalRecupero = data1.recupero + data2.recupero;
                const totalMeta = data1.meta + data2.meta;
                const porcentajePrueba = totalMeta > 0 ? (totalRecupero / totalMeta) * 100 : 0;
                const porcentajeFormateado = porcentajePrueba.toFixed(2);
                
                const estado = porcentajePrueba >= porcentajeMinimo ? 
                    '<span class="estado-aprobado">‚úì Supera</span>' : 
                    '<span class="estado-reprobado">‚úó No supera</span>';
                
                const faltaRecuperar = porcentajePrueba < porcentajeMinimo ? 
                    (totalMeta * (porcentajeMinimo / 100) - totalRecupero).toFixed(2) : '0';
                
                html += `<tr>
                    <td>${asesor}</td>
                    <td>${data1.recupero} / ${data1.meta}</td>
                    <td>${data2.recupero} / ${data2.meta}</td>
                    <td><strong>${totalRecupero.toFixed(2)}</strong></td>
                    <td><strong>${totalMeta.toFixed(2)}</strong></td>
                    <td><strong>${porcentajeFormateado}%</strong></td>
                    <td>${estado}</td>
                    <td>${faltaRecuperar}</td>
                </tr>`;
            }
        });
        
        html += '</table>';
        tablaDiv.innerHTML = html;
        resultadosDiv.style.display = 'block';
    }
    
    // Permitir agregar asesor con Enter en el periodo de prueba
    document.getElementById('inputBusquedaPeriodo').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            agregarAsesorPeriodo();
        }
    });
    
    function obtenerNumeroMes(mes) {
        const meses = {
            'ENERO': 0, 'FEBRERO': 1, 'MARZO': 2, 'ABRIL': 3, 'MAYO': 4, 'JUNIO': 5,
            'JULIO': 6, 'AGOSTO': 7, 'SETIEMBRE': 8, 'SEPTIEMBRE': 8, 
            'OCTUBRE': 9, 'NOVIEMBRE': 10, 'DICIEMBRE': 11
        };
        return meses[mes.toUpperCase()] || 0;
    }
    
    // Permitir agregar asesor con Enter
    document.getElementById('inputBusqueda').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            agregarAsesor();
        }
    });

    // Permitir agregar supervisor con Enter
    document.getElementById('inputBusquedaSupervisor').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            agregarSupervisor();
        }
    });

    function mostrarVistaDetalle() {
        const vistaDetalle = document.getElementById('vistaDetalle');
        const contenidoPrincipal = document.getElementById('contenidoPrincipal');
        const botonesSupervisores = document.querySelector('.botones-supervisores');
        
        if (vistaDetalle.style.display === 'none' || vistaDetalle.style.display === '') {
            vistaDetalle.style.display = 'block';
            contenidoPrincipal.style.display = 'none';
            botonesSupervisores.style.display = 'none';
            actualizarVistaDetalle();
        } else {
            vistaDetalle.style.display = 'none';
            contenidoPrincipal.style.display = 'block';
            botonesSupervisores.style.display = 'flex';
        }
    }
    
    function actualizarVistaDetalle() {
        const mesSeleccionado = document.getElementById('selectorMes').value;
        const a√±oSeleccionado = document.getElementById('selectorA√±o').value;
        const periodoCompleto = `${mesSeleccionado}_${a√±oSeleccionado}`;
        
        if (!datosMeses[periodoCompleto]) {
            alert('No hay datos disponibles para este periodo.');
            return;
        }
        
        const asesores = datosMeses[periodoCompleto] || [];
        
        // Actualizar el t√≠tulo del mes actual
        document.getElementById('mesActualDetalle').textContent = `${mesSeleccionado} ${a√±oSeleccionado}`;
        
        // Calcular estad√≠sticas
        calcularEstadisticasDetalle(asesores);
        
        // Generar gr√°ficos - DESTRUIR PRIMERO SI EXISTEN
        if (chartAlcanceEquipos) {
            chartAlcanceEquipos.destroy();
            chartAlcanceEquipos = null;
        }
        
        if (chartTendencia) {
            chartTendencia.destroy();
            chartTendencia = null;
        }
        
        generarGraficaAlcanceEquipos();
        generarGraficaTendenciaDiaria();
    }

    function calcularEstadisticasDetalle(asesores) {
        const totalAsesores = asesores.length;
        
        // Obtener supervisores √∫nicos
        const supervisoresUnicos = [...new Set(asesores.map(a => a.supervisor))];
        const totalSupervisores = supervisoresUnicos.filter(s => s && s !== 'Sin Supervisor').length;
        
        // Recupero de asesores (suma individual)
        const recuperoAsesores = asesores.reduce((sum, asesor) => sum + (asesor.recupero || 0), 0);
        
        // Recupero total (suma de recupero_supervisor sin duplicados)
        let recuperoTotal = 0;
        const supervisoresProcesados = new Set();
        
        asesores.forEach(asesor => {
            const supervisor = asesor.supervisor;
            if (supervisor && supervisor !== 'Sin Supervisor' && !supervisoresProcesados.has(supervisor)) {
                recuperoTotal += asesor.recupero_supervisor || 0;
                supervisoresProcesados.add(supervisor);
            }
        });
        
        // Meta del mes (suma de metas de supervisores √∫nicos)
        let metaTotal = 0;
        const supervisoresMeta = new Set();
        
        asesores.forEach(asesor => {
            const supervisor = asesor.supervisor;
            if (supervisor && supervisor !== 'Sin Supervisor' && !supervisoresMeta.has(supervisor)) {
                metaTotal += asesor.meta_super || 0;
                supervisoresMeta.add(supervisor);
            }
        });
        
        // Si no hay metas de supervisor, usar suma de metas individuales
        if (metaTotal === 0) {
            metaTotal = asesores.reduce((sum, asesor) => sum + (asesor.meta || 0), 0);
        }
        
        // Calcular porcentajes
        const alcanceAsesores = metaTotal > 0 ? (recuperoAsesores / metaTotal) * 100 : 0;
        const alcanceTotal = metaTotal > 0 ? (recuperoTotal / metaTotal) * 100 : 0;
        
        // Formato de moneda
        const formatoMoneda = (valor) => {
            return 'S/ ' + valor.toLocaleString('es-PE', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        };
        
        // Generar HTML con estructura de tabla 2x4
        const html = `
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: #e0e0e0; border-radius: 8px; overflow: hidden;">
                
                <!-- COLUMNA 1: TOTALES -->
                <div style="background: #f8f9fa; padding: 15px; text-align: center;">
                    <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 5px;">TOTAL SUPERVISORES</div>
                    <div style="font-size: 2rem; font-weight: bold; color: #2c3e50;">${totalSupervisores}</div>
                    
                    <div style="border-top: 1px dashed #ddd; padding-top: 15px;">
                        <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 5px;">TOTAL ASESORES</div>
                        <div style="font-size: 2rem; font-weight: bold; color: #9b59b6; margin-bottom: 12px;">${totalAsesores}</div>
                    </div>
                </div>
                
                <!-- COLUMNA 2: RECUPERO -->
                <div style="background: #f8f9fa; padding: 15px; text-align: center;">
                    <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 5px;">RECUPERO TOTAL</div>
                    <div style="font-size: 2rem; font-weight: bold; color: #27ae60;">${formatoMoneda(recuperoTotal)}</div>
                    
                    <div style="border-top: 1px dashed #ddd; padding-top: 15px;">
                        <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 5px;">RECUPERO ASESORES</div>
                        <div style="font-size: 2rem; font-weight: bold; color: #2ecc71; margin-bottom: 12px;">${formatoMoneda(recuperoAsesores)}</div>
                    </div>
                </div>
                
                <!-- COLUMNA 3: META DEL MES (COMUN - OCUPA 2 FILAS) -->
                <div style="background: #fff9e6; padding: 15px; text-align: center; grid-row: span 2; display: flex; flex-direction: column; justify-content: center; border-left: 2px solid #f39c12; border-right: 2px solid #f39c12;">
                    <div style="font-size: 0.9rem; color: #d35400; margin-bottom: 10px; font-weight: bold;">META DEL MES</div>
                    <div style="font-size: 2.2rem; font-weight: bold; color: #e67e22;">${formatoMoneda(metaTotal)}</div>
                    <div style="margin-top: 20px; font-size: 0.8rem; color: #7f8c8d;">
                        Referencia com√∫n para asesores y supervisores
                    </div>
                </div>
                
                <!-- COLUMNA 4: ALCANCE -->
                <div style="background: #f8f9fa; padding: 15px; text-align: center;">
                    <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 5px;">ALCANCE TOTAL</div>
                    <div style="font-size: 2rem; font-weight: bold; color: #3498db;">${alcanceTotal.toFixed(1)}%</div>
                    
                    <div style="border-top: 1px dashed #ddd; padding-top: 15px;">
                        <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 5px;">ALCANCE ASESORES</div>
                        <div style="font-size: 2rem; font-weight: bold; color: #8e44ad; margin-bottom: 12px;">${alcanceAsesores.toFixed(1)}%</div>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('estadisticasDetalle').innerHTML = html;
    }
    
    // ========== FUNCIONES PARA GR√ÅFICAS DE ASESORES ==========

    function generarGraficaDesempenio(meses, asesores) {
        const canvas = document.getElementById('graficaDesempenio');
        const ctx = canvas.getContext('2d');
        
        // Destruir gr√°fica anterior si existe
        if (chartInstance) {
            chartInstance.destroy();
            chartInstance = null;
        }
    
        // LIMPIAR EL CANVAS COMPLETAMENTE
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    
        // Preparar datos para la gr√°fica
        const datasets = [];
        const colores = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
            '#9966FF', '#FF9F40', '#8AC926', '#1982C4'
        ];
    
        asesores.forEach((asesor, index) => {
            const datosAsesor = [];
            const borderColor = colores[index % colores.length];
            
            meses.forEach(mes => {
                const datosMes = datosMeses[mes];
                const asesorData = datosMes.find(a => a.nombre === asesor);
                datosAsesor.push(asesorData ? asesorData.porcentaje : null);
            });
    
            datasets.push({
                label: asesor,
                data: datosAsesor,
                borderColor: borderColor,
                backgroundColor: borderColor + '20',
                borderWidth: 3,
                fill: tipoGrafica !== 'bar',
                tension: 0.4,
                pointRadius: 6,
                pointHoverRadius: 8,
                type: tipoGrafica === 'bar' ? 'bar' : 'line',
                // SOLUCI√ìN PARA "NO PARTICIP√ì"
                spanGaps: true, // Conecta los huecos autom√°ticamente
                segment: {
                    borderColor: ctx => {
                        const p0Null = ctx.p0.parsed.y === null;
                        const p1Null = ctx.p1.parsed.y === null;
                        return (p0Null || p1Null) ? borderColor + '60' : borderColor;
                    },
                    borderDash: ctx => {
                        const p0Null = ctx.p0.parsed.y === null;
                        const p1Null = ctx.p1.parsed.y === null;
                        return (p0Null || p1Null) ? [3, 3] : [];
                    }
                },
                pointBackgroundColor: datosAsesor.map(valor => 
                    valor === null ? '#95a5a6' : borderColor
                )
            });
        });
    
        // Formatear labels de meses para mejor visualizaci√≥n
        const labels = meses.map(mes => {
            const [mesNombre, a√±o] = mes.split('_');
            return `${mesNombre.substring(0, 3)} ${a√±o}`;
        });
    
        // Crear la gr√°fica con configuraci√≥n de tama√±o FIJO
        chartInstance = new Chart(ctx, {
            type: tipoGrafica === 'both' ? 'line' : tipoGrafica,
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Evoluci√≥n del Porcentaje de Alcance - Asesores',
                        font: { size: 16 }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 13, weight: 'normal' },
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.parsed.y}%`;
                            }
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: { font: { size: 12 } },
                        onClick: function (e, legendItem, legend) {
                            const index = legendItem.datasetIndex;
                            const ci = legend.chart;
                            if (ci.isDatasetVisible(index)) {
                                ci.hide(index);
                            } else {
                                ci.show(index);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Porcentaje de Alcance (%)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Meses'
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    
        // FORZAR REDIMENSIONADO despu√©s de crear la gr√°fica
        setTimeout(() => {
            if (chartInstance) {
                chartInstance.resize();
            }
        }, 100);
    }
    
    function cambiarTipoGrafica(tipo) {
        tipoGrafica = tipo;
        
        // Actualizar botones activos
        document.querySelectorAll('.controles-grafica .btn-comparacion').forEach(btn => {
            btn.classList.remove('activo');
        });
        event.target.classList.add('activo');
        
        // Regenerar gr√°fica si hay datos
        if (asesoresSeleccionados.size > 0 && chartInstance) {
            const mesesOrdenados = Object.keys(datosMeses).sort((a, b) => {
                const [mesA, a√±oA] = a.split('_');
                const [mesB, a√±oB] = b.split('_');
                const fechaA = new Date(a√±oA, obtenerNumeroMes(mesA));
                const fechaB = new Date(a√±oB, obtenerNumeroMes(mesB));
                return fechaB - fechaA;
            });
            
            let mesesFiltrados = mesesOrdenados;
            if (mesesAMostrar > 0 && mesesFiltrados.length > mesesAMostrar) {
                mesesFiltrados = mesesFiltrados.slice(0, mesesAMostrar);
            }
            
            const mesesParaGrafica = [...mesesFiltrados].reverse();
            generarGraficaDesempenio(mesesParaGrafica, Array.from(asesoresSeleccionados));
        }
    }

    // ========== FUNCI√ìN PARA GENERAR GR√ÅFICA DE SUPERVISORES ==========
    function generarGraficaDesempenioSupervisores(meses, supervisores) {
        const canvas = document.getElementById('graficaDesempenioSupervisores');
        const ctx = canvas.getContext('2d');
        
        // Destruir gr√°fica anterior si existe
        if (chartInstanceSupervisores) {
            chartInstanceSupervisores.destroy();
            chartInstanceSupervisores = null;
        }
    
        // LIMPIAR EL CANVAS COMPLETAMENTE
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    
        // Preparar datos para la gr√°fica
        const datasets = [];
        const colores = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
            '#9966FF', '#FF9F40', '#8AC926', '#1982C4'
        ];
    
        supervisores.forEach((supervisor, index) => {
            const datosSupervisor = [];
            const borderColor = colores[index % colores.length];
            
            meses.forEach(mes => {
                const datosSupervisorMes = datosSupervisores[supervisor];
                if (datosSupervisorMes && datosSupervisorMes[mes]) {
                    datosSupervisor.push(datosSupervisorMes[mes].porcentaje_vs_meta_super);
                } else {
                    datosSupervisor.push(null);
                }
            });
    
            datasets.push({
                label: supervisor,
                data: datosSupervisor,
                borderColor: borderColor,
                backgroundColor: borderColor + '20',
                borderWidth: 3,
                fill: tipoGrafica !== 'bar',
                tension: 0.4,
                pointRadius: 6,
                pointHoverRadius: 8,
                type: tipoGrafica === 'bar' ? 'bar' : 'line',
                spanGaps: true,
                segment: {
                    borderColor: ctx => {
                        const p0Null = ctx.p0.parsed.y === null;
                        const p1Null = ctx.p1.parsed.y === null;
                        return (p0Null || p1Null) ? borderColor + '60' : borderColor;
                    },
                    borderDash: ctx => {
                        const p0Null = ctx.p0.parsed.y === null;
                        const p1Null = ctx.p1.parsed.y === null;
                        return (p0Null || p1Null) ? [3, 3] : [];
                    }
                },
                pointBackgroundColor: datosSupervisor.map(valor => 
                    valor === null ? '#95a5a6' : borderColor
                )
            });
        });
    
        // Agregar l√≠nea de meta (100%)
        datasets.push({
            label: 'Meta (100%)',
            data: Array(meses.length).fill(100),
            borderColor: '#2ecc71',
            backgroundColor: 'transparent',
            borderWidth: 2,
            borderDash: [5, 5],
            pointRadius: 0,
            fill: false,
            tension: 0
        });
    
        // Formatear labels de meses para mejor visualizaci√≥n
        const labels = meses.map(mes => {
            const [mesNombre, a√±o] = mes.split('_');
            return `${mesNombre.substring(0, 3)} ${a√±o}`;
        });
    
        // Crear la gr√°fica
        chartInstanceSupervisores = new Chart(ctx, {
            type: tipoGrafica === 'both' ? 'line' : tipoGrafica,
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Evoluci√≥n del Porcentaje vs Meta Supervisor - Equipos',
                        font: { size: 16 }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13,
                            weight: 'normal'
                        },
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                const datasetLabel = context.dataset.label || '';
                                const value = context.parsed.y;
                                
                                // Buscar datos adicionales para mostrar en el tooltip
                                const mesIndex = context.dataIndex;
                                const mes = context.chart.data.labels[mesIndex];
                                const supervisor = datasetLabel;
                                
                                // Convertir mes abreviado a formato completo
                                const mesesMap = {
                                    'Ene': 'ENERO', 'Feb': 'FEBRERO', 'Mar': 'MARZO', 'Abr': 'ABRIL',
                                    'May': 'MAYO', 'Jun': 'JUNIO', 'Jul': 'JULIO', 'Ago': 'AGOSTO',
                                    'Sep': 'SETIEMBRE', 'Oct': 'OCTUBRE', 'Nov': 'NOVIEMBRE', 'Dic': 'DICIEMBRE'
                                };
                                
                                const [mesStr, a√±o] = mes.split(' ');
                                const mesCompleto = `${mesesMap[mesStr]}_${a√±o}`;
                                
                                // Encontrar datos del supervisor para este mes - REDONDEADO A 2 DECIMALES
                                let tooltipText = `${datasetLabel}: ${value.toFixed(2)}%`;
                                
                                // Agregar informaci√≥n adicional si est√° disponible
                                if (datosSupervisores[supervisor] && datosSupervisores[supervisor][mesCompleto]) {
                                    const datosMes = datosSupervisores[supervisor][mesCompleto];
                                    tooltipText += `\nAsesores: ${datosMes.cantidad_asesores}`;
                                    tooltipText += `\nMeta: S/ ${datosMes.meta_super.toFixed(0)}`;
                                    tooltipText += `\nCartera: ${datosMes.cartera}`;
                                }
                                
                                return tooltipText.split('\n');
                            }
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: { font: { size: 12 } },
                        onClick: function (e, legendItem, legend) {
                            const index = legendItem.datasetIndex;
                            const ci = legend.chart;
                            if (ci.isDatasetVisible(index)) {
                                ci.hide(index);
                            } else {
                                ci.show(index);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Porcentaje vs Meta Supervisor (%)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Meses'
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    
        // FORZAR REDIMENSIONADO despu√©s de crear la gr√°fica
        setTimeout(() => {
            if (chartInstanceSupervisores) {
                chartInstanceSupervisores.resize();
            }
        }, 100);
    }
    
    // ========== FUNCI√ìN PARA CAMBIAR TIPO DE GR√ÅFICA SUPERVISORES ==========
    function cambiarTipoGraficaSupervisores(tipo) {
            tipoGrafica = tipo;
            
            // Actualizar botones activos
            document.querySelectorAll('#graficaComparacionSupervisores .controles-grafica .btn-comparacion').forEach(btn => {
                btn.classList.remove('activo');
            });
            event.target.classList.add('activo');
            
            // Regenerar gr√°fica si hay datos
            if (supervisoresSeleccionados.size > 0 && chartInstanceSupervisores) {
                const mesesOrdenados = Object.keys(datosMeses).sort((a, b) => {
                    const [mesA, a√±oA] = a.split('_');
                    const [mesB, a√±oB] = b.split('_');
                    const fechaA = new Date(a√±oA, obtenerNumeroMes(mesA));
                    const fechaB = new Date(a√±oB, obtenerNumeroMes(mesB));
                    return fechaB - fechaA;
                });
                
                let mesesFiltrados = mesesOrdenados;
                if (mesesAMostrar > 0 && mesesFiltrados.length > mesesAMostrar) {
                    mesesFiltrados = mesesFiltrados.slice(0, mesesAMostrar);
                }
                
                const mesesParaGrafica = [...mesesFiltrados].reverse();
                generarGraficaDesempenioSupervisores(mesesParaGrafica, Array.from(supervisoresSeleccionados));
            }
    }

    // ========== VARIABLES PARA GR√ÅFICA DE ALCANCE POR EQUIPOS ==========
    function generarGraficaAlcanceEquipos() {
        const mesSeleccionado = document.getElementById('selectorMes').value;
        const a√±oSeleccionado = document.getElementById('selectorA√±o').value;
        const periodoCompleto = `${mesSeleccionado}_${a√±oSeleccionado}`;
        
        if (!datosSupervisores) {
            console.log("‚ùå NO HAY DATOS de supervisores");
            return;
        }
        
        // Obtener supervisores del mes actual
        const supervisores = Object.keys(datosSupervisores).filter(supervisor => 
            datosSupervisores[supervisor] && datosSupervisores[supervisor][periodoCompleto]
        );
        
        if (supervisores.length === 0) {
            console.log("‚ùå NO HAY SUPERVISORES para este mes");
            return;
        }
        
        // OBTENER TODAS LAS FECHAS DISPONIBLES
        const todasFechas = new Set();
        
        supervisores.forEach(supervisor => {
            const datosMes = datosSupervisores[supervisor][periodoCompleto];
            const alcanceDiario = datosMes.alcance_acumulado_diario || {};
            
            // Agregar todas las fechas que tengan datos
            Object.keys(alcanceDiario).forEach(fecha => {
                if (alcanceDiario[fecha] !== undefined && alcanceDiario[fecha] !== null) {
                    todasFechas.add(fecha);
                }
            });
        });
        
        // Si no hay datos diarios
        if (todasFechas.size === 0) {
            console.log("‚ö†Ô∏è No hay datos diarios de alcance acumulado para ning√∫n supervisor");
            alert(`No se encontraron datos diarios de alcance para los supervisores en ${mesSeleccionado} ${a√±oSeleccionado}.`);
            return;
        }
        
        // Ordenar fechas cronol√≥gicamente
        const fechasOrdenadas = Array.from(todasFechas).sort((a, b) => {
            return convertirFechaDiaria(a) - convertirFechaDiaria(b);
        });
        
        // Preparar datasets para cada supervisor
        const datasets = [];
        const colores = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
            '#9966FF', '#FF9F40', '#8AC926', '#1982C4',
            '#6A0572', '#AB83A1', '#3C91E6', '#A2D729'
        ];
        
        // Solo incluir supervisores que tengan datos diarios
        supervisores.forEach((supervisor, index) => {
            const datosMes = datosSupervisores[supervisor][periodoCompleto];
            const alcanceDiario = datosMes.alcance_acumulado_diario || {};
            
            // Crear array de datos para cada fecha
            const datosAlcance = fechasOrdenadas.map(fecha => {
                return alcanceDiario[fecha] !== undefined ? alcanceDiario[fecha] : null;
            });
            
            // Verificar que haya al menos algunos datos
            const tieneDatos = datosAlcance.some(valor => valor !== null);
            
            if (tieneDatos) {
                const color = colores[index % colores.length];
                
                datasets.push({
                    label: supervisor,
                    data: datosAlcance,
                    borderColor: color,
                    backgroundColor: color + '20',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 10,
                    pointBackgroundColor: color,
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    spanGaps: true
                });
            }
        });
        
        // Si ning√∫n supervisor tiene datos
        if (datasets.length === 0) {
            alert(`Ning√∫n supervisor tiene datos diarios de alcance para ${mesSeleccionado} ${a√±oSeleccionado}.`);
            return;
        }
        
        // Agregar l√≠nea de meta (100%)
        datasets.push({
            label: 'Meta 100%',
            data: Array(fechasOrdenadas.length).fill(100),
            borderColor: '#2ecc71',
            backgroundColor: 'transparent',
            borderWidth: 2,
            borderDash: [5, 5],
            fill: false,
            tension: 0,
            pointRadius: 0,
            order: 999
        });
        
        const canvas = document.getElementById('graficaAlcanceEquipos');
        const ctx = canvas.getContext('2d');
        
        // Destruir gr√°fica anterior si existe - USAR LA VARIABLE CORRECTA
        if (chartAlcanceEquipos) {
            chartAlcanceEquipos.destroy();
            chartAlcanceEquipos = null;
        }
        
        // NUEVO: T√≠tulo din√°mico seg√∫n el mes seleccionado
        const tituloGrafica = `üìà Alcance por Equipos - ${mesSeleccionado} ${a√±oSeleccionado}`;
        
        // Crear la gr√°fica
        chartAlcanceEquipos = new Chart(ctx, {
            type: 'line',
            data: {
                labels: fechasOrdenadas.map(fecha => {
                    const partes = fecha.split('-');
                    return partes[0];
                }),
                datasets: datasets
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    title: {
                        display: true,
                        text: tituloGrafica,  // NUEVO: T√≠tulo din√°mico
                        font: { size: 24, weight: 'bold' }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: { size: 18, weight: 'bold' },
                        bodyFont: { size: 16 },
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            title: function(context) {
                                const index = context[0].dataIndex;
                                return fechasOrdenadas[index];  // Fecha completa "3-Nov"
                            },
                            
                            label: function(context) {
                                const datasetLabel = context.dataset.label || '';
                                const value = context.parsed.y;
                                
                                if (datasetLabel === 'Meta 100%') {
                                    return 'Meta: 100%';
                                }
                                
                                return `${datasetLabel}: ${value !== null ? value.toFixed(1) + '%' : 'Sin datos'}`;
                            }
                        }
                    },
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: { size: 20, weight: 'bold' },
                            usePointStyle: true,
                            boxWidth: 12,
                            padding: 20
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: false,
                            text: 'D√≠as del Mes',
                            font: { size: 12, weight: 'bold' }
                        },
                        ticks: {
                            font: { size: 20 },
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: false,
                            text: '% Alcance Acumulado',
                            font: { size: 12, weight: 'bold' }
                        },
                        ticks: {
                            stepSize: 10,
                            callback: function(value) {
                                return value + '%';
                            },
                            font: { size: 20 }
                        },
                        min: 0,
                        suggestedMax: 100
                    }
                }
            }
        });
    }
    
    // Funci√≥n auxiliar para convertir fechas como "3-Nov" a orden num√©rico
    function convertirFechaDiaria(fechaStr) {
        try {
            // Separar d√≠a y mes abreviado
            const partes = fechaStr.split('-');
            if (partes.length === 2) {
                const dia = parseInt(partes[0]);
                const mesAbrev = partes[1].toUpperCase();
                
                // Mapear meses abreviados
                const meses = {
                    'ENE': 1, 'FEB': 2, 'MAR': 3, 'ABR': 4, 'MAY': 5, 'JUN': 6,
                    'JUL': 7, 'AGO': 8, 'SEP': 9, 'OCT': 10, 'NOV': 11, 'DIC': 12
                };
                
                // Buscar coincidencia
                for (const [mesKey, mesNum] of Object.entries(meses)) {
                    if (mesAbrev.startsWith(mesKey)) {
                        return mesNum * 100 + dia;
                    }
                }
            }
            return 0;
        } catch (e) {
            console.error("Error convirtiendo fecha:", fechaStr, e);
            return 0;
        }
    }
    
    // Funci√≥n para generar el gr√°fico de tendencia diaria
    function generarGraficaTendenciaDiaria() {
        const mesSeleccionado = document.getElementById('selectorMes').value;
        const a√±oSeleccionado = document.getElementById('selectorA√±o').value;
        const periodoCompleto = `${mesSeleccionado}_${a√±oSeleccionado}`;
        
        if (!datosMeses[periodoCompleto]) {
            alert('No hay datos disponibles para este periodo.');
            return;
        }
        
        const asesores = datosMeses[periodoCompleto] || [];
        const todasFechas = new Set();
        
        // Obtener todas las fechas √∫nicas de los datos diarios
        asesores.forEach(asesor => {
            Object.keys(asesor.datos_diarios_asesor || {}).forEach(fecha => {
                todasFechas.add(fecha);
            });
        });
        
        if (todasFechas.size === 0) {
            alert('No hay datos diarios disponibles para este mes.');
            return;
        }
        
        const fechasOrdenadas = Array.from(todasFechas).sort((a, b) => {
            return convertirFechaDiaria(a) - convertirFechaDiaria(b);
        });
        
        const canvas = document.getElementById('graficaTendenciaDiaria');
        const ctx = canvas.getContext('2d');
        
        // Destruir gr√°fica anterior si existe - USAR LA VARIABLE CORRECTA
        if (chartTendencia) {
            chartTendencia.destroy();
            chartTendencia = null;
        }
        
        // Calcular datos (BARRAS)
        const datasets = [];
        
        // Calcular recupero diario total (BARRAS)
        const recuperoDiario = fechasOrdenadas.map(fecha => {
            let totalDia = 0;
            asesores.forEach(asesor => {
                totalDia += (asesor.datos_diarios_asesor || {})[fecha] || 0;
            });
            return totalDia;
        });
            
        datasets.push({
            label: 'üí∞ Recupero Diario',
            data: recuperoDiario,
            borderColor: '#2ecc71',
            backgroundColor: 'rgba(46, 204, 113, 0.3)',
            borderWidth: 2,
            fill: false,
            tension: 0.4,
            type: 'bar',
            borderRadius: 8,
            borderSkipped: false
        });
        
        // Crear la gr√°fica
        chartTendencia = new Chart(ctx, {
            type: 'bar',  // ‚Üê TIPO BAR PARA SOLO DIARIO
            data: {
                labels: fechasOrdenadas.map(fecha => {
                    // Mostrar solo el n√∫mero del d√≠a (opcional)
                    if (fecha.includes('-')) {
                        return fecha.split('-')[0];
                    }
                    return fecha;
                }),
                datasets: datasets
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    title: {
                        display: true,
                        text: `üìÖ Recupero Diario - ${mesSeleccionado} ${a√±oSeleccionado}`,
                        font: { size: 24, weight: 'bold' }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: { size: 18, weight: 'bold' },
                        bodyFont: { size: 16 },
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            title: function(context) {
                                const index = context[0].dataIndex;
                                return fechasOrdenadas[index];  // Fecha completa en tooltip
                            },
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                
                                const value = context.parsed.y;
                                label += 'S/ ' + value.toLocaleString('es-PE', { 
                                    minimumFractionDigits: 2,
                                    maximumFractionDigits: 2 
                                });
                                
                                return label;
                            }
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: { 
                            font: { 
                                size: 20, 
                                weight: 'bold' 
                            } 
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: false,
                            text: 'D√≠as del Mes',
                            font: { size: 14, weight: 'bold' }
                        },
                        ticks: {
                            font: { size: 20 },
                            maxRotation: 0,  // Horizontal
                            minRotation: 0
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: false,
                            text: 'Recupero Diario (S/)',
                            font: { size: 14, weight: 'bold' }
                        },
                        ticks: {
                            callback: function(value) {
                                return 'S/ ' + value.toLocaleString('es-PE');
                            },
                            font: { size: 20 }
                        }
                    }
                }
            }
        });
    }

    // ========== FUNCI√ìN MODIFICADA PARA EXPORTAR SIN TABLA ==========
    async function exportarTablaDetalleExcelAvanzado() {
        const mesSeleccionado = document.getElementById('selectorMes').value;
        const a√±oSeleccionado = document.getElementById('selectorA√±o').value;
        const periodoCompleto = `${mesSeleccionado}_${a√±oSeleccionado}`;
        
        if (!datosMeses[periodoCompleto]) {
            alert('No hay datos para exportar');
            return;
        }
    
        const fechaHoy = new Date();
        const a√±o = fechaHoy.getFullYear();
        const mes = String(fechaHoy.getMonth() + 1).padStart(2, '0');
        const dia = String(fechaHoy.getDate()).padStart(2, '0');
        const fechaFormato = `${a√±o}${mes}${dia}`;
        
        // NUEVO: Incluir el mes filtrado en el nombre del archivo
        const nombreArchivo = `Recupero y alcance por asesor declarado_${mesSeleccionado}_${fechaFormato}.xlsx`;
        
        // Obtener datos del periodo
        const asesores = datosMeses[periodoCompleto] || [];
        
        // Obtener todas las fechas √∫nicas de los datos diarios
        const todasFechas = new Set();
        asesores.forEach(asesor => {
            Object.keys(asesor.datos_diarios_asesor || {}).forEach(fecha => {
                todasFechas.add(fecha);
            });
        });
        
        // Ordenar fechas
        let fechasOrdenadas = Array.from(todasFechas).sort((a, b) => {
            return convertirFechaDiaria(a) - convertirFechaDiaria(b);
        });
        
        // Crear workbook con ExcelJS
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('Detalle Diario');
        
        // ========== CONSTRUIR LOS DATOS ==========
        const datosDetalle = [];
        const encabezados = ['EQUIPO', 'ASESOR'];
        
        // Agregar columnas de fechas
        fechasOrdenadas.forEach(fecha => {
            encabezados.push(fecha);
        });
        
        // Cambiar nombre de encabezado por "TOTAL R"
        encabezados.push('TOTAL R', '% ALCANCE');
        
        // Datos de asesores
        asesores.forEach(asesor => {
            const filaDatos = [];
            
            // Equipo y Asesor
            filaDatos.push(asesor.supervisor || 'Sin Supervisor');
            filaDatos.push(asesor.nombre);
            
            // Datos diarios
            fechasOrdenadas.forEach(fecha => {
                const valor = asesor.datos_diarios_asesor ? (asesor.datos_diarios_asesor[fecha] || 0) : 0;
                filaDatos.push(valor);
            });
            
            // Recupero total y % Alcance
            filaDatos.push(asesor.recupero || 0);
            filaDatos.push(asesor.porcentaje || 0);
            
            datosDetalle.push(filaDatos);
        });
        
        // ========== APLICAR FORMATOS PROFESIONALES ==========
        
        // 1. ENCABEZADOS
        const headerRow = worksheet.addRow(encabezados);
        headerRow.font = {
            name: 'Aptos Narrow',
            size: 12,
            bold: true,
            color: { argb: 'FFFFFFFF' }
        };
        headerRow.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FF2C3E50' }
        };
        headerRow.alignment = { horizontal: 'center', vertical: 'middle' };
        headerRow.border = {
            top: { style: 'thin', color: { argb: 'FFFFFFFF' } },
            bottom: { style: 'thin', color: { argb: 'FFFFFFFF' } },
            left: { style: 'thin', color: { argb: 'FFFFFFFF' } },
            right: { style: 'thin', color: { argb: 'FFFFFFFF' } }
        };
        
        // 2. DATOS DE ASESORES
        datosDetalle.forEach((fila, rowIndex) => {
            const dataRow = worksheet.addRow(fila);
            
            // Aplicar formatos por columna
            dataRow.eachCell((cell, colNumber) => {
                cell.font = { 
                    name: 'Aptos Narrow',
                    size: 10 
                };
                cell.border = {
                    top: { style: 'thin', color: { argb: 'FFD0D0D0' } },
                    bottom: { style: 'thin', color: { argb: 'FFD0D0D0' } },
                    left: { style: 'thin', color: { argb: 'FFD0D0D0' } },
                    right: { style: 'thin', color: { argb: 'FFD0D0D0' } }
                };
                
                // Formato para EQUIPO (columna 1)
                if (colNumber === 1) {
                    cell.font = { 
                        name: 'Aptos Narrow', 
                        size: 10, 
                        bold: true 
                    };
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFE8F4FD' }
                    };
                    cell.alignment = { horizontal: 'left' };
                }
                // Formato para ASESOR (columna 2)
                else if (colNumber === 2) {
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFFFFF' }
                    };
                    cell.alignment = { horizontal: 'left' };
                }
                // Formato para D√çAS (columnas 3 a n-2) 
                else if (colNumber > 2 && colNumber <= encabezados.length - 2) {
                    cell.alignment = { horizontal: 'right' };
                    cell.numFmt = '#,##0.00';
                    cell.font = { 
                        name: 'Aptos Narrow', 
                        size: 10,
                        color: { argb: 'FF000000' }
                    };
                    
                    // Nuevos colores condicionales para valores diarios
                    const valor = cell.value;
                    if (valor > 7000) {
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FF99E7BA' }  // >7000
                        };
                    } else if (valor > 1000) {
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFD5F5E3' }  // >1000
                        };
                    } else if (valor > 0) {
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFFFFFFF' }  // >0
                        };
                    } else {
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFFDEDEC' }  // =0
                        };
                    }
                }
                // Formato para TOTAL R (pen√∫ltima columna)
                else if (colNumber === encabezados.length - 1) {
                    cell.font = { 
                        name: 'Aptos Narrow', 
                        size: 11,
                        bold: true 
                    };
                    cell.alignment = { horizontal: 'right' };
                    cell.numFmt = '#,##0.00';
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFE8F4FD' }
                    };
                    cell.border.left = { style: 'medium', color: { argb: 'FF3498DB' } };
                }
                // Formato para % ALCANCE (√∫ltima columna)
                else if (colNumber === encabezados.length) {
                    const fontConfig = {
                        name: 'Aptos Narrow',
                        size: 12,
                        bold: true,
                        color: { argb: 'FF000000' }
                    };
                    
                    cell.font = fontConfig;
                    cell.alignment = { horizontal: 'center' };
                    cell.numFmt = '0.0"%";';
                    cell.border.right = { style: 'medium', color: { argb: 'FFF39C12' } };
                    
                    // Nuevos colores seg√∫n porcentaje (SOLO EL FONDO)
                    const valor = cell.value;
                    if (valor >= 100) {
                        cell.fill = { 
                            type: 'pattern', 
                            pattern: 'solid', 
                            fgColor: { argb: 'FF99E7BA' }
                        };
                    } else if (valor >= 70) {
                        cell.fill = { 
                            type: 'pattern', 
                            pattern: 'solid', 
                            fgColor: { argb: 'FFFCF3CF' } 
                        };
                    } else if (valor >= 40) {
                        cell.fill = { 
                            type: 'pattern', 
                            pattern: 'solid', 
                            fgColor: { argb: 'FFFAE5D3' } 
                        };
                    } else {
                        cell.fill = { 
                            type: 'pattern', 
                            pattern: 'solid', 
                            fgColor: { argb: 'FFFADBD8' } 
                        };
                    }
                }
            });
        });
        
        // 3. TOTALES CON SUMAS POR D√çA
        worksheet.addRow([]);
        const totalesFila = ['TOTALES', ''];
        
        // Calcular totales por d√≠a
        for (let col = 2; col < encabezados.length - 2; col++) {
            let totalDia = 0;
            datosDetalle.forEach(fila => {
                totalDia += fila[col] || 0;
            });
            totalesFila.push(totalDia);
        }
        
        // Calcular total recupero
        let totalRecupero = 0;
        datosDetalle.forEach(fila => {
            totalRecupero += fila[fila.length - 2] || 0;
        });
        
        totalesFila.push(totalRecupero);
        
        const totalRow = worksheet.addRow(totalesFila);
        totalRow.eachCell((cell, colNumber) => {
            cell.font = { 
                name: 'Aptos Narrow', 
                size: 11,
                bold: true, 
                color: { argb: 'FF000000' }
            };
            cell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FFD6DBDF' }
            };
            cell.border = {
                top: { style: 'thin', color: { argb: 'FF2C3E50' } },
                bottom: { style: 'thin', color: { argb: 'FF2C3E50' } }
            };
            
            if (colNumber > 2 && colNumber <= encabezados.length - 2) {
                cell.numFmt = '#,##0.00';
            } else if (colNumber === encabezados.length - 1) {
                cell.numFmt = '#,##0.00';
            } else if (colNumber === encabezados.length) {
                cell.numFmt = '0.0"%";';
            }
        });
        
        // ========== AJUSTAR ANCHOS DE COLUMNA ==========
        worksheet.columns = [
            { width: 12 }, // Equipo
            { width: 30 }, // Asesor
            ...Array(fechasOrdenadas.length).fill({ width: 12 }), // D√≠as
            { width: 23 }, // TOTAL R
            { width: 15 }  // % Alcance
        ];
        
        // Congelar paneles
        worksheet.views = [
            { state: 'frozen', xSplit: 2, ySplit: 1, activeCell: 'C2' }
        ];
        
        // ========== GUARDAR ARCHIVO ==========
        try {
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            saveAs(blob, nombreArchivo);
            
            console.log('Excel con formato exportado exitosamente');
            alert('‚úÖ Archivo Excel exportado exitosamente: ' + nombreArchivo);
        } catch (error) {
            console.error('Error al exportar:', error);
            alert('‚ùå Error al exportar el archivo. Verifica la consola para m√°s detalles.');
        }
    }

    // ========== FUNCI√ìN PARA MOSTRAR TOP 10 ==========
    function mostrarTop10() {
        const mesSeleccionado = document.getElementById('selectorMes').value;
        const a√±oSeleccionado = document.getElementById('selectorA√±o').value;
        const periodoCompleto = `${mesSeleccionado}_${a√±oSeleccionado}`;
        
        // Mostrar el modal directamente
        mostrarModalTop10(periodoCompleto);
    }
    
    function mostrarModalTop10(periodoCompleto) {
        // Verificar si ya existe el modal
        let modal = document.getElementById('modalTop10');
        
        if (!modal) {
            // Crear el modal sin t√≠tulo externo
            modal = document.createElement('div');
            modal.id = 'modalTop10';
            modal.className = 'modal-top10';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="cerrarModalTop10()"></div>
                <div class="modal-content">
                    <canvas id="graficaTop10Modal" width="1400" height="850"></canvas>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Agregar estilos CSS minimalistas
            agregarEstilosModalMinimalista();
        }
        
        // Mostrar el modal
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        // Generar la gr√°fica en el modal
        setTimeout(() => {
            generarGraficaTop10Modal(periodoCompleto);
        }, 50);
    }
    
    function agregarEstilosModalMinimalista() {
        const style = document.createElement('style');
        style.textContent = `
            /* MODAL MINIMALISTA */
            .modal-top10 {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 9999;
            }
            
            .modal-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.92);
                backdrop-filter: blur(5px);
                -webkit-backdrop-filter: blur(5px);
                cursor: pointer;
                animation: fadeIn 0.2s ease-out;
            }
            
            .modal-content {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: transparent;
                width: 95%;
                max-width: 1400px;
                max-height: 95vh;
                animation: slideIn 0.3s ease-out;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 0;
                border: none;
                box-shadow: none;
            }
            
            #graficaTop10Modal {
                max-width: 100%;
                max-height: 95vh;
                height: auto !important;
                background: white;
                border-radius: 12px;
                padding: 40px 30px 30px 30px; /* M√°s padding superior para t√≠tulo */
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
                cursor: default;
            }
            
            /* ANIMACIONES SUAVES */
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translate(-50%, -55%) scale(0.95);
                }
                to {
                    opacity: 1;
                    transform: translate(-50%, -50%) scale(1);
                }
            }
            
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
            
            @keyframes slideOut {
                from {
                    opacity: 1;
                    transform: translate(-50%, -50%) scale(1);
                }
                to {
                    opacity: 0;
                    transform: translate(-50%, -45%) scale(0.95);
                }
            }
            
            /* EFECTO DE CIERRE */
            .modal-top10.closing .modal-overlay {
                animation: fadeOut 0.2s ease-in forwards;
            }
            
            .modal-top10.closing .modal-content {
                animation: slideOut 0.2s ease-in forwards;
            }
            
            /* RESPONSIVE */
            @media (max-width: 1600px) {
                #graficaTop10Modal {
                    width: 1300px !important;
                    height: 800px !important;
                    padding: 35px 25px 25px 25px;
                }
            }
            
            @media (max-width: 1400px) {
                #graficaTop10Modal {
                    width: 1200px !important;
                    height: 750px !important;
                    padding: 30px 20px 20px 20px;
                }
            }
            
            @media (max-width: 1200px) {
                #graficaTop10Modal {
                    width: 1100px !important;
                    height: 700px !important;
                    padding: 25px 15px 15px 15px;
                }
            }
            
            @media (max-width: 992px) {
                .modal-content {
                    width: 98%;
                }
                
                #graficaTop10Modal {
                    width: 1000px !important;
                    height: 650px !important;
                    padding: 20px 15px 15px 15px;
                }
            }
            
            @media (max-width: 768px) {
                #graficaTop10Modal {
                    width: 95% !important;
                    height: 550px !important;
                    padding: 15px 10px 10px 10px;
                    border-radius: 8px;
                }
            }
            
            @media (max-width: 576px) {
                #graficaTop10Modal {
                    width: 98% !important;
                    height: 500px !important;
                    padding: 12px 8px 8px 8px;
                    border-radius: 6px;
                }
            }
            
            /* MEJORAR TEXTO EN GR√ÅFICA */
            .chartjs-render-monitor text {
                font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif !important;
            }
        `;
        document.head.appendChild(style);
    }
    
    function cerrarModalTop10() {
        const modal = document.getElementById('modalTop10');
        if (modal) {
            // Agregar clase para animaci√≥n de salida
            modal.classList.add('closing');
            
            // Esperar a que termine la animaci√≥n antes de ocultar
            setTimeout(() => {
                modal.style.display = 'none';
                modal.classList.remove('closing');
                document.body.style.overflow = 'auto';
                
                // Destruir SOLO la gr√°fica modal - NO chartTop10 general
                if (chartTop10Modal) {
                    chartTop10Modal.destroy();
                    chartTop10Modal = null;
                }
            }, 200);
        }
    }
    
    // Agregar funcionalidad de teclas (SOLO ESC para cerrar)
    document.addEventListener('keydown', function(event) {
        const modal = document.getElementById('modalTop10');
        if (modal && modal.style.display === 'block') {
            // ESC para cerrar
            if (event.key === 'Escape') {
                cerrarModalTop10();
            }
        }
    });

    let chartTop10Modal = null;
    
    function generarGraficaTop10Modal(periodoCompleto) {
        if (!datosMeses[periodoCompleto]) {
            alert('No hay datos disponibles para este periodo.');
            cerrarModalTop10();
            return;
        }
        
        const asesores = datosMeses[periodoCompleto] || [];
        const asesoresOrdenados = [...asesores].sort((a, b) => b.porcentaje - a.porcentaje);
        const top10 = asesoresOrdenados.slice(0, 10);
        
        if (top10.length === 0) {
            alert('No hay asesores para mostrar en el Top 10.');
            cerrarModalTop10();
            return;
        }
        
        // Nombres m√°s cortos para el modal grande
        const nombres = top10.map((asesor, index) => {
            let nombre = asesor.nombre;
            if (nombre.length > 30) {
                nombre = nombre.substring(0, 28) + '...';
            }
            return nombre;
        });
        
        const porcentajes = top10.map(asesor => asesor.porcentaje);
        const clasificaciones = top10.map(asesor => asesor.clasificacion);
        
        const coloresPorClasificacion = {
            '>100%': '#27ae60',
            '>70%': '#f39c12',
            '>40%': '#e67e22',
            '>0%': '#e74c3c'
        };
        
        const coloresBarras = clasificaciones.map(clas => coloresPorClasificacion[clas] || '#95a5a6');
        const coloresNombres = top10.map((asesor, index) => {
            if (index === 0) return '#B8860B';
            if (index === 1) return '#696969';
            if (index === 2) return '#8B4513';
            return '#2c3e50';
        });
        
        const canvas = document.getElementById('graficaTop10Modal');
        const ctx = canvas.getContext('2d');
        
        if (chartTop10Modal) {
            chartTop10Modal.destroy();
            chartTop10Modal = null;
        }
        
        chartTop10Modal = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: nombres,
                datasets: [{
                    label: 'Porcentaje de Alcance',
                    data: porcentajes,
                    backgroundColor: coloresBarras,
                    borderColor: coloresBarras.map(color => color + 'CC'),
                    borderWidth: 3,
                    borderRadius: 10,
                    borderSkipped: false
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: false,
                maintainAspectRatio: false,
                
                // T√çTULO DENTRO DEL CANVAS
                plugins: {
                    title: {
                        display: true,
                        text: `üèÜ TOP 10 ASESORES - ${periodoCompleto.replace('_', ' ')}`,
                        font: {
                            size: 32,
                            weight: 'bold',
                            family: 'Segoe UI'
                        },
                        color: '#2c3e50',
                        padding: {
                            top: 10,
                            bottom: 30
                        }
                    },
                    
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        titleFont: {
                            size: 20,
                            weight: 'bold',
                            family: 'Segoe UI'
                        },
                        bodyFont: {
                            size: 18,
                            family: 'Segoe UI'
                        },
                        padding: 20,
                        cornerRadius: 10,
                        displayColors: false,
                        callbacks: {
                            title: function(context) {
                                const index = context[0].dataIndex;
                                const asesor = top10[index];
                                const icon = index === 0 ? 'ü•á ' : index === 1 ? 'ü•à ' : index === 2 ? 'ü•â ' : '';
                                return icon + asesor.nombre;
                            },
                            label: function(context) {
                                const index = context.dataIndex;
                                const asesor = top10[index];
                                return [
                                    `Porcentaje: ${context.parsed.x}%`,
                                    `Clasificaci√≥n: ${asesor.clasificacion}`,
                                    `Supervisor: ${asesor.supervisor || 'Sin Supervisor'}`
                                ];
                            }
                        }
                    },
                    legend: { display: false }
                },
                
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            },
                            font: {
                                size: 18,
                                family: 'Segoe UI',
                                weight: 'bold'
                            },
                            color: '#34495e'
                        },
                        afterDataLimits: (scale) => {
                            scale.max = Math.max(scale.max, 100);
                        }
                    },
                    y: {
                        afterFit: function(scale) {
                            scale.width = 380; // M√°s ancho para nombres
                            scale.left = 60;
                        },
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        ticks: {
                            color: function(context) {
                                return coloresNombres[context.index];
                            },
                            font: function(context) {
                                const index = context.index;
                                return { 
                                    weight: index <= 2 ? 'bold' : '600',
                                    size: index <= 2 ? 26 : 24,
                                    family: 'Segoe UI'
                                };
                            },
                            autoSkip: false,
                            maxRotation: 0,
                            padding: 15
                        }
                    }
                },
                
                animation: {
                    duration: 1200,
                    easing: 'easeOutQuart'
                }
            }
        });
        
        // Plugin para etiquetas de porcentaje GRANDES
        Chart.register({
            id: 'dataLabelsModal',
            afterDatasetsDraw(chart, args, options) {
                const {ctx} = chart;
                const meta = chart.getDatasetMeta(0);
                
                meta.data.forEach((bar, index) => {
                    const value = chart.data.datasets[0].data[index];
                    if (value === null || value === undefined) return;
                    
                    ctx.save();
                    
                    const x = bar.x - 25;
                    const y = bar.y;
                    const formattedValue = value.toFixed(1) + '%';
                    
                    // TEXTO MUY GRANDE
                    ctx.font = 'bold 22px Segoe UI';
                    ctx.textAlign = 'right';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = '#ffffff';
                    
                    // Sombra para mejor legibilidad
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                    ctx.shadowBlur = 5;
                    ctx.shadowOffsetX = 2;
                    ctx.shadowOffsetY = 2;
                    
                    ctx.fillText(formattedValue, x, y);
                    
                    ctx.restore();
                });
            }
        });
        
        // Plugin para n√∫meros de posici√≥n
        Chart.register({
            id: 'positionNumbersModal',
            afterDatasetsDraw(chart, args, options) {
                const {ctx} = chart;
                const meta = chart.getDatasetMeta(0);
                
                meta.data.forEach((bar, index) => {
                    ctx.save();
                    
                    const x = 15;
                    const y = bar.y;
                    
                    let textColor;
                    if (index === 0) textColor = '#B8860B';
                    else if (index === 1) textColor = '#696969';
                    else if (index === 2) textColor = '#8B4513';
                    else textColor = '#2c3e50';
                    
                    ctx.font = `bold 20px Segoe UI`;
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = textColor;
                    
                    let positionText = (index + 1) + '.';
                    if (index === 0) positionText = 'ü•á ' + positionText;
                    else if (index === 1) positionText = 'ü•à ' + positionText;
                    else if (index === 2) positionText = 'ü•â ' + positionText;
                    
                    ctx.fillText(positionText, x, y);
                    
                    ctx.restore();
                });
            }
        });
        
        chartTop10Modal.update();
    }

    function generarGraficaTop10(periodoCompleto) {
        if (!datosMeses[periodoCompleto]) {
            alert('No hay datos disponibles para este periodo.');
            cerrarTop10();
            return;
        }
        
        // Obtener todos los asesores del periodo
        const asesores = datosMeses[periodoCompleto] || [];
        
        // Ordenar por porcentaje (de mayor a menor)
        const asesoresOrdenados = [...asesores].sort((a, b) => b.porcentaje - a.porcentaje);
        
        // Tomar los primeros 10
        const top10 = asesoresOrdenados.slice(0, 10);
        
        if (top10.length === 0) {
            alert('No hay asesores para mostrar en el Top 10.');
            return;
        }
        
        // Preparar datos para la gr√°fica - NOMBRES M√ÅS CORTOS
        const nombres = top10.map((asesor, index) => {
            let nombre = asesor.nombre;
            // M√°s agresivo con nombres largos
            if (nombre.length > 22) {
                nombre = nombre.substring(0, 20) + '...';
            }
            return nombre;
        });
        
        const porcentajes = top10.map(asesor => asesor.porcentaje);
        const clasificaciones = top10.map(asesor => asesor.clasificacion);
        
        // Colores seg√∫n clasificaci√≥n (para las barras)
        const coloresPorClasificacion = {
            '>100%': '#27ae60',  // Verde
            '>70%': '#f39c12',   // Amarillo
            '>40%': '#e67e22',   // Naranja
            '>0%': '#e74c3c'     // Rojo
        };
        
        const coloresBarras = clasificaciones.map(clas => coloresPorClasificacion[clas] || '#95a5a6');
        
        // Colores M√ÅS OSCUROS para los nombres (especialmente el 2do lugar)
        const coloresNombres = top10.map((asesor, index) => {
            if (index === 0) return '#B8860B';      // ORO OSCURO (m√°s visible)
            if (index === 1) return '#696969';      // PLATA OSCURA (gris oscuro)
            if (index === 2) return '#8B4513';      // BRONCE OSCURO
            return '#2c3e50';                       // Negro para el resto
        });
        
        // Iconos de medalla para tooltip
        const iconosMedalla = top10.map((asesor, index) => {
            if (index === 0) return 'ü•á ';
            if (index === 1) return 'ü•à ';
            if (index === 2) return 'ü•â ';
            return '';
        });
        
        // Obtener canvas
        const canvas = document.getElementById('graficaTop10');
        const ctx = canvas.getContext('2d');
        
        // Destruir gr√°fica anterior si existe
        if (chartTop10) {
            chartTop10.destroy();
            chartTop10 = null;
        }
        
        // Crear gr√°fica de barras horizontales
        chartTop10 = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: nombres,
                datasets: [{
                    label: 'Porcentaje de Alcance',
                    data: porcentajes,
                    backgroundColor: coloresBarras,
                    borderColor: coloresBarras.map(color => color + 'CC'),
                    borderWidth: 2,
                    borderRadius: 8,
                    borderSkipped: false
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            },
                            font: {
                                size: 16,
                                family: 'Segoe UI',
                                weight: 'bold'
                            },
                            color: '#34495e'
                        },
                        // L√≠nea de meta al 100%
                        afterDataLimits: (scale) => {
                            scale.max = Math.max(scale.max, 100);
                        }
                    },
                    y: {
                        // AJUSTE CLAVE: AUMENTAR ANCHO DEL EJE Y
                        afterFit: function(scale) {
                            scale.width = 300; // Ancho aumentado para nombres largos
                            scale.left = 60;   // Margen izquierdo
                        },
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        ticks: {
                            color: function(context) {
                                const index = context.index;
                                return coloresNombres[index];
                            },
                            font: function(context) {
                                const index = context.index;
                                if (index <= 2) {
                                    return { 
                                        weight: 'bold', 
                                        size: 20,  // Reducido para nombres largos
                                        family: 'Segoe UI'
                                    };
                                }
                                return { 
                                    weight: '600',
                                    size: 20,     // Reducido para nombres largos
                                    family: 'Segoe UI'
                                };
                            },
                            autoSkip: false,
                            maxRotation: 0,
                            padding: 8  // Reducido para m√°s espacio
                        }
                    }
                },
                
                plugins: {
                    title: {
                        display: true,
                        text: `üèÜ TOP 10 ASESORES - ${periodoCompleto.replace('_', ' ')}`,
                        font: {
                            size: 22,
                            weight: 'bold',
                            family: 'Segoe UI'
                        },
                        color: '#2c3e50',
                        padding: {
                            top: 20,
                            bottom: 30
                        }
                    },
                    
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        titleFont: {
                            size: 16,
                            weight: 'bold',
                            family: 'Segoe UI'
                        },
                        bodyFont: {
                            size: 14,
                            family: 'Segoe UI'
                        },
                        padding: 15,
                        cornerRadius: 8,
                        displayColors: false,
                        callbacks: {
                            title: function(context) {
                                const index = context[0].dataIndex;
                                const asesor = top10[index];
                                return `${iconosMedalla[index]}${asesor.nombre}`;
                            },
                            label: function(context) {
                                const index = context.dataIndex;
                                const asesor = top10[index];
                                const puesto = index + 1;
                                
                                let tooltipText = [];
                                
                                tooltipText.push(`üèÖ PUESTO: ${puesto}¬∫`);
                                tooltipText.push(`üìä PORCENTAJE: ${context.parsed.x}%`);
                                tooltipText.push(`üéØ CLASIFICACI√ìN: ${asesor.clasificacion}`);
                                tooltipText.push(`üë®‚Äçüíº SUPERVISOR: ${asesor.supervisor || 'Sin Supervisor'}`);
                                tooltipText.push(`üí∞ RECUPERO: S/ ${(asesor.recupero || 0).toLocaleString('es-PE', {minimumFractionDigits: 2})}`);
                                tooltipText.push(`üéØ META: S/ ${(asesor.meta || 0).toLocaleString('es-PE', {minimumFractionDigits: 2})}`);
                                
                                if (asesor.meta_super > 0) {
                                    tooltipText.push(`üë• META SUPERVISOR: S/ ${asesor.meta_super.toLocaleString('es-PE', {minimumFractionDigits: 2})}`);
                                }
                                
                                // A√±adir emoji especial para los primeros 3
                                if (puesto === 1) {
                                    tooltipText.push('');
                                    tooltipText.push('üî• ¬°PRIMER LUGAR! üî•');
                                } else if (puesto === 2) {
                                    tooltipText.push('');
                                    tooltipText.push('‚ö° ¬°SEGUNDO LUGAR! ‚ö°');
                                } else if (puesto === 3) {
                                    tooltipText.push('');
                                    tooltipText.push('‚ú® ¬°TERCER LUGAR! ‚ú®');
                                }
                                
                                return tooltipText;
                            }
                        }
                    },
                    
                    legend: {
                        display: false
                    }
                },
                
                // Animaciones
                animation: {
                    duration: 1500,
                    easing: 'easeOutQuart'
                }
            }
        });
        
        // PLUGIN SIMPLE PARA ETIQUETAS DE PORCENTAJE CON TEXTO GRANDE
        Chart.register({
            id: 'simpleDataLabels',
            afterDatasetsDraw(chart, args, options) {
                const {ctx} = chart;
                const meta = chart.getDatasetMeta(0);
                
                meta.data.forEach((bar, index) => {
                    const value = chart.data.datasets[0].data[index];
                    if (value === null || value === undefined) return;
                    
                    ctx.save();
                    
                    // Posici√≥n del porcentaje (dentro de la barra, cerca del final)
                    const x = bar.x - 15; // Aumentado para texto m√°s grande
                    const y = bar.y;
                    
                    // Formatear el valor
                    const formattedValue = value.toFixed(1) + '%';
                    
                    // CONFIGURAR ESTILO DEL TEXTO - TEXTO M√ÅS GRANDE
                    ctx.font = 'bold 17px Segoe UI'; // AUMENTADO a 17px
                    ctx.textAlign = 'right';
                    ctx.textBaseline = 'middle';
                    
                    // Color del texto: blanco para mejor contraste
                    ctx.fillStyle = '#ffffff';
                    
                    // Sombra sutil para mejor legibilidad
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                    ctx.shadowBlur = 3;
                    ctx.shadowOffsetX = 1;
                    ctx.shadowOffsetY = 1;
                    
                    // Dibujar el texto
                    ctx.fillText(formattedValue, x, y);
                    
                    // Para valores peque√±os, mostrar fuera de la barra
                    if (value < 15) {
                        // Mostrar fuera de la barra con fondo para mejor visibilidad
                        ctx.textAlign = 'left';
                        ctx.fillStyle = '#2c3e50';
                        ctx.font = 'bold 15px Segoe UI';
                        // Fondo para el texto
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                        ctx.fillRect(bar.x + 5, y - 10, ctx.measureText(formattedValue).width + 10, 20);
                        ctx.fillStyle = '#2c3e50';
                        ctx.fillText(formattedValue, bar.x + 10, y);
                    }
                    
                    ctx.restore();
                });
            }
        });
        
        // PLUGIN PARA A√ëADIR N√öMEROS DE POSICI√ìN SIMPLES (sin c√≠rculos)
        Chart.register({
            id: 'simplePositionNumbers',
            afterDatasetsDraw(chart, args, options) {
                const {ctx} = chart;
                const meta = chart.getDatasetMeta(0);
                
                meta.data.forEach((bar, index) => {
                    ctx.save();
                    
                    // POSICI√ìN AJUSTADA: m√°s a la izquierda para dar espacio
                    const x = 5; // Cerca del borde izquierdo
                    const y = bar.y;
                    
                    // Color seg√∫n posici√≥n
                    let textColor;
                    if (index === 0) {
                        textColor = '#B8860B'; // Oro oscuro
                    } else if (index === 1) {
                        textColor = '#696969'; // Plata oscura
                    } else if (index === 2) {
                        textColor = '#8B4513'; // Bronce oscuro
                    } else {
                        textColor = '#2c3e50'; // Negro
                    }
                    
                    // Configurar estilo (fuente reducida)
                    ctx.font = `bold 14px Segoe UI`;
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = textColor;
                    
                    // Dibujar el n√∫mero con emoji de medalla para primeros 3
                    let positionText = (index + 1) + '.';
                    if (index === 0) {
                        positionText = 'ü•á ' + positionText;
                    } else if (index === 1) {
                        positionText = 'ü•à ' + positionText;
                    } else if (index === 2) {
                        positionText = 'ü•â ' + positionText;
                    }
                    
                    ctx.fillText(positionText, x, y);
                    
                    ctx.restore();
                });
            }
        });
        
        // Forzar actualizaci√≥n
        chartTop10.update();
        
        // Agregar CSS para mejorar contraste y espaciado
        const style = document.createElement('style');
        style.textContent = `
            /* Fondo sutil para mejor legibilidad */
            #graficaTop10 {
                background-color: #f8f9fa !important;
                border-radius: 10px;
                padding: 15px 5px 15px 5px; /* M√°s padding lateral */
            }
            
            /* Asegurar que el canvas ocupe todo el espacio */
            .grafica-top10-container {
                overflow: visible !important;
            }
            
            /* Mejorar legibilidad de texto en gr√°ficos */
            .chartjs-render-monitor text {
                font-family: 'Segoe UI', sans-serif !important;
            }
        `;
        document.head.appendChild(style);
    }
</script>
</body>
</html>