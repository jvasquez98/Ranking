<!DOCTYPE html>
<html lang="es">
<head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evolutivo de Alcance por Asesor y Supervisor</title>
    <style>
        :root {
            --verde-oscuro: #1b5e20;
            --verde-claro: #c8e6c9;
            --amarillo-oscuro: #FCCF10;
            --amarillo-claro: #FEF6D2;
            --naranja-oscuro: #e65100;
            --naranja-claro: #ffe0b2;
            --rojo-oscuro: #b71c1c;
            --rojo-claro: #ffcdd2;
            --azul-oscuro: #1565c0;
            --azul-claro: #e3f2fd;
            --gris: #f5f5f5;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .selectores-periodo {
            margin: 20px 0;
            text-align: center;
        }
        
        .selectores-periodo select {
            padding: 10px 15px;
            font-size: 1.1rem;
            border: 2px solid #4a6491;
            border-radius: 8px;
            background-color: white;
            cursor: pointer;
            margin: 0 10px;
        }
        
        .fecha-actualizacion {
            font-size: 1rem;
            margin-top: 10px;
            opacity: 0.9;
        }

        .botones-supervisores {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        
        .boton-supervisor {
            padding: 10px 20px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .boton-supervisor:hover {
            background: linear-gradient(135deg, #2980b9, #1f6396);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .boton-supervisor.activo {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            box-shadow: 0 0 0 2px white, 0 0 0 4px #2ecc71;
        }
        
        .boton-supervisor.todos {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }
        
        .boton-supervisor.todos:hover {
            background: linear-gradient(135deg, #8e44ad, #7d3c98);
        }
        
        .busqueda-asesores, .busqueda-supervisores {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin: 30px 0;
        }
        
        .busqueda-asesores h2, .busqueda-supervisores h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .controles-busqueda {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .input-busqueda {
            flex: 1;
            min-width: 300px;
            padding: 12px 15px;
            font-size: 1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: white;
        }
        
        .boton-busqueda {
            padding: 12px 25px;
            font-size: 1rem;
            background: var(--azul-oscuro);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .boton-busqueda:hover {
            background: #0d47a1;
        }
        
        .asesores-seleccionados, .supervisores-seleccionados {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .tag-asesor, .tag-supervisor {
            background: var(--azul-claro);
            color: var(--azul-oscuro);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .eliminar-asesor, .eliminar-supervisor {
            background: none;
            border: none;
            color: var(--azul-oscuro);
            cursor: pointer;
            font-weight: bold;
            padding: 0;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .eliminar-asesor:hover, .eliminar-supervisor:hover {
            background: var(--azul-oscuro);
            color: white;
        }
        
        .periodo-prueba {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
        }
        
        .periodo-prueba h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .controles-periodo {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .input-periodo {
            padding: 10px 15px;
            font-size: 1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: white;
            width: 120px;
            text-align: center;
        }
        
        .resultados-periodo {
            margin-top: 20px;
            display: none;
        }
        
        .tabla-periodo {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .tabla-periodo th {
            background: var(--azul-oscuro);
            color: white;
            padding: 12px 8px;
            text-align: center;
        }
        
        .tabla-periodo td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }
        
        .resultados-comparacion {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            display: none;
        }
        
        .tabla-comparacion {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .tabla-comparacion th {
            background: var(--azul-oscuro);
            color: white;
            padding: 8px 6px;
            text-align: center;
            white-space: nowrap;
            position: sticky;
            left: 0;
            z-index: 10;
        }
        
        .tabla-comparacion th.mes-header {
            background: #2c3e50;
            position: sticky;
            top: 0;
            z-index: 20;
            min-width: 80px;
        }
        
        .tabla-comparacion td {
            padding: 6px 4px;
            border-bottom: 1px solid #eee;
            text-align: center;
            min-width: 80px;
        }
        
        .tabla-comparacion td.asesor-name, .tabla-comparacion td.supervisor-name {
            background: #f8f9fa;
            font-weight: 600;
            text-align: left;
            position: sticky;
            left: 0;
            z-index: 5;
            min-width: 150px;
            font-size: 0.8rem;
            padding: 6px 8px;
        }
        
        .tabla-comparacion tr:hover td:not(.asesor-name):not(.supervisor-name) {
            background: #f8f9fa;
        }
        
        .porcentaje-tabla {
            font-weight: bold;
            padding: 6px 8px;
            border-radius: 12px;
            color: white;
            text-align: center;
            display: inline-block;
            min-width: 50px;
            font-size: 0.85rem;
        }
        
        .sin-participacion {
            color: #999;
            font-style: italic;
        }
        
        .controles-comparacion {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .btn-comparacion {
            padding: 8px 16px;
            background: var(--azul-oscuro);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .btn-comparacion:hover {
            opacity: 0.9;
        }
        
        .btn-comparacion.activo {
            background: var(--verde-oscuro);
        }
        
        .estado-aprobado {
            color: var(--verde-oscuro);
            font-weight: bold;
        }
        
        .estado-reprobado {
            color: var(--rojo-oscuro);
            font-weight: bold;
        }
        
        .clasificaciones {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .clasificacion {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .clasificacion:hover {
            transform: translateY(-5px);
        }
        
        .clasificacion-header {
            padding: 15px;
            color: white;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .clasificacion-100 {
            background-color: var(--verde-oscuro);
        }
        
        .clasificacion-70 {
            background-color: var(--amarillo-oscuro);
        }
        
        .clasificacion-40 {
            background-color: var(--naranja-oscuro);
        }
        
        .clasificacion-0 {
            background-color: var(--rojo-oscuro);
        }
        
        .asesores-lista {
            max-height: 400px;
            overflow-y: auto;
            background-color: white;
        }
        
        .asesor-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .asesor-item:last-child {
            border-bottom: none;
        }
        
        .asesor-nombre {
            font-weight: 500;
        }
        
        .asesor-porcentaje {
            font-weight: bold;
            padding: 4px 10px;
            border-radius: 20px;
            color: white;
            font-size: 0.9rem;
        }
        
        .gradiente-100 {
            background: linear-gradient(to right, var(--verde-claro), white);
        }
        
        .gradiente-70 {
            background: linear-gradient(to right, var(--amarillo-claro), white);
        }
        
        .gradiente-40 {
            background: linear-gradient(to right, var(--naranja-claro), white);
        }
        
        .gradiente-0 {
            background: linear-gradient(to right, var(--rojo-claro), white);
        }
        
        .porcentaje-100 {
            background-color: var(--verde-oscuro);
        }
        
        .porcentaje-70 {
            background-color: var(--amarillo-oscuro);
        }
        
        .porcentaje-40 {
            background-color: var(--naranja-oscuro);
        }
        
        .porcentaje-0 {
            background-color: var(--rojo-oscuro);
        }
        
        .estadisticas {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }
        
        .estadistica-card {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .estadistica-valor {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .estadistica-100 .estadistica-valor {
            color: var(--verde-oscuro);
        }
        
        .estadistica-70 .estadistica-valor {
            color: var(--amarillo-oscuro);
        }
        
        .estadistica-40 .estadistica-valor {
            color: var(--naranja-oscuro);
        }
        
        .estadistica-0 .estadistica-valor {
            color: var(--rojo-oscuro);
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
        }

        .boton-vista-detalle {
            background: #2c3e50;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 0;
            transition: background 0.3s ease;
        }
        
        .boton-vista-detalle:hover {
            background: #34495e;
        }
        
        .vista-detalle {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
            display: none;
            border: 1px solid #ddd;
        }
        
        .vista-detalle h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .controles-vista-detalle {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #2c3e50;
        }
        
        .resumen-totales {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .resumen-totales h4 {
            margin: 0 0 10px 0;
            font-size: 1.1rem;
        }
        
        .estadisticas-detalle {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .estadistica-detalle {
            background: white;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            border-left: 4px solid #2c3e50;
        }
        
        .estadistica-detalle .valor {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 5px 0;
        }
        
        .estadistica-detalle .label {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .grafica-comparacion-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #ddd;
            position: relative; /* ‚Üê AGREGAR ESTO */
        }
        
        .controles-grafica {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }
        
        .controles-grafica .btn-comparacion {
            padding: 6px 12px;
            font-size: 0.8rem;
        }
        
        #graficaDesempenio, #graficaDesempenioSupervisores {
            max-width: 100%;
            height: 400px !important; /* ‚Üê FORZAR ALTURA */
            width: 100% !important; /* ‚Üê FORZAR ANCHO */
            margin: 0 auto;
            display: block; /* ‚Üê AGREGAR ESTO */
        }

        /* NUEVO: Estilo para el contenedor de exportaci√≥n en el gr√°fico */
        .grafica-tendencia-container .controles-exportacion {
            display: flex;
            gap: 10px;
            margin: 20px 0 25px 0; /* AGREGADO: 20px arriba, 25px abajo */
            justify-content: center;
        }
        
        .boton-exportar {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .boton-exportar:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        /* Estilos responsive */
        @media (max-width: 768px) {
            .controles-exportacion {
                flex-direction: column;
                align-items: center;
            }
            
            .boton-exportar {
                width: 100%;
                justify-content: center;
            }
        }

        .grafica-tendencia-container {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
            overflow-x: auto;
        }
        
        .grafica-tendencia-container h4 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .controles-grafica-tendencia {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .controles-grafica-tendencia .btn-comparacion {
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 160px;
        }
        
        .controles-grafica-tendencia .btn-comparacion.activo {
            background: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }
        
        .controles-grafica-tendencia .btn-comparacion:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        #graficaTendenciaDiaria {
            width: 1200px !important;
            height: 450px !important;
            margin: 0 auto;
            display: block;
            min-width: 1200px;
        }

        .grafica-equipos-container {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
            overflow-x: auto;
        }
        
        .grafica-equipos-container h4 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        #graficaAlcanceEquipos {
            width: 1200px !important;
            height: 400px !important;
            margin: 0 auto;
            display: block;
            min-width: 1200px;
        }

    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>CONSOLIDADO DE RECUPEROS Y ALCANCES</h1>
        <div class="selectores-periodo">
            <select id="selectorMes" onchange="actualizarPeriodo()">
                <option value="ENERO" >Enero</option>
<option value="FEBRERO" >Febrero</option>
<option value="MARZO" >Marzo</option>
<option value="ABRIL" >Abril</option>
<option value="MAYO" >Mayo</option>
<option value="JUNIO" >Junio</option>
<option value="JULIO" >Julio</option>
<option value="AGOSTO" >Agosto</option>
<option value="SETIEMBRE" >Setiembre</option>
<option value="OCTUBRE" >Octubre</option>
<option value="NOVIEMBRE" >Noviembre</option>
<option value="DICIEMBRE" selected>Diciembre</option>

            </select>
            <select id="selectorA√±o" onchange="actualizarPeriodo()">
                <option value="2025" selected>2025</option>

            </select>
        </div>
        <!-- NUEVO BOT√ìN PARA VISTA DETALLE -->
        <button class="boton-vista-detalle" onclick="mostrarVistaDetalle()">
            üìä Ver Detalle por D√≠a
        </button>
        <div class="fecha-actualizacion">√öltima actualizaci√≥n: 04 de December de 2025 a las 11:52</div>
        
        <!-- NUEVA SECCI√ìN: Botones de Supervisores -->
        <div class="botones-supervisores">
            <button class="boton-supervisor todos activo" onclick="filtrarPorSupervisor('TODOS')">
                üë• TODOS LOS SUPERVISORES
            </button>
            <button class="boton-supervisor" onclick="filtrarPorSupervisor('JORGE')">JORGE</button>
<button class="boton-supervisor" onclick="filtrarPorSupervisor('KENNETH')">KENNETH</button>
<button class="boton-supervisor" onclick="filtrarPorSupervisor('LEONOR')">LEONOR</button>
<button class="boton-supervisor" onclick="filtrarPorSupervisor('MELINA')">MELINA</button>
<button class="boton-supervisor" onclick="filtrarPorSupervisor('SANDY')">SANDY</button>

        </div>
    </header>
    
    <div id="contenidoPrincipal">
        <!-- Secci√≥n de Clasificaci√≥n Visual -->
        <div class="clasificaciones">
            <div class="clasificacion">
                <div class="clasificacion-header clasificacion-100">100% ‚Äì ‚Üë</div>
                <div class="asesores-lista" id="lista-100">
                    <div class="asesor-item">No hay asesores en esta categor√≠a</div>
                </div>
            </div>
            
            <div class="clasificacion">
                <div class="clasificacion-header clasificacion-70">70% ‚Äì 100%</div>
                <div class="asesores-lista" id="lista-70">
                    
        <div class="asesor-item gradiente-70">
            <div class="asesor-nombre">JUAN LOZA</div>
            <div class="asesor-porcentaje porcentaje-70">
                74.9%
            </div>
        </div>
                </div>
            </div>
            
            <div class="clasificacion">
                <div class="clasificacion-header clasificacion-40">40% ‚Äì 70%</div>
                <div class="asesores-lista" id="lista-40">
                    
        <div class="asesor-item gradiente-40">
            <div class="asesor-nombre">ANDERSON RODRIGUEZ</div>
            <div class="asesor-porcentaje porcentaje-40">
                61.6%
            </div>
        </div>
        <div class="asesor-item gradiente-40">
            <div class="asesor-nombre">STWUAR MACURI</div>
            <div class="asesor-porcentaje porcentaje-40">
                55.3%
            </div>
        </div>
        <div class="asesor-item gradiente-40">
            <div class="asesor-nombre">NATALIA MARIN</div>
            <div class="asesor-porcentaje porcentaje-40">
                41.9%
            </div>
        </div>
                </div>
            </div>
            
            <div class="clasificacion">
                <div class="clasificacion-header clasificacion-0">0% ‚Äì 40%</div>
                <div class="asesores-lista" id="lista-0">
                    
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">MARIA HUARCAYA</div>
            <div class="asesor-porcentaje porcentaje-0">
                26.4%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">CARMEN PUMA</div>
            <div class="asesor-porcentaje porcentaje-0">
                25.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">ALEIDITH GUEVARA</div>
            <div class="asesor-porcentaje porcentaje-0">
                20.6%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">JHONATAN CHAVEZ</div>
            <div class="asesor-porcentaje porcentaje-0">
                16.5%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">MALORY MONTEBLANCO</div>
            <div class="asesor-porcentaje porcentaje-0">
                16.1%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">GIANFRANCO PINEDO</div>
            <div class="asesor-porcentaje porcentaje-0">
                15.7%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">LISELY MERA</div>
            <div class="asesor-porcentaje porcentaje-0">
                15.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">LUIS VALLADARES</div>
            <div class="asesor-porcentaje porcentaje-0">
                12.5%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">HAROLD FLORES</div>
            <div class="asesor-porcentaje porcentaje-0">
                10.6%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">VICTOR RAMIREZ</div>
            <div class="asesor-porcentaje porcentaje-0">
                10.2%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">URSULA CENTENO</div>
            <div class="asesor-porcentaje porcentaje-0">
                10.1%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">ALEJANDRA QUISPE</div>
            <div class="asesor-porcentaje porcentaje-0">
                5.6%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">MARIA TINTAYA</div>
            <div class="asesor-porcentaje porcentaje-0">
                4.5%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">JACQUELINE COLLAHUACHO</div>
            <div class="asesor-porcentaje porcentaje-0">
                3.8%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">VERONICA TASAYCO</div>
            <div class="asesor-porcentaje porcentaje-0">
                3.6%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">DARYL FERREL</div>
            <div class="asesor-porcentaje porcentaje-0">
                3.4%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">LUIS CENTENO</div>
            <div class="asesor-porcentaje porcentaje-0">
                3.2%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">JUAN ALANOCCA</div>
            <div class="asesor-porcentaje porcentaje-0">
                3.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">PIERINA TESEN</div>
            <div class="asesor-porcentaje porcentaje-0">
                2.7%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">GIANNINA AGUILAR</div>
            <div class="asesor-porcentaje porcentaje-0">
                2.5%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">JEREMIAS ROJAS</div>
            <div class="asesor-porcentaje porcentaje-0">
                2.4%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">ANALUCIA PONCE</div>
            <div class="asesor-porcentaje porcentaje-0">
                1.2%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">EVELY TENORIO</div>
            <div class="asesor-porcentaje porcentaje-0">
                1.2%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">LINDA TUESTA</div>
            <div class="asesor-porcentaje porcentaje-0">
                1.1%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">VERONICA HUARCA</div>
            <div class="asesor-porcentaje porcentaje-0">
                1.1%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">DANIEL ZAPATA</div>
            <div class="asesor-porcentaje porcentaje-0">
                1.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">ALEJANDRA AVILA</div>
            <div class="asesor-porcentaje porcentaje-0">
                1.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">SARITA GARAY</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.9%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">CARLA VALENCIA</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.8%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">JENY LAZARO</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.7%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">GENESIS VICUNA</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.6%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">JANETH PORTOCARRERO</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.2%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">GERALDINE ARROYO</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.1%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">JIMENA MEDINA</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">DAVID SANCHEZ</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">KIARA CANEPA</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">MILAGROS QUIO</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">CRISTINA TICONA</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">ERIKA VILLAR</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">JAIR MARTINEZ</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">MAYRA AVALOS</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">FRANCO HUAMANI</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">JESSICA MELGAREJO</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">MARGARITA PIANCHACHI</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">NOEMI CHUQUILIN</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">CHRISTIAN ALVARADO</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.0%
            </div>
        </div>
        <div class="asesor-item gradiente-0">
            <div class="asesor-nombre">LUCERO JORDAN</div>
            <div class="asesor-porcentaje porcentaje-0">
                0.0%
            </div>
        </div>
                </div>
            </div>
        </div>
        
        <!-- Panel de Estad√≠sticas -->
        <div class="estadisticas">
            <div class="estadistica-card estadistica-100">
                <div>Superaron el 100%</div>
                <div class="estadistica-valor" id="cantidad-100">0</div>
                <div>Meta superada</div>
            </div>
            
            <div class="estadistica-card estadistica-70">
                <div>Superaron el 70%</div>
                <div class="estadistica-valor" id="cantidad-70">1</div>
                <div>Alto rendimiento</div>
            </div>
            
            <div class="estadistica-card estadistica-40">
                <div>Superaron el 40%</div>
                <div class="estadistica-valor" id="cantidad-40">3</div>
                <div>Rendimiento medio</div>
            </div>
            
            <div class="estadistica-card estadistica-0">
                <div>Entre 0% a 40%</div>
                <div class="estadistica-valor" id="cantidad-0">47</div>
                <div>Por mejorar</div>
            </div>
        </div>
        
        <!-- Secci√≥n de B√∫squeda y Comparaci√≥n de ASESORES -->
        <section class="busqueda-asesores">
            <h2>üîç B√∫squeda y Comparaci√≥n de Asesores</h2>
            <div class="controles-busqueda">
                <input type="text" id="inputBusqueda" class="input-busqueda" placeholder="Escribe el nombre del asesor..." list="listaAsesores">
                <datalist id="listaAsesores">
                    <option value="ALEIDITH GUEVARA"><option value="ALEJANDRA AVILA"><option value="ALEJANDRA QUISPE"><option value="ALEJANDRO GONZALES"><option value="ANABEL SIHUE"><option value="ANALUCIA PONCE"><option value="ANDERSON RODRIGUEZ"><option value="ANDREA ALEJOS"><option value="ANGELO SUAREZ"><option value="ANTHONY TORRES"><option value="ANTHONY VICENTE"><option value="AURORA FAUSTOR"><option value="BRINA SOTO"><option value="BRYAN VELASQUEZ"><option value="CARLA VALENCIA"><option value="CARLOS CALAGUA"><option value="CARMEN PUMA"><option value="CHRISTIAN ALBUJAR"><option value="CHRISTIAN ALVARADO"><option value="CINTHYA PAUCAR"><option value="CRISTINA TICONA"><option value="DANIEL ZAPATA"><option value="DARY VICHARRA"><option value="DARYL FERREL"><option value="DAVID SANCHEZ"><option value="EDSON MAMANI"><option value="ERICK PORTILLA"><option value="ERIKA VILLAR"><option value="ESTRELLA TINTAYA"><option value="EVELY TENORIO"><option value="FRANCO HUAMANI"><option value="FRANK PACORA"><option value="FRANS TACSI"><option value="GABRIELA APONTE"><option value="GENESIS VICUNA"><option value="GERALDINE ARROYO"><option value="GERSON LAZARO"><option value="GIANFRANCO PINEDO"><option value="GIANNINA AGUILAR"><option value="GILBERTO PURIZACA"><option value="GINA HUAMANI"><option value="GIULIANA QUISPE"><option value="HARLINGTON VIDAL"><option value="HAROLD FLORES"><option value="ISABEL BEJARANO"><option value="JACQUELINE COLLAHUACHO"><option value="JAIME TUMIALAN"><option value="JAIR MARTINEZ"><option value="JANETH PORTOCARRERO"><option value="JENNY LAZARO"><option value="JENY LAZARO"><option value="JEREMIAS ROJAS"><option value="JERSON RIVERA"><option value="JESSICA MELGAREJO"><option value="JHOHAN CONTRERAS"><option value="JHONATAN CHAVEZ"><option value="JHOVANA TORRES"><option value="JIMENA MEDINA"><option value="JOANA GIL"><option value="JOSUE CHOCCE"><option value="JOSUE VILCHEZ"><option value="JUAN ALANOCCA"><option value="JUAN LOZA"><option value="KATHLEEN FLORES"><option value="KATYUSCA LEVANO"><option value="KIARA CANEPA"><option value="LINDA TUESTA"><option value="LISELY MERA"><option value="LIZETH RAMIREZ"><option value="LUCERO JORDAN"><option value="LUIS CENTENO"><option value="LUIS RUIZ"><option value="LUIS VALLADARES"><option value="LUPITA HIDALGO"><option value="LYNDA PEREZ"><option value="MALORY MONTEBLANCO"><option value="MARCELIT LOPEZ"><option value="MARCO QUISPE"><option value="MARCO SARMIENTO"><option value="MARCOS SARMIENTO"><option value="MARGARITA PIANCHACHI"><option value="MARIA GONZALES"><option value="MARIA HUARCAYA"><option value="MARIA TINTAYA"><option value="MAURICIO MARTINEZ"><option value="MAYRA AVALOS"><option value="MEDALITH NESTARES"><option value="MELISSA GUERRERO"><option value="MERLY CORONEL"><option value="MICAELA PEREZ"><option value="MICHAEL TAFUR"><option value="MILAGROS QUIO"><option value="MIRYAM YAPU"><option value="MISHEL MORALES"><option value="NARDIA URPIS"><option value="NATALIA MARIN"><option value="NOEMI CHUQUILIN"><option value="ORIANA ARANA"><option value="PAMELA ALBITES"><option value="PIERINA TESEN"><option value="RAQUEL RICO"><option value="RICHARD RODRIGUEZ"><option value="ROBERTO RODRIGUEZ"><option value="ROCIO TERRONES"><option value="ROGGER RODRIGUEZ"><option value="ROSA ROJAS"><option value="SARITA GARAY"><option value="SOLMAIRA BRAVO"><option value="STWUAR MACURI"><option value="TERRY ECHEVARRIA"><option value="URSULA CENTENO"><option value="VERONICA HUARCA"><option value="VERONICA TASAYCO"><option value="VICTOR RAMIREZ"><option value="YENNY INGA"><option value="YEYMY HUERTA">
                </datalist>
                <button class="boton-busqueda" onclick="agregarAsesor()">Agregar Asesor</button>
                <button class="boton-busqueda" onclick="compararAsesores()" style="background: var(--verde-oscuro);">Comparar Seleccionados</button>
                <button class="boton-busqueda" onclick="limpiarBusqueda()" style="background: var(--rojo-oscuro);">Limpiar</button>
            </div>
            
            <div class="asesores-seleccionados" id="asesoresSeleccionados">
                <!-- Aqu√≠ se mostrar√°n los asesores seleccionados -->
            </div>
            
            <div class="resultados-comparacion" id="resultadosComparacion">
                <h3>üìä Comparaci√≥n de Rendimiento - Asesores</h3>
                <div class="controles-comparacion">
                    <button class="btn-comparacion" onclick="cambiarVistaComparacion(3)">√öltimos 3 meses</button>
                    <button class="btn-comparacion activo" onclick="cambiarVistaComparacion(6)">√öltimos 6 meses</button>
                    <button class="btn-comparacion" onclick="cambiarVistaComparacion(10)">√öltimos 10 meses</button>
                </div>
                <div id="tablaComparacion"></div>
                <div class="grafica-comparacion-container" id="graficaComparacion" style="display: none;">
                    <h4>üìà Evoluci√≥n de Desempe√±o - Asesores</h4>
                    <div class="controles-grafica">
                        <button class="btn-comparacion" onclick="cambiarTipoGrafica('line')">L√≠neas</button>
                        <button class="btn-comparacion" onclick="cambiarTipoGrafica('bar')">Barras</button>
                    </div>
                    <canvas id="graficaDesempenio" width="800" height="400"></canvas>
                </div>
            </div>
        </section>

        <!-- NUEVA SECCI√ìN: B√∫squeda y Comparaci√≥n de SUPERVISORES -->
        <section class="busqueda-supervisores">
            <h2>üë• B√∫squeda y Comparaci√≥n de Supervisores</h2>
            <div class="controles-busqueda">
                <input type="text" id="inputBusquedaSupervisor" class="input-busqueda" placeholder="Escribe el nombre del supervisor..." list="listaSupervisores">
                <datalist id="listaSupervisores">
                    <option value="BRYAN"><option value="GUSTAVO"><option value="JOHAN"><option value="JORDAN"><option value="JORGE"><option value="KENNETH"><option value="LEONOR"><option value="LUIS"><option value="MELINA"><option value="MELITA"><option value="SANDY">
                </datalist>
                <button class="boton-busqueda" onclick="agregarSupervisor()">Agregar Supervisor</button>
                <button class="boton-busqueda" onclick="compararSupervisores()" style="background: var(--verde-oscuro);">Comparar Seleccionados</button>
                <button class="boton-busqueda" onclick="limpiarBusquedaSupervisores()" style="background: var(--rojo-oscuro);">Limpiar</button>
            </div>
            
            <div class="supervisores-seleccionados" id="supervisoresSeleccionados">
                <!-- Aqu√≠ se mostrar√°n los supervisores seleccionados -->
            </div>
            
            <div class="resultados-comparacion" id="resultadosComparacionSupervisores">
                <h3>üìä Comparaci√≥n de Rendimiento - Equipos</h3>
                <div class="controles-comparacion">
                    <button class="btn-comparacion" onclick="cambiarVistaComparacionSupervisores(3)">√öltimos 3 meses</button>
                    <button class="btn-comparacion activo" onclick="cambiarVistaComparacionSupervisores(6)">√öltimos 6 meses</button>
                    <button class="btn-comparacion" onclick="cambiarVistaComparacionSupervisores(10)">√öltimos 10 meses</button>
                </div>
                <div id="tablaComparacionSupervisores"></div>
                <div class="grafica-comparacion-container" id="graficaComparacionSupervisores" style="display: none;">
                    <h4>üìà Evoluci√≥n de Desempe√±o - Equipos</h4>
                    <div class="controles-grafica">
                        <button class="btn-comparacion" onclick="cambiarTipoGraficaSupervisores('line')">L√≠neas</button>
                        <button class="btn-comparacion" onclick="cambiarTipoGraficaSupervisores('bar')">Barras</button>
                    </div>
                    <canvas id="graficaDesempenioSupervisores" width="800" height="400"></canvas>
                </div>
            </div>
        </section>
        
        <!-- Secci√≥n de Periodo de Prueba -->
        <section class="periodo-prueba">
            <h3>üìà Evaluaci√≥n de Periodo de Prueba</h3>
            <div class="controles-periodo">
                <select id="mes1" class="input-periodo">
                    <option value="">Mes 1</option>
                    <option value="ENERO" >Enero</option>
<option value="FEBRERO" >Febrero</option>
<option value="MARZO" >Marzo</option>
<option value="ABRIL" >Abril</option>
<option value="MAYO" >Mayo</option>
<option value="JUNIO" >Junio</option>
<option value="JULIO" >Julio</option>
<option value="AGOSTO" >Agosto</option>
<option value="SETIEMBRE" >Setiembre</option>
<option value="OCTUBRE" >Octubre</option>
<option value="NOVIEMBRE" >Noviembre</option>
<option value="DICIEMBRE" selected>Diciembre</option>

                </select>
                <select id="a√±o1" class="input-periodo">
                    <option value="">A√±o 1</option>
                    <option value="2025" selected>2025</option>

                </select>
                <select id="mes2" class="input-periodo">
                    <option value="">Mes 2</option>
                    <option value="ENERO" >Enero</option>
<option value="FEBRERO" >Febrero</option>
<option value="MARZO" >Marzo</option>
<option value="ABRIL" >Abril</option>
<option value="MAYO" >Mayo</option>
<option value="JUNIO" >Junio</option>
<option value="JULIO" >Julio</option>
<option value="AGOSTO" >Agosto</option>
<option value="SETIEMBRE" >Setiembre</option>
<option value="OCTUBRE" >Octubre</option>
<option value="NOVIEMBRE" >Noviembre</option>
<option value="DICIEMBRE" selected>Diciembre</option>

                </select>
                <select id="a√±o2" class="input-periodo">
                    <option value="">A√±o 2</option>
                    <option value="2025" selected>2025</option>

                </select>
                <input type="number" id="porcentajeMinimo" class="input-periodo" placeholder="% M√≠nimo" value="70" min="0" max="100" step="0.1">
            </div>
            
            <div class="controles-busqueda" style="margin-top: 15px;">
                <input type="text" id="inputBusquedaPeriodo" class="input-busqueda" placeholder="Escribe el nombre del asesor para el periodo de prueba..." list="listaAsesores">
                <button class="boton-busqueda" onclick="agregarAsesorPeriodo()">Agregar Asesor</button>
                <button class="boton-busqueda" onclick="seleccionarTodosAsesoresPeriodo()" style="background: var(--verde-oscuro);">Seleccionar Todos</button>
                <button class="boton-busqueda" onclick="calcularPeriodoPrueba()" style="background: var(--azul-oscuro);">Calcular Periodo de Prueba</button>
                <button class="boton-busqueda" onclick="limpiarPeriodoPrueba()" style="background: var(--rojo-oscuro);">Limpiar Todo</button>
            </div>
            
            <div class="asesores-seleccionados" id="asesoresSeleccionadosPeriodo">
                <!-- Aqu√≠ se mostrar√°n los asesores seleccionados para periodo de prueba -->
            </div>
            
            <div class="resultados-periodo" id="resultadosPeriodo">
                <div id="tablaPeriodo"></div>
            </div>
        </section>
    </div>
    
    <!-- NUEVA SECCI√ìN MEJORADA PARA VISTA DETALLE (SIN TABLA) -->
    <section class="vista-detalle" id="vistaDetalle">
        <div class="resumen-totales">
            <h4>Resumen del Mes: <span id="mesActualDetalle">DICIEMBRE 2025</span></h4>
            <div class="estadisticas-detalle" id="estadisticasDetalle">
                <!-- Las estad√≠sticas se cargar√°n din√°micamente -->
            </div>
        </div>
        
        <!-- NUEVO: Gr√°fico de Alcance por Equipos -->
        <div class="grafica-equipos-container">
            <h4>üë• Alcance por Equipos - DICIEMBRE 2025</h4>
            <canvas id="graficaAlcanceEquipos" width="1200" height="400"></canvas>
        </div>
        
        <!-- Gr√°fico de Tendencia Diaria -->
        <div class="grafica-tendencia-container">
            <h4>üìà Evoluci√≥n del Recupero - DICIEMBRE 2025</h4>
            <div class="controles-exportacion">
                <button class="boton-exportar" onclick="exportarTablaDetalleExcelAvanzado()">
                    üìä Exportar Completo (Con Formatos)
                </button>
            </div>
            <div class="controles-grafica-tendencia">
                <button class="btn-comparacion activo" onclick="cambiarVistaGrafica('completa')">üìä Vista Completa</button>
                <button class="btn-comparacion" onclick="cambiarVistaGrafica('diario')">üìÖ Solo Recupero Diario</button>
                <button class="btn-comparacion" onclick="cambiarVistaGrafica('acumulado')">üìà Solo Acumulado</button>
            </div>
            <canvas id="graficaTendenciaDiaria" width="1200" height="450"></canvas>
        </div>
    </section>
    
    <footer>
        <p>Sistema de seguimiento de metas - Actualizaci√≥n diaria</p>
    </footer>
</div>

<script>
    // CORRECCI√ìN: Parsear los datos JSON correctamente
    const datosMeses = {datos_json_str};
    const datosSupervisores = {datos_supervisores_json_str};
    
    // Intentar parsear los datos
    let datosMeses = {};
    let datosSupervisores = {};
    
    try {
        // Primero quitar el escape HTML
        const datosMesesJson = datosMesesStr.replace(/&quot;/g, '"').replace(/\\"/g, '"');
        const datosSupervisoresJson = datosSupervisoresStr.replace(/&quot;/g, '"').replace(/\\"/g, '"');
        
        // Parsear el JSON
        datosMeses = JSON.parse(datosMesesJson);
        datosSupervisores = JSON.parse(datosSupervisoresJson);
        
        // Si ya era un string, parsear de nuevo
        if (typeof datosMeses === 'string') {
            datosMeses = JSON.parse(datosMeses);
        }
        if (typeof datosSupervisores === 'string') {
            datosSupervisores = JSON.parse(datosSupervisores);
        }
        
        console.log("‚úÖ Datos cargados correctamente");
        console.log("Meses disponibles:", Object.keys(datosMeses).length);
        console.log("Supervisores disponibles:", Object.keys(datosSupervisores).length);
        
    } catch (error) {
        console.error("‚ùå Error cargando datos:", error);
        console.log("datosMesesStr:", datosMesesStr.substring(0, 200));
        console.log("datosSupervisoresStr:", datosSupervisoresStr.substring(0, 200));
        
        // Datos de ejemplo para debugging
        datosMeses = {};
        datosSupervisores = {};
    }
    
    const asesoresSeleccionados = new Set();
    const supervisoresSeleccionados = new Set();
    let mesesAMostrar = 6;
    let tipoGrafica = 'both';
    let chartInstance = null;
    let chartInstanceSupervisores = null;

    // CORRECCI√ìN: Verificar que los datos est√©n disponibles
    function inicializarDatos() {
        console.log("üîç Inicializando datos...");
        
        if (Object.keys(datosMeses).length === 0) {
            console.warn("‚ö†Ô∏è No hay datos disponibles en datosMeses");
            return false;
        }
        
        if (Object.keys(datosSupervisores).length === 0) {
            console.warn("‚ö†Ô∏è No hay datos disponibles en datosSupervisores");
        }
        
        return true;
    }

    // NUEVA FUNCI√ìN: Filtrar por supervisor
    function filtrarPorSupervisor(supervisor) {
        document.querySelectorAll('.boton-supervisor').forEach(boton => {
        boton.classList.remove('activo');
        });
        
        event.target.classList.add('activo');
        
        const mesSeleccionado = document.getElementById('selectorMes').value;
        const a√±oSeleccionado = document.getElementById('selectorA√±o').value;
        const periodoCompleto = `${mesSeleccionado}_${a√±oSeleccionado}`;
        
        // Verificar si existe datos para este periodo
        if (!datosMeses[periodoCompleto]) {
            alert('No hay datos disponibles para ' + periodoCompleto.replace('_', ' '));
            return;
        }
        
        // Obtener todos los asesores del periodo
        let asesores = datosMeses[periodoCompleto] || [];
        
        // Filtrar por supervisor si no es "TODOS"
        if (supervisor !== 'TODOS') {
            asesores = asesores.filter(a => a.supervisor === supervisor);
        }
        
        // Actualizar cada lista
        actualizarLista(asesores, '>100%', 'lista-100');
        actualizarLista(asesores, '>70%', 'lista-70');
        actualizarLista(asesores, '>40%', 'lista-40');
        actualizarLista(asesores, '>0%', 'lista-0');
        
        // Actualizar estad√≠sticas
        actualizarEstadisticas(asesores);
    }
    
    function actualizarPeriodo() {
        const mesSeleccionado = document.getElementById('selectorMes').value;
        const a√±oSeleccionado = document.getElementById('selectorA√±o').value;
        const periodoCompleto = `${mesSeleccionado}_${a√±oSeleccionado}`;
        
        if (!datosMeses[periodoCompleto]) {
            alert('No hay datos disponibles para ' + periodoCompleto.replace('_', ' '));
            return;
        }
        
        const asesores = datosMeses[periodoCompleto] || [];
        
        // Actualizar botones de supervisores
        actualizarBotonesSupervisores(asesores);
        
        // Actualizar cada lista
        actualizarLista(asesores, '>100%', 'lista-100');
        actualizarLista(asesores, '>70%', 'lista-70');
        actualizarLista(asesores, '>40%', 'lista-40');
        actualizarLista(asesores, '>0%', 'lista-0');
        
        // Actualizar estad√≠sticas
        actualizarEstadisticas(asesores);
        
        // NUEVO: SIEMPRE actualizar la vista detalle si est√° visible
        const vistaDetalle = document.getElementById('vistaDetalle');
        if (vistaDetalle.style.display === 'block') {
            actualizarVistaDetalle();
        }
    }

    // NUEVA FUNCI√ìN: Actualizar botones de supervisores
    function actualizarBotonesSupervisores(asesores) {
        // Obtener supervisores √∫nicos del mes actual
        const supervisores = [...new Set(asesores.map(a => a.supervisor).filter(s => s))].sort();
        
        const contenedorBotones = document.querySelector('.botones-supervisores');
        
        // Crear HTML de botones
        let botonesHTML = `
            <button class="boton-supervisor todos activo" onclick="filtrarPorSupervisor('TODOS')">
                üë• TODOS LOS SUPERVISORES
            </button>
        `;
        
        supervisores.forEach(supervisor => {
            botonesHTML += `
                <button class="boton-supervisor" onclick="filtrarPorSupervisor('${supervisor}')">
                    ${supervisor}
                </button>
            `;
        });
        
        contenedorBotones.innerHTML = botonesHTML;
    }

    function actualizarLista(asesores, clasificacion, idLista) {
        const lista = document.getElementById(idLista);
        const asesoresFiltrados = asesores.filter(a => a.clasificacion === clasificacion);
        
        if (asesoresFiltrados.length === 0) {
            lista.innerHTML = '<div class="asesor-item">No hay asesores en esta categor√≠a</div>';
            return;
        }
        
        // Ordenar por porcentaje (mayor a menor)
        asesoresFiltrados.sort((a, b) => b.porcentaje - a.porcentaje);
        
        let html = '';
        asesoresFiltrados.forEach(asesor => {
            const claseGradiente = `gradiente-${clasificacion.replace('%', '').replace('>', '')}`;
            const clasePorcentaje = `porcentaje-${clasificacion.replace('%', '').replace('>', '')}`;
            html += `<div class="asesor-item ${claseGradiente}">
                <div class="asesor-nombre">${asesor.nombre}</div>
                <div class="asesor-porcentaje ${clasePorcentaje}">${asesor.porcentaje}%</div>
            </div>`;
        });
        
        lista.innerHTML = html;
    }
    
    function actualizarEstadisticas(asesores) {
        const contadores = {
            ">100%": asesores.filter(a => a.clasificacion === ">100%").length,
            ">70%": asesores.filter(a => a.clasificacion === ">70%").length,
            ">40%": asesores.filter(a => a.clasificacion === ">40%").length,
            ">0%": asesores.filter(a => a.clasificacion === ">0%").length
        };
        
        document.getElementById('cantidad-100').textContent = contadores[">100%"];
        document.getElementById('cantidad-70').textContent = contadores[">70%"];
        document.getElementById('cantidad-40').textContent = contadores[">40%"];
        document.getElementById('cantidad-0').textContent = contadores[">0%"];
    }
    
    // ========== FUNCIONES PARA ASESORES ==========
    function agregarAsesor() {
        const input = document.getElementById('inputBusqueda');
        const nombreAsesor = input.value.trim();
        
        if (nombreAsesor && !asesoresSeleccionados.has(nombreAsesor)) {
            asesoresSeleccionados.add(nombreAsesor);
            actualizarAsesoresSeleccionados();
            input.value = '';
        }
    }
    
    function eliminarAsesor(nombre) {
        asesoresSeleccionados.delete(nombre);
        actualizarAsesoresSeleccionados();
    }
    
    function actualizarAsesoresSeleccionados() {
        const container = document.getElementById('asesoresSeleccionados');
        container.innerHTML = '';
        
        asesoresSeleccionados.forEach(asesor => {
            const tag = document.createElement('div');
            tag.className = 'tag-asesor';
            tag.innerHTML = `
                ${asesor}
                <button class="eliminar-asesor" onclick="eliminarAsesor('${asesor}')">√ó</button>
            `;
            container.appendChild(tag);
        });
    }
    
    function cambiarVistaComparacion(cantidadMeses) {
        mesesAMostrar = cantidadMeses;
        
        // Actualizar botones activos
        document.querySelectorAll('.busqueda-asesores .btn-comparacion').forEach(btn => {
            btn.classList.remove('activo');
        });
        event.target.classList.add('activo');
        
        // Regenerar tabla si ya hay asesores seleccionados
        if (asesoresSeleccionados.size > 0) {
            compararAsesores();
        }
    }
    
    function compararAsesores() {
        if (asesoresSeleccionados.size === 0) {
            alert('Por favor selecciona al menos un asesor para comparar.');
            return;
        }
    
        const resultadosDiv = document.getElementById('resultadosComparacion');
        const tablaDiv = document.getElementById('tablaComparacion');
        const graficaDiv = document.getElementById('graficaComparacion');
    
        // Obtener meses ordenados (m√°s antiguo primero) - NUEVO ORDEN
        let mesesOrdenados = Object.keys(datosMeses).sort((a, b) => {
            const [mesA, a√±oA] = a.split('_');
            const [mesB, a√±oB] = b.split('_');
            const fechaA = new Date(a√±oA, obtenerNumeroMes(mesA));
            const fechaB = new Date(a√±oB, obtenerNumeroMes(mesB));
            return fechaA - fechaB; // ‚Üê CAMBIO: Orden ascendente (m√°s antiguo primero)
        });
    
        // Filtrar por cantidad de meses
        if (mesesAMostrar > 0 && mesesOrdenados.length > mesesAMostrar) {
            // Tomar los √∫ltimos N meses (m√°s recientes)
            mesesOrdenados = mesesOrdenados.slice(-mesesAMostrar);
        }
    
        // NO invertir el orden para la gr√°fica (ya est√° en orden ascendente)
        const mesesParaGrafica = [...mesesOrdenados]; // ‚Üê QUITAMOS .reverse()
    
        // Crear tabla de comparaci√≥n
        let html = '<table class="tabla-comparacion">';
        
        // Encabezado con meses (ya en orden cronol√≥gico)
        html += '<tr><th class="mes-header">Asesor</th>';
        mesesOrdenados.forEach(mes => {
            html += `<th class="mes-header">${mes.replace('_', ' ')}</th>`;
        });
        html += '</tr>';
    
        // Filas por cada asesor
        asesoresSeleccionados.forEach(asesor => {
            html += `<tr><td class="asesor-name">${asesor}</td>`;
        
            mesesOrdenados.forEach(mes => {
                const datosMes = datosMeses[mes];
                const asesorData = datosMes.find(a => a.nombre === asesor);
            
                if (asesorData) {
                    const clasePorcentaje = `porcentaje-tabla porcentaje-${asesorData.clasificacion.replace('%', '').replace('>', '')}`;
                    html += `<td><span class="${clasePorcentaje}">${asesorData.porcentaje}%</span></td>`;
                } else {
                    html += '<td class="sin-participacion">No particip√≥</td>';
                }
            });
        
            html += '</tr>';
        });
    
        html += '</table>';
        tablaDiv.innerHTML = html;
        
        // GENERAR LA GR√ÅFICA (ya est√° en orden ascendente)
        generarGraficaDesempenio(mesesParaGrafica, Array.from(asesoresSeleccionados));
        
        resultadosDiv.style.display = 'block';
        graficaDiv.style.display = 'block';
    }
    
    function limpiarBusqueda() {
        asesoresSeleccionados.clear();
        actualizarAsesoresSeleccionados();
        
        // DESTRUIR GR√ÅFICA AL LIMPIAR
        if (chartInstance) {
            chartInstance.destroy();
            chartInstance = null;
        }
        
        const canvas = document.getElementById('graficaDesempenio');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        document.getElementById('resultadosComparacion').style.display = 'none';
        document.getElementById('inputBusqueda').value = '';
    }
    
    // ========== NUEVAS FUNCIONES PARA SUPERVISORES ==========
    function agregarSupervisor() {
        const input = document.getElementById('inputBusquedaSupervisor');
        const nombreSupervisor = input.value.trim();
        
        if (nombreSupervisor && !supervisoresSeleccionados.has(nombreSupervisor)) {
            supervisoresSeleccionados.add(nombreSupervisor);
            actualizarSupervisoresSeleccionados();
            input.value = '';
        }
    }
    
    function eliminarSupervisor(nombre) {
        supervisoresSeleccionados.delete(nombre);
        actualizarSupervisoresSeleccionados();
    }
    
    function actualizarSupervisoresSeleccionados() {
        const container = document.getElementById('supervisoresSeleccionados');
        container.innerHTML = '';
        
        supervisoresSeleccionados.forEach(supervisor => {
            const tag = document.createElement('div');
            tag.className = 'tag-supervisor';
            tag.innerHTML = `
                ${supervisor}
                <button class="eliminar-supervisor" onclick="eliminarSupervisor('${supervisor}')">√ó</button>
            `;
            container.appendChild(tag);
        });
    }
    
    function cambiarVistaComparacionSupervisores(cantidadMeses) {
        mesesAMostrar = cantidadMeses;
        
        // Actualizar botones activos
        document.querySelectorAll('.busqueda-supervisores .btn-comparacion').forEach(btn => {
            btn.classList.remove('activo');
        });
        event.target.classList.add('activo');
        
        // Regenerar tabla si ya hay supervisores seleccionados
        if (supervisoresSeleccionados.size > 0) {
            compararSupervisores();
        }
    }
    
    function compararSupervisores() {
        if (supervisoresSeleccionados.size === 0) {
            alert('Por favor selecciona al menos un supervisor para comparar.');
            return;
        }
    
        const resultadosDiv = document.getElementById('resultadosComparacionSupervisores');
        const tablaDiv = document.getElementById('tablaComparacionSupervisores');
        const graficaDiv = document.getElementById('graficaComparacionSupervisores');
    
        // Obtener meses ordenados (m√°s antiguo primero) - NUEVO ORDEN
        let mesesOrdenados = Object.keys(datosMeses).sort((a, b) => {
            const [mesA, a√±oA] = a.split('_');
            const [mesB, a√±oB] = b.split('_');
            const fechaA = new Date(a√±oA, obtenerNumeroMes(mesA));
            const fechaB = new Date(a√±oB, obtenerNumeroMes(mesB));
            return fechaA - fechaB; // ‚Üê CAMBIO: Orden ascendente
        });
    
        // Filtrar por cantidad de meses
        if (mesesAMostrar > 0 && mesesOrdenados.length > mesesAMostrar) {
            // Tomar los √∫ltimos N meses (m√°s recientes)
            mesesOrdenados = mesesOrdenados.slice(-mesesAMostrar);
        }
    
        // NO invertir el orden para la gr√°fica
        const mesesParaGrafica = [...mesesOrdenados]; // ‚Üê QUITAMOS .reverse()
    
        // Crear tabla de comparaci√≥n para supervisores MEJORADA
        let html = '<table class="tabla-comparacion">';
        
        // Encabezado con meses
        html += '<tr><th class="mes-header">Supervisor</th>';
        mesesOrdenados.forEach(mes => {
            html += `<th class="mes-header">${mes.replace('_', ' ')}</th>`;
        });
        html += '</tr>';

        // ORDENAR SUPERVISORES DE MAYOR A MENOR POR PORCENTAJE DEL MES M√ÅS RECIENTE
        const supervisoresOrdenados = Array.from(supervisoresSeleccionados).sort((a, b) => {
            // Obtener datos del mes m√°s reciente para cada supervisor
            const mesMasReciente = mesesOrdenados[mesesOrdenados.length - 1];
            const datosA = datosSupervisores[a] && datosSupervisores[a][mesMasReciente];
            const datosB = datosSupervisores[b] && datosSupervisores[b][mesMasReciente];
            
            const porcentajeA = datosA ? datosA.porcentaje_vs_meta_super : 0;
            const porcentajeB = datosB ? datosB.porcentaje_vs_meta_super : 0;
            
            return porcentajeB - porcentajeA; // Orden descendente (mayor a menor)
        });
        
        // Filas por cada supervisor ORDENADO
        supervisoresOrdenados.forEach((supervisor, index) => {
            html += `<tr><td class="supervisor-name">${supervisor}</td>`;
            
            mesesOrdenados.forEach(mes => {
                const datosSupervisor = datosSupervisores[supervisor];
                if (datosSupervisor && datosSupervisor[mes]) {
                    const datosMes = datosSupervisor[mes];
                    const clasePorcentaje = `porcentaje-tabla porcentaje-${datosMes.clasificacion.replace('%', '').replace('>', '')}`;
                    
                    html += `<td>
                        <span class="${clasePorcentaje}">
                            ${datosMes.porcentaje_vs_meta_super.toFixed(1)}%
                        </span>
                        <br>
                        <small style="font-size: 0.7rem; color: #666;">
                            ${datosMes.cantidad_asesores} ases.
                        </small>
                        <br>
                        <small style="font-size: 0.65rem; color: #888;">
                            Meta: S/ ${datosMes.meta_super.toFixed(0)}
                        </small>
                        <br>
                        <div style="font-size: 0.8rem; color: #2c3e50; font-weight: bold; margin-top: 3px;">
                            ${datosMes.cartera}
                        </div>
                    </td>`;
                } else {
                    html += '<td class="sin-participacion">Sin datos</td>';
                }
            });
            
            html += '</tr>';
        });
    
        html += '</table>';
        tablaDiv.innerHTML = html;
        
        // GENERAR LA GR√ÅFICA PARA SUPERVISORES
        generarGraficaDesempenioSupervisores(mesesParaGrafica, Array.from(supervisoresSeleccionados));
        
        resultadosDiv.style.display = 'block';
        graficaDiv.style.display = 'block';
    }
    
    function limpiarBusquedaSupervisores() {
        supervisoresSeleccionados.clear();
        actualizarSupervisoresSeleccionados();
        
        // DESTRUIR GR√ÅFICA AL LIMPIAR
        if (chartInstanceSupervisores) {
            chartInstanceSupervisores.destroy();
            chartInstanceSupervisores = null;
        }
        
        const canvas = document.getElementById('graficaDesempenioSupervisores');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        document.getElementById('resultadosComparacionSupervisores').style.display = 'none';
        document.getElementById('inputBusquedaSupervisor').value = '';
    }
    
    // Variables para Periodo de Prueba
    const asesoresSeleccionadosPeriodo = new Set();
    
    // Funciones para Periodo de Prueba
    function agregarAsesorPeriodo() {
        const input = document.getElementById('inputBusquedaPeriodo');
        const nombreAsesor = input.value.trim();
        
        if (nombreAsesor && !asesoresSeleccionadosPeriodo.has(nombreAsesor)) {
            asesoresSeleccionadosPeriodo.add(nombreAsesor);
            actualizarAsesoresSeleccionadosPeriodo();
            input.value = '';
        }
    }
    
    function eliminarAsesorPeriodo(nombre) {
        asesoresSeleccionadosPeriodo.delete(nombre);
        actualizarAsesoresSeleccionadosPeriodo();
    }
    
    function actualizarAsesoresSeleccionadosPeriodo() {
        const container = document.getElementById('asesoresSeleccionadosPeriodo');
        container.innerHTML = '';
        
        asesoresSeleccionadosPeriodo.forEach(asesor => {
            const tag = document.createElement('div');
            tag.className = 'tag-asesor';
            tag.innerHTML = `
                ${asesor}
                <button class="eliminar-asesor" onclick="eliminarAsesorPeriodo('${asesor}')">√ó</button>
            `;
            container.appendChild(tag);
        });
    }
    
    function seleccionarTodosAsesoresPeriodo() {
        // Obtener todos los asesores √∫nicos de todos los meses
        const todosAsesores = new Set();
        Object.values(datosMeses).forEach(mesData => {
            mesData.forEach(asesor => {
                todosAsesores.add(asesor.nombre);
            });
        });
        
        asesoresSeleccionadosPeriodo.clear();
        todosAsesores.forEach(asesor => {
            asesoresSeleccionadosPeriodo.add(asesor);
        });
        actualizarAsesoresSeleccionadosPeriodo();
    }
    
    function limpiarPeriodoPrueba() {
        document.getElementById('mes1').value = '';
        document.getElementById('a√±o1').value = '';
        document.getElementById('mes2').value = '';
        document.getElementById('a√±o2').value = '';
        document.getElementById('porcentajeMinimo').value = '70';
        document.getElementById('inputBusquedaPeriodo').value = '';
        asesoresSeleccionadosPeriodo.clear();
        actualizarAsesoresSeleccionadosPeriodo();
        document.getElementById('resultadosPeriodo').style.display = 'none';
    }
    
    function calcularPeriodoPrueba() {
        const mes1 = document.getElementById('mes1').value;
        const a√±o1 = document.getElementById('a√±o1').value;
        const mes2 = document.getElementById('mes2').value;
        const a√±o2 = document.getElementById('a√±o2').value;
        const porcentajeMinimo = parseFloat(document.getElementById('porcentajeMinimo').value) || 70;
        
        if (!mes1 || !a√±o1 || !mes2 || !a√±o2) {
            alert('Por favor selecciona ambos meses y a√±os para calcular el periodo de prueba.');
            return;
        }
        
        const periodo1 = `${mes1}_${a√±o1}`;
        const periodo2 = `${mes2}_${a√±o2}`;
        
        if (!datosMeses[periodo1] || !datosMeses[periodo2]) {
            alert('No hay datos disponibles para uno de los periodos seleccionados.');
            return;
        }
        
        const resultadosDiv = document.getElementById('resultadosPeriodo');
        const tablaDiv = document.getElementById('tablaPeriodo');
        
        // Obtener asesores a evaluar (seleccionados o todos)
        const asesoresAEvaluar = asesoresSeleccionadosPeriodo.size > 0 ? 
            Array.from(asesoresSeleccionadosPeriodo) : 
            [...new Set([...datosMeses[periodo1].map(a => a.nombre), ...datosMeses[periodo2].map(a => a.nombre)])];
        
        let html = '<table class="tabla-periodo">';
        html += '<tr><th>Asesor</th><th>Periodo 1</th><th>Periodo 2</th><th>Total Recupero</th><th>Total Meta</th><th>% Periodo Prueba</th><th>Estado</th><th>Falta Recuperar</th></tr>';
        
        asesoresAEvaluar.forEach(asesor => {
            const data1 = datosMeses[periodo1].find(a => a.nombre === asesor);
            const data2 = datosMeses[periodo2].find(a => a.nombre === asesor);
            
            if (data1 && data2 && data1.recupero !== undefined && data1.meta !== undefined && 
                data2.recupero !== undefined && data2.meta !== undefined) {
                
                const totalRecupero = data1.recupero + data2.recupero;
                const totalMeta = data1.meta + data2.meta;
                const porcentajePrueba = totalMeta > 0 ? (totalRecupero / totalMeta) * 100 : 0;
                const porcentajeFormateado = porcentajePrueba.toFixed(2);
                
                const estado = porcentajePrueba >= porcentajeMinimo ? 
                    '<span class="estado-aprobado">‚úì Supera</span>' : 
                    '<span class="estado-reprobado">‚úó No supera</span>';
                
                const faltaRecuperar = porcentajePrueba < porcentajeMinimo ? 
                    (totalMeta * (porcentajeMinimo / 100) - totalRecupero).toFixed(2) : '0';
                
                html += `<tr>
                    <td>${asesor}</td>
                    <td>${data1.recupero} / ${data1.meta}</td>
                    <td>${data2.recupero} / ${data2.meta}</td>
                    <td><strong>${totalRecupero.toFixed(2)}</strong></td>
                    <td><strong>${totalMeta.toFixed(2)}</strong></td>
                    <td><strong>${porcentajeFormateado}%</strong></td>
                    <td>${estado}</td>
                    <td>${faltaRecuperar}</td>
                </tr>`;
            }
        });
        
        html += '</table>';
        tablaDiv.innerHTML = html;
        resultadosDiv.style.display = 'block';
    }
    
    // Permitir agregar asesor con Enter en el periodo de prueba
    document.getElementById('inputBusquedaPeriodo').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            agregarAsesorPeriodo();
        }
    });
    
    function obtenerNumeroMes(mes) {
        const meses = {
            'ENERO': 0, 'FEBRERO': 1, 'MARZO': 2, 'ABRIL': 3, 'MAYO': 4, 'JUNIO': 5,
            'JULIO': 6, 'AGOSTO': 7, 'SETIEMBRE': 8, 'SEPTIEMBRE': 8, 
            'OCTUBRE': 9, 'NOVIEMBRE': 10, 'DICIEMBRE': 11
        };
        return meses[mes.toUpperCase()] || 0;
    }
    
    // Permitir agregar asesor con Enter
    document.getElementById('inputBusqueda').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            agregarAsesor();
        }
    });

    // Permitir agregar supervisor con Enter
    document.getElementById('inputBusquedaSupervisor').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            agregarSupervisor();
        }
    });

    function mostrarVistaDetalle() {
        
        const vistaDetalle = document.getElementById('vistaDetalle');
        const contenidoPrincipal = document.getElementById('contenidoPrincipal');
        const botonesSupervisores = document.querySelector('.botones-supervisores');
        
        if (vistaDetalle.style.display === 'none' || vistaDetalle.style.display === '') {
            vistaDetalle.style.display = 'block';
            contenidoPrincipal.style.display = 'none';
            botonesSupervisores.style.display = 'none';
            actualizarVistaDetalle();
        } else {
            vistaDetalle.style.display = 'none';
            contenidoPrincipal.style.display = 'block';
            botonesSupervisores.style.display = 'flex';
        }
    }
    
    function actualizarVistaDetalle() {
        const vistaDetalle = document.getElementById('vistaDetalle');
        const contenidoPrincipal = document.getElementById('contenidoPrincipal');
        const botonesSupervisores = document.querySelector('.botones-supervisores');
        
        if (vistaDetalle.style.display === 'none' || vistaDetalle.style.display === '') {
            vistaDetalle.style.display = 'block';
            contenidoPrincipal.style.display = 'none';
            botonesSupervisores.style.display = 'none';
            generarGraficaCombinadaTotal();
        } else {
            vistaDetalle.style.display = 'none';
            contenidoPrincipal.style.display = 'block';
            botonesSupervisores.style.display = 'flex';
        }
    }

    function generarGraficaCombinadaTotal() {
        const mesSeleccionado = document.getElementById('selectorMes').value;
        const a√±oSeleccionado = document.getElementById('selectorA√±o').value;
        const periodoCompleto = `${mesSeleccionado}_${a√±oSeleccionado}`;
        
        if (!datosMeses[periodoCompleto]) {
            console.log("‚ùå NO HAY DATOS para:", periodoCompleto);
            return;
        }
        
        const asesores = datosMeses[periodoCompleto] || [];
        const totalAsesores = asesores.length; // <-- DEFINIR AQU√ç LA VARIABLE
        
        // 1. OBTENER TODAS LAS FECHAS Y RECUPERO DIARIO TOTAL
        const todasFechas = new Set();
        const recuperoDiarioPorFecha = {}; // diccionario para recupero diario por fecha
        
        // Recopilar todos los datos diarios de todos los asesores
        asesores.forEach(asesor => {
            const datosDiarios = asesor.datos_diarios_asesor || {};
            
            Object.keys(datosDiarios).forEach(fecha => {
                todasFechas.add(fecha);
                
                if (!recuperoDiarioPorFecha[fecha]) {
                    recuperoDiarioPorFecha[fecha] = 0;
                }
                recuperoDiarioPorFecha[fecha] += datosDiarios[fecha] || 0;
            });
        });
        
        // 2. CALCULAR META TOTAL DEL MES
        // Sumar metas individuales de todos los asesores
        const metaTotal = asesores.reduce((total, asesor) => total + (asesor.meta || 0), 0);
        
        // 3. ORDENAR FECHAS CRONOL√ìGICAMENTE
        const fechasOrdenadas = Array.from(todasFechas).sort((a, b) => {
            return convertirFechaDiaria(a) - convertirFechaDiaria(b);
        });
        
        if (fechasOrdenadas.length === 0) {
            alert("No hay datos diarios disponibles para este mes");
            return;
        }
        
        console.log("üìä Datos para gr√°fica combinada total:", {
            totalAsesores: asesores.length,
            totalFechas: fechasOrdenadas.length,
            metaTotal: metaTotal,
            fechas: fechasOrdenadas
        });
        
        // 4. CALCULAR DATOS PARA EL GR√ÅFICO
        let recuperoAcumuladoTotal = 0;
        const datosRecuperoDiario = [];      // Barras: recupero diario TOTAL
        const datosRecuperoAcumulado = [];   // L√≠nea punteada: recupero acumulado TOTAL
        const datosAlcanceAcumulado = [];    // L√≠nea principal: % alcance acumulado TOTAL
        
        fechasOrdenadas.forEach(fecha => {
            const recuperoDia = recuperoDiarioPorFecha[fecha] || 0;
            
            // Recupero diario TOTAL (para barras)
            datosRecuperoDiario.push(recuperoDia);
            
            // Acumular recupero TOTAL
            recuperoAcumuladoTotal += recuperoDia;
            datosRecuperoAcumulado.push(recuperoAcumuladoTotal);
            
            // Calcular porcentaje de alcance TOTAL
            const porcentajeAlcance = metaTotal > 0 ? (recuperoAcumuladoTotal / metaTotal) * 100 : 0;
            datosAlcanceAcumulado.push(porcentajeAlcance);
        });
        
        // 5. GENERAR EL GR√ÅFICO COMBINADO
        generarGraficaCombinadaTotalReal(
            fechasOrdenadas,
            datosRecuperoDiario,
            datosRecuperoAcumulado,
            datosAlcanceAcumulado,
            metaTotal,
            totalAsesores  // <-- PASARLA COMO PAR√ÅMETRO
        );
    }

    function generarGraficaCombinadaTotalReal(fechas, recuperoDiario, recuperoAcumulado, alcanceAcumulado, metaTotal, totalAsesores) {
        const canvas = document.getElementById('graficaTendenciaDiaria');
        const ctx = canvas.getContext('2d');
        
        // Destruir gr√°fica anterior si existe
        if (chartTendencia) {
            chartTendencia.destroy();
            chartTendencia = null;
        }
        
        // Formatear valores para mostrar
        const metaFormateada = metaTotal.toLocaleString('es-PE', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        
        // Crear datasets
        const datasets = [
            // BARRAS: Recupero diario TOTAL (todos los asesores)
            {
                label: 'üí∞ Recupero Diario Total',
                data: recuperoDiario,
                type: 'bar',
                backgroundColor: 'rgba(52, 152, 219, 0.7)',
                borderColor: 'rgba(52, 152, 219, 1)',
                borderWidth: 1,
                borderRadius: 4,
                borderSkipped: false,
                yAxisID: 'y1', // Usar eje derecho para montos
                order: 3
            },
            
            // L√çNEA PUNTEADA: Recupero acumulado TOTAL (S/)
            {
                label: 'üìà Recupero Acumulado Total',
                data: recuperoAcumulado,
                type: 'line',
                borderColor: '#e74c3c',
                backgroundColor: 'transparent',
                borderWidth: 2,
                borderDash: [5, 5],
                fill: false,
                tension: 0.4,
                yAxisID: 'y1',
                pointRadius: 0,
                pointHoverRadius: 0,
                order: 2
            },
            
            // L√çNEA PRINCIPAL: % Alcance acumulado TOTAL
            {
                label: 'üéØ % Alcance Acumulado Total',
                data: alcanceAcumulado,
                type: 'line',
                borderColor: '#2ecc71',
                backgroundColor: 'rgba(46, 204, 113, 0.1)',
                borderWidth: 4,
                fill: false,
                tension: 0.4,
                yAxisID: 'y', // Usar eje izquierdo para porcentajes
                pointRadius: 5,
                pointHoverRadius: 8,
                pointBackgroundColor: '#2ecc71',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                order: 1
            },
            
            // L√çNEA DE META 100%
            {
                label: 'Meta 100%',
                data: Array(fechas.length).fill(100),
                type: 'line',
                borderColor: '#f39c12',
                backgroundColor: 'transparent',
                borderWidth: 2,
                borderDash: [10, 5],
                fill: false,
                tension: 0,
                yAxisID: 'y',
                pointRadius: 0,
                pointHoverRadius: 0,
                order: 0
            }
        ];
        
        // NUEVO: Crear un dataset para el promedio diario (l√≠nea suave)
        if (fechas.length > 1) {
            // Calcular promedio m√≥vil simple (3 d√≠as)
            const promedioMovil = [];
            for (let i = 0; i < recuperoDiario.length; i++) {
                let suma = 0;
                let count = 0;
                
                // Promedio de 3 d√≠as (actual, anterior, siguiente si existen)
                for (let j = Math.max(0, i - 1); j <= Math.min(recuperoDiario.length - 1, i + 1); j++) {
                    suma += recuperoDiario[j];
                    count++;
                }
                promedioMovil.push(suma / count);
            }
            
            datasets.push({
                label: 'üìä Promedio M√≥vil (3 d√≠as)',
                data: promedioMovil,
                type: 'line',
                borderColor: '#9b59b6',
                backgroundColor: 'transparent',
                borderWidth: 2,
                borderDash: [3, 3],
                fill: false,
                tension: 0.4,
                yAxisID: 'y1',
                pointRadius: 0,
                pointHoverRadius: 0,
                order: 4
            });
        }
        
        // Configurar tooltips avanzados
        chartTendencia = new Chart(ctx, {
            type: 'line',
            data: {
                labels: fechas,
                datasets: datasets
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    title: {
                        display: true,
                        text: `üìä Evoluci√≥n Diaria - TOTAL (${totalAsesores} asesores)`,  // <-- totalAsesores es el par√°metro
                        font: { size: 18, weight: 'bold' },
                        padding: { top: 10, bottom: 30 }
                    },
                    subtitle: {
                        display: true,
                        text: `Meta Total del Mes: S/ ${metaFormateada}`,
                        font: { size: 14, color: '#7f8c8d' },
                        padding: { bottom: 20 }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0, 0, 0, 0.85)',
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 13 },
                        padding: 15,
                        cornerRadius: 8,
                        callbacks: {
                            title: function(context) {
                                return `D√≠a: ${context[0].label}`;
                            },
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.parsed.y;
                                
                                if (label.includes('% Alcance')) {
                                    return `${label}: ${value.toFixed(1)}%`;
                                } else if (label.includes('Recupero') || label.includes('Promedio')) {
                                    return `${label}: S/ ${value.toLocaleString('es-PE', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    })}`;
                                }
                                return `${label}: ${value}`;
                            },
                            afterBody: function(context) {
                                const index = context[0].dataIndex;
                                const recuperoDia = recuperoDiario[index];
                                const recuperoAcum = recuperoAcumulado[index];
                                const alcance = alcanceAcumulado[index];
                                
                                // Calcular tendencia
                                let tendencia = '';
                                if (index > 0) {
                                    const recuperoAyer = recuperoDiario[index - 1];
                                    const diferencia = recuperoDia - recuperoAyer;
                                    const porcentajeCambio = recuperoAyer > 0 ? (diferencia / recuperoAyer * 100) : 100;
                                    
                                    if (diferencia > 0) {
                                        tendencia = `üìà +${porcentajeCambio.toFixed(1)}% vs ayer`;
                                    } else if (diferencia < 0) {
                                        tendencia = `üìâ ${porcentajeCambio.toFixed(1)}% vs ayer`;
                                    } else {
                                        tendencia = `‚û°Ô∏è Sin cambio vs ayer`;
                                    }
                                }
                                
                                return [
                                    '---',
                                    `Recupero del d√≠a: S/ ${recuperoDia.toLocaleString('es-PE', {
                                    `Recupero del d√≠a: S/ ${recuperoDia.toLocaleString('es-PE', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    })}`,
                                    `Recupero acumulado: S/ ${recuperoAcum.toLocaleString('es-PE', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    })}`,
                                    `Alcance acumulado: ${alcance.toFixed(1)}%`,
                                    `Meta restante: S/ ${(metaTotal - recuperoAcum).toLocaleString('es-PE', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    })}`,
                                    tendencia
                                ];
                            }
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            font: { size: 12, weight: 'bold' },
                            usePointStyle: true,
                            boxWidth: 12,
                            padding: 20
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'D√≠as del Mes',
                            font: { size: 14, weight: 'bold' }
                        },
                        ticks: {
                            font: { size: 12 },
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        // Eje izquierdo: Porcentajes
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: '% Alcance Acumulado',
                            font: { size: 14, weight: 'bold' }
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            },
                            font: { size: 12 }
                        },
                        min: 0,
                        suggestedMax: 120,
                        grid: {
                            drawBorder: true
                        }
                    },
                    y1: {
                        // Eje derecho: Montos en soles
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Recupero (S/)',
                            font: { size: 14, weight: 'bold' }
                        },
                        ticks: {
                            callback: function(value) {
                                return 'S/ ' + value.toLocaleString('es-PE', {
                                    minimumFractionDigits: 0,
                                    maximumFractionDigits: 0
                                });
                            },
                            font: { size: 12 }
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });
    }
    
    function calcularEstadisticasDetalle(asesores) {
        const totalAsesores = asesores.length;
        
        // Obtener supervisores √∫nicos
        const supervisoresUnicos = [...new Set(asesores.map(a => a.supervisor))];
        const totalSupervisores = supervisoresUnicos.filter(s => s && s !== 'Sin Supervisor').length;
        
        // Recupero de asesores (suma individual)
        const recuperoAsesores = asesores.reduce((sum, asesor) => sum + (asesor.recupero || 0), 0);
        
        // Recupero total (suma de recupero_supervisor sin duplicados)
        let recuperoTotal = 0;
        const supervisoresProcesados = new Set();
        
        asesores.forEach(asesor => {
            const supervisor = asesor.supervisor;
            if (supervisor && supervisor !== 'Sin Supervisor' && !supervisoresProcesados.has(supervisor)) {
                recuperoTotal += asesor.recupero_supervisor || 0;
                supervisoresProcesados.add(supervisor);
            }
        });
        
        // Meta del mes (suma de metas de supervisores √∫nicos)
        let metaTotal = 0;
        const supervisoresMeta = new Set();
        
        asesores.forEach(asesor => {
            const supervisor = asesor.supervisor;
            if (supervisor && supervisor !== 'Sin Supervisor' && !supervisoresMeta.has(supervisor)) {
                metaTotal += asesor.meta_super || 0;
                supervisoresMeta.add(supervisor);
            }
        });
        
        // Si no hay metas de supervisor, usar suma de metas individuales
        if (metaTotal === 0) {
            metaTotal = asesores.reduce((sum, asesor) => sum + (asesor.meta || 0), 0);
        }
        
        // Calcular porcentajes
        const alcanceAsesores = metaTotal > 0 ? (recuperoAsesores / metaTotal) * 100 : 0;
        const alcanceTotal = metaTotal > 0 ? (recuperoTotal / metaTotal) * 100 : 0;
        
        // Formato de moneda
        const formatoMoneda = (valor) => {
            return 'S/ ' + valor.toLocaleString('es-PE', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        };
        
        // Generar HTML con estructura de tabla 2x4
        const html = `
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: #e0e0e0; border-radius: 8px; overflow: hidden;">
                
                <!-- COLUMNA 1: TOTALES -->
                <div style="background: #f8f9fa; padding: 15px; text-align: center;">
                    <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 5px;">TOTAL ASESORES</div>
                    <div style="font-size: 2rem; font-weight: bold; color: #2c3e50; margin-bottom: 15px;">${totalAsesores}</div>
                    
                    <div style="border-top: 1px dashed #ddd; padding-top: 15px;">
                        <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 5px;">TOTAL SUPERVISORES</div>
                        <div style="font-size: 2rem; font-weight: bold; color: #9b59b6;">${totalSupervisores}</div>
                    </div>
                </div>
                
                <!-- COLUMNA 2: RECUPERO -->
                <div style="background: #f8f9fa; padding: 15px; text-align: center;">
                    <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 5px;">RECUPERO ASESORES</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #27ae60; margin-bottom: 15px;">${formatoMoneda(recuperoAsesores)}</div>
                    
                    <div style="border-top: 1px dashed #ddd; padding-top: 15px;">
                        <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 5px;">RECUPERO TOTAL</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #2ecc71;">${formatoMoneda(recuperoTotal)}</div>
                    </div>
                </div>
                
                <!-- COLUMNA 3: META DEL MES (COMUN - OCUPA 2 FILAS) -->
                <div style="background: #fff9e6; padding: 15px; text-align: center; grid-row: span 2; display: flex; flex-direction: column; justify-content: center; border-left: 2px solid #f39c12; border-right: 2px solid #f39c12;">
                    <div style="font-size: 0.9rem; color: #d35400; margin-bottom: 10px; font-weight: bold;">META DEL MES</div>
                    <div style="font-size: 2.2rem; font-weight: bold; color: #e67e22;">${formatoMoneda(metaTotal)}</div>
                    <div style="margin-top: 20px; font-size: 0.8rem; color: #7f8c8d;">
                        Referencia com√∫n para asesores y supervisores
                    </div>
                </div>
                
                <!-- COLUMNA 4: ALCANCE -->
                <div style="background: #f8f9fa; padding: 15px; text-align: center;">
                    <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 5px;">ALCANCE ASESORES</div>
                    <div style="font-size: 1.8rem; font-weight: bold; color: #3498db; margin-bottom: 15px;">${alcanceAsesores.toFixed(1)}%</div>
                    
                    <div style="border-top: 1px dashed #ddd; padding-top: 15px;">
                        <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 5px;">ALCANCE TOTAL</div>
                        <div style="font-size: 1.8rem; font-weight: bold; color: #8e44ad;">${alcanceTotal.toFixed(1)}%</div>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('estadisticasDetalle').innerHTML = html;
    }
    
    // === FUNCIONES PARA GR√ÅFICAS DE ASESORES ===

    function generarGraficaDesempenio(meses, asesores) {
        const canvas = document.getElementById('graficaDesempenio');
        const ctx = canvas.getContext('2d');
        
        // Destruir gr√°fica anterior si existe
        if (chartInstance) {
            chartInstance.destroy();
            chartInstance = null;
        }
    
        // LIMPIAR EL CANVAS COMPLETAMENTE
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    
        // Preparar datos para la gr√°fica
        const datasets = [];
        const colores = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
            '#9966FF', '#FF9F40', '#8AC926', '#1982C4'
        ];
    
        asesores.forEach((asesor, index) => {
            const datosAsesor = [];
            const borderColor = colores[index % colores.length];
            
            meses.forEach(mes => {
                const datosMes = datosMeses[mes];
                const asesorData = datosMes.find(a => a.nombre === asesor);
                datosAsesor.push(asesorData ? asesorData.porcentaje : null);
            });
    
            datasets.push({
                label: asesor,
                data: datosAsesor,
                borderColor: borderColor,
                backgroundColor: borderColor + '20',
                borderWidth: 3,
                fill: tipoGrafica !== 'bar',
                tension: 0.4,
                pointRadius: 6,
                pointHoverRadius: 8,
                type: tipoGrafica === 'bar' ? 'bar' : 'line',
                // SOLUCI√ìN PARA "NO PARTICIP√ì"
                spanGaps: true, // Conecta los huecos autom√°ticamente
                segment: {
                    borderColor: ctx => {
                        const p0Null = ctx.p0.parsed.y === null;
                        const p1Null = ctx.p1.parsed.y === null;
                        return (p0Null || p1Null) ? borderColor + '60' : borderColor;
                    },
                    borderDash: ctx => {
                        const p0Null = ctx.p0.parsed.y === null;
                        const p1Null = ctx.p1.parsed.y === null;
                        return (p0Null || p1Null) ? [3, 3] : [];
                    }
                },
                pointBackgroundColor: datosAsesor.map(valor => 
                    valor === null ? '#95a5a6' : borderColor
                )
            });
        });
    
        // Formatear labels de meses para mejor visualizaci√≥n
        const labels = meses.map(mes => {
            const [mesNombre, a√±o] = mes.split('_');
            return `${mesNombre.substring(0, 3)} ${a√±o}`;
        });
    
        // Crear la gr√°fica con configuraci√≥n de tama√±o FIJO
        chartInstance = new Chart(ctx, {
            type: tipoGrafica === 'both' ? 'line' : tipoGrafica,
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Evoluci√≥n del Porcentaje de Alcance - Asesores',
                        font: { size: 16 }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        // === NUEVAS CONFIGURACIONES PARA AUMENTAR TAMA√ëO ===
                        backgroundColor: 'rgba(0, 0, 0, 0.8)', // Fondo m√°s oscuro
                        titleFont: {
                            size: 14, // Tama√±o de fuente del t√≠tulo
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13, // Tama√±o de fuente del cuerpo
                            weight: 'normal'
                        },
                        padding: 12, // Espaciado interno
                        cornerRadius: 8, // Bordes redondeados
                        // ================================================
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.parsed.y}%`;
                            }
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: { font: { size: 12 } },
                        onClick: function (e, legendItem, legend) {
                            const index = legendItem.datasetIndex;
                            const ci = legend.chart;
                            if (ci.isDatasetVisible(index)) {
                                ci.hide(index);
                            } else {
                                ci.show(index);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Porcentaje de Alcance (%)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Meses'
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    
        // FORZAR REDIMENSIONADO despu√©s de crear la gr√°fica
        setTimeout(() => {
            if (chartInstance) {
                chartInstance.resize();
            }
        }, 100);
    }
    
    function cambiarTipoGrafica(tipo) {
        tipoGrafica = tipo;
        
        // Actualizar botones activos
        document.querySelectorAll('.controles-grafica .btn-comparacion').forEach(btn => {
            btn.classList.remove('activo');
        });
        event.target.classList.add('activo');
        
        // Regenerar gr√°fica si hay datos
        if (asesoresSeleccionados.size > 0 && chartInstance) {
            const mesesOrdenados = Object.keys(datosMeses).sort((a, b) => {
                const [mesA, a√±oA] = a.split('_');
                const [mesB, a√±oB] = b.split('_');
                const fechaA = new Date(a√±oA, obtenerNumeroMes(mesA));
                const fechaB = new Date(a√±oB, obtenerNumeroMes(mesB));
                return fechaB - fechaA;
            });
            
            // NO excluir el mes actual - INCLUIRLO
            let mesesFiltrados = mesesOrdenados; // ‚Üê QUITAR el .slice(1)
            if (mesesAMostrar > 0 && mesesFiltrados.length > mesesAMostrar) {
                mesesFiltrados = mesesFiltrados.slice(0, mesesAMostrar);
            }
            
            const mesesParaGrafica = [...mesesFiltrados].reverse();
            generarGraficaDesempenio(mesesParaGrafica, Array.from(asesoresSeleccionados));
        }
    }

    // ========== FUNCI√ìN PARA GENERAR GR√ÅFICA DE SUPERVISORES ==========
    function generarGraficaDesempenioSupervisores(meses, supervisores) {
        const canvas = document.getElementById('graficaDesempenioSupervisores');
        const ctx = canvas.getContext('2d');
        
        // Destruir gr√°fica anterior si existe
        if (chartInstanceSupervisores) {
            chartInstanceSupervisores.destroy();
            chartInstanceSupervisores = null;
        }
    
        // LIMPIAR EL CANVAS COMPLETAMENTE
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    
        // Preparar datos para la gr√°fica
        const datasets = [];
        const colores = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
            '#9966FF', '#FF9F40', '#8AC926', '#1982C4'
        ];
    
        supervisores.forEach((supervisor, index) => {
            const datosSupervisor = [];
            const borderColor = colores[index % colores.length];
            
            meses.forEach(mes => {
                const datosSupervisorMes = datosSupervisores[supervisor];
                if (datosSupervisorMes && datosSupervisorMes[mes]) {
                    datosSupervisor.push(datosSupervisorMes[mes].porcentaje_vs_meta_super);
                } else {
                    datosSupervisor.push(null);
                }
            });
    
            datasets.push({
                label: supervisor,
                data: datosSupervisor,
                borderColor: borderColor,
                backgroundColor: borderColor + '20',
                borderWidth: 3,
                fill: tipoGrafica !== 'bar',
                tension: 0.4,
                pointRadius: 6,
                pointHoverRadius: 8,
                type: tipoGrafica === 'bar' ? 'bar' : 'line',
                spanGaps: true,
                segment: {
                    borderColor: ctx => {
                        const p0Null = ctx.p0.parsed.y === null;
                        const p1Null = ctx.p1.parsed.y === null;
                        return (p0Null || p1Null) ? borderColor + '60' : borderColor;
                    },
                    borderDash: ctx => {
                        const p0Null = ctx.p0.parsed.y === null;
                        const p1Null = ctx.p1.parsed.y === null;
                        return (p0Null || p1Null) ? [3, 3] : [];
                    }
                },
                pointBackgroundColor: datosSupervisor.map(valor => 
                    valor === null ? '#95a5a6' : borderColor
                )
            });
        });
    
        // Agregar l√≠nea de meta (100%)
        datasets.push({
            label: 'Meta (100%)',
            data: Array(meses.length).fill(100),
            borderColor: '#2ecc71',
            backgroundColor: 'transparent',
            borderWidth: 2,
            borderDash: [5, 5],
            pointRadius: 0,
            fill: false,
            tension: 0
        });
    
        // Formatear labels de meses para mejor visualizaci√≥n
        const labels = meses.map(mes => {
            const [mesNombre, a√±o] = mes.split('_');
            return `${mesNombre.substring(0, 3)} ${a√±o}`;
        });
    
        // Crear la gr√°fica
        chartInstanceSupervisores = new Chart(ctx, {
            type: tipoGrafica === 'both' ? 'line' : tipoGrafica,
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Evoluci√≥n del Porcentaje vs Meta Supervisor - Equipos',
                        font: { size: 16 }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13,
                            weight: 'normal'
                        },
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                const datasetLabel = context.dataset.label || '';
                                const value = context.parsed.y;
                                
                                // Buscar datos adicionales para mostrar en el tooltip
                                const mesIndex = context.dataIndex;
                                const mes = context.chart.data.labels[mesIndex];
                                const supervisor = datasetLabel;
                                
                                // Convertir mes abreviado a formato completo
                                const mesesMap = {
                                    'Ene': 'ENERO', 'Feb': 'FEBRERO', 'Mar': 'MARZO', 'Abr': 'ABRIL',
                                    'May': 'MAYO', 'Jun': 'JUNIO', 'Jul': 'JULIO', 'Ago': 'AGOSTO',
                                    'Sep': 'SETIEMBRE', 'Oct': 'OCTUBRE', 'Nov': 'NOVIEMBRE', 'Dic': 'DICIEMBRE'
                                };
                                
                                const [mesStr, a√±o] = mes.split(' ');
                                const mesCompleto = `${mesesMap[mesStr]}_${a√±o}`;
                                
                                // Encontrar datos del supervisor para este mes - REDONDEADO A 2 DECIMALES
                                let tooltipText = `${datasetLabel}: ${value.toFixed(2)}%`;
                                
                                // Agregar informaci√≥n adicional si est√° disponible
                                if (datosSupervisores[supervisor] && datosSupervisores[supervisor][mesCompleto]) {
                                    const datosMes = datosSupervisores[supervisor][mesCompleto];
                                    tooltipText += `\nAsesores: ${datosMes.cantidad_asesores}`;
                                    tooltipText += `\nMeta: S/ ${datosMes.meta_super.toFixed(0)}`;
                                    tooltipText += `\nCartera: ${datosMes.cartera}`;
                                }
                                
                                return tooltipText.split('\n');
                            }
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: { font: { size: 12 } },
                        onClick: function (e, legendItem, legend) {
                            const index = legendItem.datasetIndex;
                            const ci = legend.chart;
                            if (ci.isDatasetVisible(index)) {
                                ci.hide(index);
                            } else {
                                ci.show(index);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Porcentaje vs Meta Supervisor (%)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Meses'
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    
        // FORZAR REDIMENSIONADO despu√©s de crear la gr√°fica
        setTimeout(() => {
            if (chartInstanceSupervisores) {
                chartInstanceSupervisores.resize();
            }
        }, 100);
    }
    
    // ========== FUNCI√ìN PARA CAMBIAR TIPO DE GR√ÅFICA SUPERVISORES ==========
    function cambiarTipoGraficaSupervisores(tipo) {
            tipoGrafica = tipo;
            
            // Actualizar botones activos
            document.querySelectorAll('#graficaComparacionSupervisores .controles-grafica .btn-comparacion').forEach(btn => {
                btn.classList.remove('activo');
            });
            event.target.classList.add('activo');
            
            // Regenerar gr√°fica si hay datos
            if (supervisoresSeleccionados.size > 0 && chartInstanceSupervisores) {
                const mesesOrdenados = Object.keys(datosMeses).sort((a, b) => {
                    const [mesA, a√±oA] = a.split('_');
                    const [mesB, a√±oB] = b.split('_');
                    const fechaA = new Date(a√±oA, obtenerNumeroMes(mesA));
                    const fechaB = new Date(a√±oB, obtenerNumeroMes(mesB));
                    return fechaB - fechaA;
                });
                
                let mesesFiltrados = mesesOrdenados;
                if (mesesAMostrar > 0 && mesesFiltrados.length > mesesAMostrar) {
                    mesesFiltrados = mesesFiltrados.slice(0, mesesAMostrar);
                }
                
                const mesesParaGrafica = [...mesesFiltrados].reverse();
                generarGraficaDesempenioSupervisores(mesesParaGrafica, Array.from(supervisoresSeleccionados));
            }
    }

    // ========== VARIABLES PARA GR√ÅFICA DE ALCANCE POR EQUIPOS ==========
    let chartAlcanceEquipos = null;

    // ========== FUNCI√ìN CORREGIDA PARA GENERAR GR√ÅFICA DE ALCANCE POR EQUIPOS ==========
    function generarGraficaAlcanceEquipos() {
        const mesSeleccionado = document.getElementById('selectorMes').value;
        const a√±oSeleccionado = document.getElementById('selectorA√±o').value;
        const periodoCompleto = `${mesSeleccionado}_${a√±oSeleccionado}`;
        
        if (!datosSupervisores) {
            console.log("‚ùå NO HAY DATOS de supervisores");
            return;
        }
        
        // Obtener supervisores del mes actual
        const supervisores = Object.keys(datosSupervisores).filter(supervisor => 
            datosSupervisores[supervisor] && datosSupervisores[supervisor][periodoCompleto]
        );
        
        if (supervisores.length === 0) {
            console.log("‚ùå NO HAY SUPERVISORES para este mes");
            return;
        }
        
        // DEBUG: Verificar que tenemos datos diarios
        console.log("üîç Verificando datos diarios de supervisores para:", periodoCompleto);
        
        // OBTENER TODAS LAS FECHAS DISPONIBLES
        const todasFechas = new Set();
        
        supervisores.forEach(supervisor => {
            const datosMes = datosSupervisores[supervisor][periodoCompleto];
            const alcanceDiario = datosMes.alcance_acumulado_diario || {};
            
            // Agregar todas las fechas que tengan datos
            Object.keys(alcanceDiario).forEach(fecha => {
                if (alcanceDiario[fecha] !== undefined && alcanceDiario[fecha] !== null) {
                    todasFechas.add(fecha);
                }
            });
        });
        
        // Si no hay datos diarios
        if (todasFechas.size === 0) {
            console.log("‚ö†Ô∏è No hay datos diarios de alcance acumulado para ning√∫n supervisor");
            alert(`No se encontraron datos diarios de alcance para los supervisores en ${mesSeleccionado} ${a√±oSeleccionado}.`);
            return;
        }
        
        // Ordenar fechas cronol√≥gicamente
        const fechasOrdenadas = Array.from(todasFechas).sort((a, b) => {
            return convertirFechaDiaria(a) - convertirFechaDiaria(b);
        });
        
        console.log("üìä Fechas ordenadas para gr√°fica:", fechasOrdenadas);
        
        // Preparar datasets para cada supervisor
        const datasets = [];
        const colores = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
            '#9966FF', '#FF9F40', '#8AC926', '#1982C4',
            '#6A0572', '#AB83A1', '#3C91E6', '#A2D729'
        ];
        
        // Solo incluir supervisores que tengan datos diarios
        supervisores.forEach((supervisor, index) => {
            const datosMes = datosSupervisores[supervisor][periodoCompleto];
            const alcanceDiario = datosMes.alcance_acumulado_diario || {};
            
            // Crear array de datos para cada fecha
            const datosAlcance = fechasOrdenadas.map(fecha => {
                return alcanceDiario[fecha] !== undefined ? alcanceDiario[fecha] : null;
            });
            
            // Verificar que haya al menos algunos datos
            const tieneDatos = datosAlcance.some(valor => valor !== null);
            
            if (tieneDatos) {
                const color = colores[index % colores.length];
                
                datasets.push({
                    label: supervisor,
                    data: datosAlcance,
                    borderColor: color,
                    backgroundColor: color + '20',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 10,
                    pointBackgroundColor: color,
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    spanGaps: true
                });
                
                console.log(`‚úÖ Supervisor ${supervisor} agregado con ${datosAlcance.filter(v => v !== null).length} datos`);
            } else {
                console.log(`‚ö†Ô∏è Supervisor ${supervisor} no tiene datos diarios`);
            }
        });
        
        // Si ning√∫n supervisor tiene datos
        if (datasets.length === 0) {
            alert(`Ning√∫n supervisor tiene datos diarios de alcance para ${mesSeleccionado} ${a√±oSeleccionado}.`);
            return;
        }
        
        // Agregar l√≠nea de meta (100%)
        datasets.push({
            label: 'Meta 100%',
            data: Array(fechasOrdenadas.length).fill(100),
            borderColor: '#2ecc71',
            backgroundColor: 'transparent',
            borderWidth: 2,
            borderDash: [5, 5],
            fill: false,
            tension: 0,
            pointRadius: 0,
            order: 999
        });
        
        const canvas = document.getElementById('graficaAlcanceEquipos');
        const ctx = canvas.getContext('2d');
        
        // Destruir gr√°fica anterior si existe
        if (chartAlcanceEquipos) {
            chartAlcanceEquipos.destroy();
            chartAlcanceEquipos = null;
        }
        
        // NUEVO: T√≠tulo din√°mico seg√∫n el mes seleccionado
        const tituloGrafica = `üìà Evoluci√≥n Diaria del Alcance por Equipo - ${mesSeleccionado} ${a√±oSeleccionado}`;
        
        // Crear la gr√°fica
        chartAlcanceEquipos = new Chart(ctx, {
            type: 'line',
            data: {
                labels: fechasOrdenadas,
                datasets: datasets
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    title: {
                        display: true,
                        text: tituloGrafica,  // NUEVO: T√≠tulo din√°mico
                        font: { size: 16, weight: 'bold' }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 13 },
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                const datasetLabel = context.dataset.label || '';
                                const value = context.parsed.y;
                                
                                if (datasetLabel === 'Meta 100%') {
                                    return 'Meta: 100%';
                                }
                                
                                return `${datasetLabel}: ${value !== null ? value.toFixed(1) + '%' : 'Sin datos'}`;
                            }
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            font: { size: 12 },
                            usePointStyle: true,
                            boxWidth: 12,
                            padding: 20
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'D√≠as del Mes',
                            font: { size: 14, weight: 'bold' }
                        },
                        ticks: {
                            font: { size: 12 },
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: '% Alcance Acumulado',
                            font: { size: 14, weight: 'bold' }
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            },
                            font: { size: 12 }
                        },
                        min: 0,
                        suggestedMax: 120
                    }
                }
            }
        });
        
        console.log("‚úÖ Gr√°fica de alcance por equipos generada exitosamente");
    }
    
    // Funci√≥n auxiliar para convertir fechas como "3-Nov" a orden num√©rico
    function convertirFechaDiaria(fechaStr) {
        try {
            // Separar d√≠a y mes abreviado
            const partes = fechaStr.split('-');
            if (partes.length === 2) {
                const dia = parseInt(partes[0]);
                const mesAbrev = partes[1].toUpperCase();
                
                // Mapear meses abreviados
                const meses = {
                    'ENE': 1, 'FEB': 2, 'MAR': 3, 'ABR': 4, 'MAY': 5, 'JUN': 6,
                    'JUL': 7, 'AGO': 8, 'SEP': 9, 'OCT': 10, 'NOV': 11, 'DIC': 12
                };
                
                // Buscar coincidencia
                for (const [mesKey, mesNum] of Object.entries(meses)) {
                    if (mesAbrev.startsWith(mesKey)) {
                        return mesNum * 100 + dia;
                    }
                }
            }
            return 0;
        } catch (e) {
            console.error("Error convirtiendo fecha:", fechaStr, e);
            return 0;
        }
    }

    // ========== FUNCI√ìN MODIFICADA PARA EXPORTAR SIN TABLA ==========
    async function exportarTablaDetalleExcelAvanzado() {
        const mesSeleccionado = document.getElementById('selectorMes').value;
        const a√±oSeleccionado = document.getElementById('selectorA√±o').value;
        const periodoCompleto = `${mesSeleccionado}_${a√±oSeleccionado}`;
        
        if (!datosMeses[periodoCompleto]) {
            alert('No hay datos para exportar');
            return;
        }
    
        const fechaHoy = new Date();
        const a√±o = fechaHoy.getFullYear();
        const mes = String(fechaHoy.getMonth() + 1).padStart(2, '0');
        const dia = String(fechaHoy.getDate()).padStart(2, '0');
        const fechaFormato = `${a√±o}${mes}${dia}`;
        
        // NUEVO: Incluir el mes filtrado en el nombre del archivo
        const nombreArchivo = `Recupero y alcance por asesor declarado_${mesSeleccionado}_${fechaFormato}.xlsx`;
        
        // Obtener datos del periodo
        const asesores = datosMeses[periodoCompleto] || [];
        
        // Obtener todas las fechas √∫nicas de los datos diarios
        const todasFechas = new Set();
        asesores.forEach(asesor => {
            Object.keys(asesor.datos_diarios || {}).forEach(fecha => {
                todasFechas.add(fecha);
            });
        });
        
        // Ordenar fechas
        let fechasOrdenadas = Array.from(todasFechas).sort((a, b) => {
            return new Date(a.split('-').reverse().join('-')) - new Date(b.split('-').reverse().join('-'));
        });
        
        // Crear workbook con ExcelJS
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('Detalle Diario');
        
        // ========== CONSTRUIR LOS DATOS ==========
        const datosDetalle = [];
        const encabezados = ['EQUIPO', 'ASESOR'];
        
        // Agregar columnas de fechas
        fechasOrdenadas.forEach(fecha => {
            encabezados.push(fecha);
        });
        
        // Cambiar nombre de encabezado por "TOTAL R"
        encabezados.push('TOTAL R', '% ALCANCE');
        
        // Datos de asesores
        asesores.forEach(asesor => {
            const filaDatos = [];
            
            // Equipo y Asesor
            filaDatos.push(asesor.supervisor || 'Sin Supervisor');
            filaDatos.push(asesor.nombre);
            
            // Datos diarios
            fechasOrdenadas.forEach(fecha => {
                const valor = asesor.datos_diarios ? (asesor.datos_diarios[fecha] || 0) : 0;
                filaDatos.push(valor);
            });
            
            // Recupero total y % Alcance
            filaDatos.push(asesor.recupero || 0);
            filaDatos.push(asesor.porcentaje || 0);
            
            datosDetalle.push(filaDatos);
        });
        
        // ========== APLICAR FORMATOS PROFESIONALES ==========
        
        // 1. ENCABEZADOS
        const headerRow = worksheet.addRow(encabezados);
        headerRow.font = {
            name: 'Aptos Narrow',
            size: 12,
            bold: true,
            color: { argb: 'FFFFFFFF' }
        };
        headerRow.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FF2C3E50' }
        };
        headerRow.alignment = { horizontal: 'center', vertical: 'middle' };
        headerRow.border = {
            top: { style: 'thin', color: { argb: 'FFFFFFFF' } },
            bottom: { style: 'thin', color: { argb: 'FFFFFFFF' } },
            left: { style: 'thin', color: { argb: 'FFFFFFFF' } },
            right: { style: 'thin', color: { argb: 'FFFFFFFF' } }
        };
        
        // 2. DATOS DE ASESORES
        datosDetalle.forEach((fila, rowIndex) => {
            const dataRow = worksheet.addRow(fila);
            
            // Aplicar formatos por columna
            dataRow.eachCell((cell, colNumber) => {
                cell.font = { 
                    name: 'Aptos Narrow',
                    size: 10 
                };
                cell.border = {
                    top: { style: 'thin', color: { argb: 'FFD0D0D0' } },
                    bottom: { style: 'thin', color: { argb: 'FFD0D0D0' } },
                    left: { style: 'thin', color: { argb: 'FFD0D0D0' } },
                    right: { style: 'thin', color: { argb: 'FFD0D0D0' } }
                };
                
                // Formato para EQUIPO (columna 1)
                if (colNumber === 1) {
                    cell.font = { 
                        name: 'Aptos Narrow', 
                        size: 10, 
                        bold: true 
                    };
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFE8F4FD' }
                    };
                    cell.alignment = { horizontal: 'left' };
                }
                // Formato para ASESOR (columna 2)
                else if (colNumber === 2) {
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFFFFF' }
                    };
                    cell.alignment = { horizontal: 'left' };
                }
                // Formato para D√çAS (columnas 3 a n-2) 
                else if (colNumber > 2 && colNumber <= encabezados.length - 2) {
                    cell.alignment = { horizontal: 'right' };
                    cell.numFmt = '#,##0.00';
                    cell.font = { 
                        name: 'Aptos Narrow', 
                        size: 10,
                        color: { argb: 'FF000000' }
                    };
                    
                    // Nuevos colores condicionales para valores diarios
                    const valor = cell.value;
                    if (valor > 7000) {
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FF99E7BA' }  // >7000
                        };
                    } else if (valor > 1000) {
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFD5F5E3' }  // >1000
                        };
                    } else if (valor > 0) {
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFFFFFFF' }  // >0
                        };
                    } else {
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFFDEDEC' }  // =0
                        };
                    }
                }
                // Formato para TOTAL R (pen√∫ltima columna)
                else if (colNumber === encabezados.length - 1) {
                    cell.font = { 
                        name: 'Aptos Narrow', 
                        size: 11,
                        bold: true 
                    };
                    cell.alignment = { horizontal: 'right' };
                    cell.numFmt = '#,##0.00';
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFE8F4FD' }
                    };
                    cell.border.left = { style: 'medium', color: { argb: 'FF3498DB' } };
                }
                // Formato para % ALCANCE (√∫ltima columna)
                else if (colNumber === encabezados.length) {
                    const fontConfig = {
                        name: 'Aptos Narrow',
                        size: 12,
                        bold: true,
                        color: { argb: 'FF000000' }
                    };
                    
                    cell.font = fontConfig;
                    cell.alignment = { horizontal: 'center' };
                    cell.numFmt = '0.0"%";';
                    cell.border.right = { style: 'medium', color: { argb: 'FFF39C12' } };
                    
                    // Nuevos colores seg√∫n porcentaje (SOLO EL FONDO)
                    const valor = cell.value;
                    if (valor >= 100) {
                        cell.fill = { 
                            type: 'pattern', 
                            pattern: 'solid', 
                            fgColor: { argb: 'FF99E7BA' }
                        };
                    } else if (valor >= 70) {
                        cell.fill = { 
                            type: 'pattern', 
                            pattern: 'solid', 
                            fgColor: { argb: 'FFFCF3CF' } 
                        };
                    } else if (valor >= 40) {
                        cell.fill = { 
                            type: 'pattern', 
                            pattern: 'solid', 
                            fgColor: { argb: 'FFFAE5D3' } 
                        };
                    } else {
                        cell.fill = { 
                            type: 'pattern', 
                            pattern: 'solid', 
                            fgColor: { argb: 'FFFADBD8' } 
                        };
                    }
                }
            });
        });
        
        // 3. TOTALES CON SUMAS POR D√çA
        worksheet.addRow([]);
        const totalesFila = ['TOTALES', ''];
        
        // Calcular totales por d√≠a
        for (let col = 2; col < encabezados.length - 2; col++) {
            let totalDia = 0;
            datosDetalle.forEach(fila => {
                totalDia += fila[col] || 0;
            });
            totalesFila.push(totalDia);
        }
        
        // Calcular total recupero
        let totalRecupero = 0;
        datosDetalle.forEach(fila => {
            totalRecupero += fila[fila.length - 2] || 0;
        });
        
        totalesFila.push(totalRecupero);
        
        const totalRow = worksheet.addRow(totalesFila);
        totalRow.eachCell((cell, colNumber) => {
            cell.font = { 
                name: 'Aptos Narrow', 
                size: 11,
                bold: true, 
                color: { argb: 'FF000000' }
            };
            cell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FFD6DBDF' }
            };
            cell.border = {
                top: { style: 'thin', color: { argb: 'FF2C3E50' } },
                bottom: { style: 'thin', color: { argb: 'FF2C3E50' } }
            };
            
            if (colNumber > 2 && colNumber <= encabezados.length - 2) {
                cell.numFmt = '#,##0.00';
            } else if (colNumber === encabezados.length - 1) {
                cell.numFmt = '#,##0.00';
            } else if (colNumber === encabezados.length) {
                cell.numFmt = '0.0"%";';
            }
        });
        
        // ========== AJUSTAR ANCHOS DE COLUMNA ==========
        worksheet.columns = [
            { width: 12 }, // Equipo
            { width: 30 }, // Asesor
            ...Array(fechasOrdenadas.length).fill({ width: 12 }), // D√≠as
            { width: 23 }, // TOTAL R
            { width: 15 }  // % Alcance
        ];
        
        // Congelar paneles
        worksheet.views = [
            { state: 'frozen', xSplit: 2, ySplit: 1, activeCell: 'C2' }
        ];
        
        // ========== GUARDAR ARCHIVO ==========
        try {
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            saveAs(blob, nombreArchivo);
            
            console.log('Excel con formato exportado exitosamente');
            alert('‚úÖ Archivo Excel exportado exitosamente: ' + nombreArchivo);
        } catch (error) {
            console.error('Error al exportar:', error);
            alert('‚ùå Error al exportar el archivo. Verifica la consola para m√°s detalles.');
        }
    }

    // Variables para el gr√°fico de tendencia
    let chartTendencia = null;
    let vistaGraficaActual = 'completa';
    
    // Funci√≥n para cambiar entre vistas del gr√°fico
    function cambiarVistaGrafica(vista) {
        vistaGraficaActual = vista;
        
        // Actualizar botones activos
        document.querySelectorAll('.controles-grafica-tendencia .btn-comparacion').forEach(btn => {
            btn.classList.remove('activo');
        });
        event.target.classList.add('activo');
        
        // Regenerar gr√°fica si hay datos
        const mesSeleccionado = document.getElementById('selectorMes').value;
        const a√±oSeleccionado = document.getElementById('selectorA√±o').value;
        const periodoCompleto = `${mesSeleccionado}_${a√±oSeleccionado}`;
        
        if (datosMeses[periodoCompleto]) {
            const asesores = datosMeses[periodoCompleto] || [];
            const todasFechas = new Set();
            asesores.forEach(asesor => {
                Object.keys(asesor.datos_diarios || {}).forEach(fecha => {
                    todasFechas.add(fecha);
                });
            });
            const fechasOrdenadas = Array.from(todasFechas).sort((a, b) => {
                return new Date(a.split('-').reverse().join('-')) - new Date(b.split('-').reverse().join('-'));
            });
            
            generarGraficaTendenciaDiaria(asesores, fechasOrdenadas);
        }
    }
    
    // Funci√≥n para generar el gr√°fico de tendencia diaria
    function generarGraficaTendenciaDiaria(asesores, fechasOrdenadas) {
        const canvas = document.getElementById('graficaTendenciaDiaria');
        const ctx = canvas.getContext('2d');
        
        // Destruir gr√°fica anterior si existe
        if (chartTendencia) {
            chartTendencia.destroy();
            chartTendencia = null;
        }
        
        // Calcular acumulado diario de RECUPERO
        const acumuladoRecuperoDiario = [];
        let acumuladoRecuperoTotal = 0;
        
        // Calcular META ACUMULADA (suma de metas de supervisores √∫nicos)
        const supervisoresUnicos = [...new Set(asesores.map(a => a.supervisor))];
        let metaTotal = 0;
        
        supervisoresUnicos.forEach(supervisor => {
            const primerAsesor = asesores.find(a => a.supervisor === supervisor);
            if (primerAsesor && primerAsesor.meta_super) {
                metaTotal += primerAsesor.meta_super;
            }
        });
        
        // Si no hay metas de supervisor, usar suma de metas individuales
        if (metaTotal === 0) {
            metaTotal = asesores.reduce((sum, asesor) => sum + (asesor.meta || 0), 0);
        }
        
        // Calcular datos diarios (sin acumular)
        const datosDiarios = fechasOrdenadas.map(fecha => {
            let totalDia = 0;
            asesores.forEach(asesor => {
                const valor = asesor.datos_diarios ? (asesor.datos_diarios[fecha] || 0) : 0;
                totalDia += valor;
            });
            return totalDia;
        });
        
        // Calcular ACUMULADO de recupero y ALCANCE ACUMULADO
        const acumuladoRecupero = [];
        const alcanceAcumulado = []; // NUEVO: Alcance acumulado en porcentaje
        let recuperoAcumuladoTotal = 0;
        
        fechasOrdenadas.forEach(fecha => {
            let totalDia = 0;
            asesores.forEach(asesor => {
                const valor = asesor.datos_diarios ? (asesor.datos_diarios[fecha] || 0) : 0;
                totalDia += valor;
            });
            recuperoAcumuladoTotal += totalDia;
            acumuladoRecupero.push(recuperoAcumuladoTotal);
            
            // Calcular alcance acumulado como porcentaje
            const alcance = metaTotal > 0 ? (recuperoAcumuladoTotal / metaTotal) * 100 : 0;
            alcanceAcumulado.push(alcance);
        });
        
        // Preparar datasets seg√∫n la vista seleccionada
        const datasets = [];
        
        if (vistaGraficaActual === 'completa' || vistaGraficaActual === 'acumulado') {
            // NUEVO: En vista completa mostramos ALCANCE ACUMULADO, no recupero acumulado
            if (vistaGraficaActual === 'completa') {
                datasets.push({
                    label: 'üéØ Alcance Acumulado',
                    data: alcanceAcumulado,
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    borderWidth: 4,
                    fill: false,
                    tension: 0.4,
                    yAxisID: 'y',
                    pointStyle: 'circle',
                    pointRadius: 4,
                    pointHoverRadius: 8
                });
            } else {
                // En vista "solo acumulado" mostramos recupero acumulado
                datasets.push({
                    label: 'üìà Recupero Acumulado',
                    data: acumuladoRecupero,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    borderWidth: 4,
                    fill: vistaGraficaActual === 'acumulado',
                    tension: 0.4,
                    yAxisID: 'y'
                });
            }
        }
        
        if (vistaGraficaActual === 'completa' || vistaGraficaActual === 'diario') {
            datasets.push({
                label: 'üí∞ Recupero Diario',
                data: datosDiarios,
                borderColor: '#2ecc71',
                backgroundColor: vistaGraficaActual === 'diario' ? 
                    'rgba(46, 204, 113, 0.6)' : 'rgba(46, 204, 113, 0.3)',
                borderWidth: vistaGraficaActual === 'diario' ? 2 : 0,
                fill: false,
                tension: 0.4,
                yAxisID: vistaGraficaActual === 'completa' ? 'y1' : 'y',
                type: 'bar',
                borderRadius: vistaGraficaActual === 'diario' ? 8 : 4,
                borderSkipped: false
            });
        }
        
        // NUEVO: En vista completa, tambi√©n mostrar recupero acumulado como l√≠nea punteada
        if (vistaGraficaActual === 'completa') {
            datasets.push({
                label: 'üìà Recupero Acumulado',
                data: acumuladoRecupero,
                borderColor: '#3498db',
                backgroundColor: 'transparent',
                borderWidth: 2,
                borderDash: [5, 5],
                fill: false,
                tension: 0.4,
                yAxisID: 'y1',
                pointRadius: 0,
                pointHoverRadius: 0
            });
        }
        
        // Crear la gr√°fica
        chartTendencia = new Chart(ctx, {
            type: 'line',
            data: {
                labels: fechasOrdenadas,
                datasets: datasets
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    title: {
                        display: true,
                        text: getTituloGrafica(),
                        font: { size: 18, weight: 'bold' }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 13 },
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                
                                const value = context.parsed.y;
                                
                                // Formatear seg√∫n el tipo de dato
                                if (context.dataset.label.includes('Alcance')) {
                                    label += value.toFixed(1) + '%';
                                } else if (context.dataset.label.includes('Recupero')) {
                                    label += 'S/ ' + value.toLocaleString('es-PE', { 
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2 
                                    });
                                }
                                
                                return label;
                            },
                            // NUEVO: Agregar footer con informaci√≥n adicional en vista completa
                            afterBody: function(context) {
                                if (vistaGraficaActual === 'completa') {
                                    const index = context[0].dataIndex;
                                    const recuperoAcum = acumuladoRecupero[index];
                                    const alcance = alcanceAcumulado[index];
                                    const recuperoDia = datosDiarios[index];
                                    
                                    return [
                                        '---',
                                        `Alcance Acumulado: ${alcance.toFixed(1)}%`,
                                        `Recupero Acumulado: S/ ${recuperoAcum.toLocaleString('es-PE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`,
                                        `Recupero Diario: S/ ${recuperoDia.toLocaleString('es-PE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                                    ];
                                }
                                return [];
                            }
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: { font: { size: 12, weight: 'bold' } }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'D√≠as del Mes',
                            font: { size: 14, weight: 'bold' }
                        },
                        ticks: {
                            font: { size: 12 },
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: getTituloEjeY(),
                            font: { size: 14, weight: 'bold' }
                        },
                        ticks: {
                            callback: function(value) {
                                if (vistaGraficaActual === 'completa') {
                                    return value.toFixed(1) + '%'; // Para alcance acumulado
                                } else {
                                    return 'S/ ' + value.toLocaleString('es-PE');
                                }
                            },
                            font: { size: 12 }
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: vistaGraficaActual === 'completa',
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Recupero (S/)',
                            font: { size: 14, weight: 'bold' }
                        },
                        ticks: {
                            callback: function(value) {
                                return 'S/ ' + value.toLocaleString('es-PE');
                            },
                            font: { size: 12 }
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });
    }
    
    // Funci√≥n para obtener t√≠tulo din√°mico del gr√°fico
    function getTituloGrafica() {
        switch(vistaGraficaActual) {
            case 'completa':
                return 'üìä Vista Completa - Alcance vs Recupero';
            case 'diario':
                return 'üìÖ Recupero Diario - Desempe√±o por D√≠a';
            case 'acumulado':
                return 'üìà Recupero Acumulado - Progreso del Mes';
            default:
                return 'Evoluci√≥n del Recupero';
        }
    }
    
    // Funci√≥n para obtener t√≠tulo din√°mico del eje Y
    function getTituloEjeY() {
        switch(vistaGraficaActual) {
            case 'completa':
                return 'Alcance Acumulado (%)';  // Cambiado de "Recupero Acumulado"
            case 'diario':
                return 'Recupero Diario (S/)';
            case 'acumulado':
                return 'Recupero Acumulado (S/)';
            default:
                return 'Recupero (S/)';
        }
    }
    
    // CORRECCI√ìN: Inicializar cuando la p√°gina cargue
    document.addEventListener('DOMContentLoaded', function() {
        console.log("P√°gina cargada, inicializando...");
        
        if (inicializarDatos()) {
            // Llamar a actualizarPeriodo para mostrar datos iniciales
            setTimeout(() => {
                actualizarPeriodo();
            }, 100);
        } else {
            console.error("No se pudieron cargar los datos");
        }
    });

</script>
</body>
</html>